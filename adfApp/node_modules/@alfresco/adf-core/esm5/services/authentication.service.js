/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
/*!
 * @license
 * Copyright 2016 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { Observable, Subject, from, throwError } from 'rxjs';
import { AlfrescoApiService } from './alfresco-api.service';
import { CookieService } from './cookie.service';
import { LogService } from './log.service';
import { AppConfigService, AppConfigValues } from '../app-config/app-config.service';
import { map, catchError, tap } from 'rxjs/operators';
import { HttpHeaders } from '@angular/common/http';
/** @type {?} */
var REMEMBER_ME_COOKIE_KEY = 'ALFRESCO_REMEMBER_ME';
/** @type {?} */
var REMEMBER_ME_UNTIL = 1000 * 60 * 60 * 24 * 30;
var AuthenticationService = /** @class */ (function () {
    function AuthenticationService(appConfig, alfrescoApi, cookie, logService) {
        this.appConfig = appConfig;
        this.alfrescoApi = alfrescoApi;
        this.cookie = cookie;
        this.logService = logService;
        this.redirectUrl = null;
        this.bearerExcludedUrls = ['auth/realms', 'resources/', 'assets/'];
        this.onLogin = new Subject();
        this.onLogout = new Subject();
    }
    /**
     * Checks if the user logged in.
     * @returns True if logged in, false otherwise
     */
    /**
     * Checks if the user logged in.
     * @return {?} True if logged in, false otherwise
     */
    AuthenticationService.prototype.isLoggedIn = /**
     * Checks if the user logged in.
     * @return {?} True if logged in, false otherwise
     */
    function () {
        if (!this.isOauth() && this.cookie.isEnabled() && !this.isRememberMeSet()) {
            return false;
        }
        return this.alfrescoApi.getInstance().isLoggedIn();
    };
    /**
     * Does the provider support OAuth?
     * @returns True if supported, false otherwise
     */
    /**
     * Does the provider support OAuth?
     * @return {?} True if supported, false otherwise
     */
    AuthenticationService.prototype.isOauth = /**
     * Does the provider support OAuth?
     * @return {?} True if supported, false otherwise
     */
    function () {
        return this.alfrescoApi.getInstance().isOauthConfiguration();
    };
    /**
     * Does the provider support ECM?
     * @returns True if supported, false otherwise
     */
    /**
     * Does the provider support ECM?
     * @return {?} True if supported, false otherwise
     */
    AuthenticationService.prototype.isECMProvider = /**
     * Does the provider support ECM?
     * @return {?} True if supported, false otherwise
     */
    function () {
        return this.alfrescoApi.getInstance().isEcmConfiguration();
    };
    /**
     * Does the provider support BPM?
     * @returns True if supported, false otherwise
     */
    /**
     * Does the provider support BPM?
     * @return {?} True if supported, false otherwise
     */
    AuthenticationService.prototype.isBPMProvider = /**
     * Does the provider support BPM?
     * @return {?} True if supported, false otherwise
     */
    function () {
        return this.alfrescoApi.getInstance().isBpmConfiguration();
    };
    /**
     * Does the provider support both ECM and BPM?
     * @returns True if both are supported, false otherwise
     */
    /**
     * Does the provider support both ECM and BPM?
     * @return {?} True if both are supported, false otherwise
     */
    AuthenticationService.prototype.isALLProvider = /**
     * Does the provider support both ECM and BPM?
     * @return {?} True if both are supported, false otherwise
     */
    function () {
        return this.alfrescoApi.getInstance().isEcmBpmConfiguration();
    };
    /**
     * Logs the user in.
     * @param username Username for the login
     * @param password Password for the login
     * @param rememberMe Stores the user's login details if true
     * @returns Object with auth type ("ECM", "BPM" or "ALL") and auth ticket
     */
    /**
     * Logs the user in.
     * @param {?} username Username for the login
     * @param {?} password Password for the login
     * @param {?=} rememberMe Stores the user's login details if true
     * @return {?} Object with auth type ("ECM", "BPM" or "ALL") and auth ticket
     */
    AuthenticationService.prototype.login = /**
     * Logs the user in.
     * @param {?} username Username for the login
     * @param {?} password Password for the login
     * @param {?=} rememberMe Stores the user's login details if true
     * @return {?} Object with auth type ("ECM", "BPM" or "ALL") and auth ticket
     */
    function (username, password, rememberMe) {
        var _this = this;
        if (rememberMe === void 0) { rememberMe = false; }
        return from(this.alfrescoApi.getInstance().login(username, password))
            .pipe(map(function (response) {
            _this.saveRememberMeCookie(rememberMe);
            _this.onLogin.next(response);
            return {
                type: _this.appConfig.get(AppConfigValues.PROVIDERS),
                ticket: response
            };
        }), catchError(function (err) { return _this.handleError(err); }));
    };
    /**
     * Logs the user in with SSO
     */
    /**
     * Logs the user in with SSO
     * @return {?}
     */
    AuthenticationService.prototype.ssoImplicitLogin = /**
     * Logs the user in with SSO
     * @return {?}
     */
    function () {
        this.alfrescoApi.getInstance().implicitLogin();
    };
    /**
     * Saves the "remember me" cookie as either a long-life cookie or a session cookie.
     * @param {?} rememberMe Enables a long-life cookie
     * @return {?}
     */
    AuthenticationService.prototype.saveRememberMeCookie = /**
     * Saves the "remember me" cookie as either a long-life cookie or a session cookie.
     * @param {?} rememberMe Enables a long-life cookie
     * @return {?}
     */
    function (rememberMe) {
        /** @type {?} */
        var expiration = null;
        if (rememberMe) {
            expiration = new Date();
            /** @type {?} */
            var time = expiration.getTime();
            /** @type {?} */
            var expireTime = time + REMEMBER_ME_UNTIL;
            expiration.setTime(expireTime);
        }
        this.cookie.setItem(REMEMBER_ME_COOKIE_KEY, '1', expiration, null);
    };
    /**
     * Checks whether the "remember me" cookie was set or not.
     * @returns True if set, false otherwise
     */
    /**
     * Checks whether the "remember me" cookie was set or not.
     * @return {?} True if set, false otherwise
     */
    AuthenticationService.prototype.isRememberMeSet = /**
     * Checks whether the "remember me" cookie was set or not.
     * @return {?} True if set, false otherwise
     */
    function () {
        return (this.cookie.getItem(REMEMBER_ME_COOKIE_KEY) === null) ? false : true;
    };
    /**
     * Logs the user out.
     * @returns Response event called when logout is complete
     */
    /**
     * Logs the user out.
     * @return {?} Response event called when logout is complete
     */
    AuthenticationService.prototype.logout = /**
     * Logs the user out.
     * @return {?} Response event called when logout is complete
     */
    function () {
        var _this = this;
        return from(this.callApiLogout())
            .pipe(tap(function (response) {
            _this.onLogout.next(response);
            return response;
        }), catchError(function (err) { return _this.handleError(err); }));
    };
    /**
     * @return {?}
     */
    AuthenticationService.prototype.callApiLogout = /**
     * @return {?}
     */
    function () {
        if (this.alfrescoApi.getInstance()) {
            return this.alfrescoApi.getInstance().logout();
        }
    };
    /**
     * Gets the ECM ticket stored in the Storage.
     * @returns The ticket or `null` if none was found
     */
    /**
     * Gets the ECM ticket stored in the Storage.
     * @return {?} The ticket or `null` if none was found
     */
    AuthenticationService.prototype.getTicketEcm = /**
     * Gets the ECM ticket stored in the Storage.
     * @return {?} The ticket or `null` if none was found
     */
    function () {
        return this.alfrescoApi.getInstance().getTicketEcm();
    };
    /**
     * Gets the BPM ticket stored in the Storage.
     * @returns The ticket or `null` if none was found
     */
    /**
     * Gets the BPM ticket stored in the Storage.
     * @return {?} The ticket or `null` if none was found
     */
    AuthenticationService.prototype.getTicketBpm = /**
     * Gets the BPM ticket stored in the Storage.
     * @return {?} The ticket or `null` if none was found
     */
    function () {
        return this.alfrescoApi.getInstance().getTicketBpm();
    };
    /**
     * Gets the BPM ticket from the Storage in Base 64 format.
     * @returns The ticket or `null` if none was found
     */
    /**
     * Gets the BPM ticket from the Storage in Base 64 format.
     * @return {?} The ticket or `null` if none was found
     */
    AuthenticationService.prototype.getTicketEcmBase64 = /**
     * Gets the BPM ticket from the Storage in Base 64 format.
     * @return {?} The ticket or `null` if none was found
     */
    function () {
        /** @type {?} */
        var ticket = this.alfrescoApi.getInstance().getTicketEcm();
        if (ticket) {
            return 'Basic ' + btoa(ticket);
        }
        return null;
    };
    /**
     * Checks if the user is logged in on an ECM provider.
     * @returns True if logged in, false otherwise
     */
    /**
     * Checks if the user is logged in on an ECM provider.
     * @return {?} True if logged in, false otherwise
     */
    AuthenticationService.prototype.isEcmLoggedIn = /**
     * Checks if the user is logged in on an ECM provider.
     * @return {?} True if logged in, false otherwise
     */
    function () {
        if (this.isECMProvider() || this.isALLProvider()) {
            if (!this.isOauth() && this.cookie.isEnabled() && !this.isRememberMeSet()) {
                return false;
            }
            return this.alfrescoApi.getInstance().isEcmLoggedIn();
        }
        return false;
    };
    /**
     * Checks if the user is logged in on a BPM provider.
     * @returns True if logged in, false otherwise
     */
    /**
     * Checks if the user is logged in on a BPM provider.
     * @return {?} True if logged in, false otherwise
     */
    AuthenticationService.prototype.isBpmLoggedIn = /**
     * Checks if the user is logged in on a BPM provider.
     * @return {?} True if logged in, false otherwise
     */
    function () {
        if (this.isBPMProvider() || this.isALLProvider()) {
            if (!this.isOauth() && this.cookie.isEnabled() && !this.isRememberMeSet()) {
                return false;
            }
            return this.alfrescoApi.getInstance().isBpmLoggedIn();
        }
        return false;
    };
    /**
     * Gets the ECM username.
     * @returns The ECM username
     */
    /**
     * Gets the ECM username.
     * @return {?} The ECM username
     */
    AuthenticationService.prototype.getEcmUsername = /**
     * Gets the ECM username.
     * @return {?} The ECM username
     */
    function () {
        return this.alfrescoApi.getInstance().getEcmUsername();
    };
    /**
     * Gets the BPM username
     * @returns The BPM username
     */
    /**
     * Gets the BPM username
     * @return {?} The BPM username
     */
    AuthenticationService.prototype.getBpmUsername = /**
     * Gets the BPM username
     * @return {?} The BPM username
     */
    function () {
        return this.alfrescoApi.getInstance().getBpmUsername();
    };
    /** Sets the URL to redirect to after login.
     * @param url URL to redirect to
     */
    /**
     * Sets the URL to redirect to after login.
     * @param {?} url URL to redirect to
     * @return {?}
     */
    AuthenticationService.prototype.setRedirect = /**
     * Sets the URL to redirect to after login.
     * @param {?} url URL to redirect to
     * @return {?}
     */
    function (url) {
        this.redirectUrl = url;
    };
    /** Gets the URL to redirect to after login.
     * @param provider Service provider. Can be "ECM", "BPM" or "ALL".
     * @returns The redirect URL
     */
    /**
     * Gets the URL to redirect to after login.
     * @param {?} provider Service provider. Can be "ECM", "BPM" or "ALL".
     * @return {?} The redirect URL
     */
    AuthenticationService.prototype.getRedirect = /**
     * Gets the URL to redirect to after login.
     * @param {?} provider Service provider. Can be "ECM", "BPM" or "ALL".
     * @return {?} The redirect URL
     */
    function (provider) {
        return this.hasValidRedirection(provider) ? this.redirectUrl.url : null;
    };
    /**
     * Gets information about the user currently logged into APS.
     * @returns User information
     */
    /**
     * Gets information about the user currently logged into APS.
     * @return {?} User information
     */
    AuthenticationService.prototype.getBpmLoggedUser = /**
     * Gets information about the user currently logged into APS.
     * @return {?} User information
     */
    function () {
        return from(this.alfrescoApi.getInstance().activiti.profileApi.getProfile());
    };
    /**
     * @param {?} provider
     * @return {?}
     */
    AuthenticationService.prototype.hasValidRedirection = /**
     * @param {?} provider
     * @return {?}
     */
    function (provider) {
        return this.redirectUrl && (this.redirectUrl.provider === provider || this.hasSelectedProviderAll(provider));
    };
    /**
     * @param {?} provider
     * @return {?}
     */
    AuthenticationService.prototype.hasSelectedProviderAll = /**
     * @param {?} provider
     * @return {?}
     */
    function (provider) {
        return this.redirectUrl && (this.redirectUrl.provider === 'ALL' || provider === 'ALL');
    };
    /**
     * Prints an error message in the console browser
     * @param error Error message
     * @returns Object representing the error message
     */
    /**
     * Prints an error message in the console browser
     * @param {?} error Error message
     * @return {?} Object representing the error message
     */
    AuthenticationService.prototype.handleError = /**
     * Prints an error message in the console browser
     * @param {?} error Error message
     * @return {?} Object representing the error message
     */
    function (error) {
        this.logService.error('Error when logging in', error);
        return throwError(error || 'Server error');
    };
    /**
     * @return {?}
     */
    AuthenticationService.prototype.getBearerExcludedUrls = /**
     * @return {?}
     */
    function () {
        return this.bearerExcludedUrls;
    };
    /**
     * @return {?}
     */
    AuthenticationService.prototype.getToken = /**
     * @return {?}
     */
    function () {
        return localStorage.getItem('access_token');
    };
    /**
     * @param {?=} headersArg
     * @return {?}
     */
    AuthenticationService.prototype.addTokenToHeader = /**
     * @param {?=} headersArg
     * @return {?}
     */
    function (headersArg) {
        var _this = this;
        return Observable.create(function (observer) { return tslib_1.__awaiter(_this, void 0, void 0, function () {
            var headers, token;
            return tslib_1.__generator(this, function (_a) {
                headers = headersArg;
                if (!headers) {
                    headers = new HttpHeaders();
                }
                try {
                    token = this.getToken();
                    headers = headers.set('Authorization', 'bearer ' + token);
                    observer.next(headers);
                    observer.complete();
                }
                catch (error) {
                    observer.error(error);
                }
                return [2 /*return*/];
            });
        }); });
    };
    AuthenticationService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    AuthenticationService.ctorParameters = function () { return [
        { type: AppConfigService },
        { type: AlfrescoApiService },
        { type: CookieService },
        { type: LogService }
    ]; };
    return AuthenticationService;
}());
export { AuthenticationService };
if (false) {
    /** @type {?} */
    AuthenticationService.prototype.redirectUrl;
    /** @type {?} */
    AuthenticationService.prototype.bearerExcludedUrls;
    /** @type {?} */
    AuthenticationService.prototype.onLogin;
    /** @type {?} */
    AuthenticationService.prototype.onLogout;
    /** @type {?} */
    AuthenticationService.prototype.appConfig;
    /** @type {?} */
    AuthenticationService.prototype.alfrescoApi;
    /** @type {?} */
    AuthenticationService.prototype.cookie;
    /** @type {?} */
    AuthenticationService.prototype.logService;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aGVudGljYXRpb24uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BhbGZyZXNjby9hZGYtY29yZS8iLCJzb3VyY2VzIjpbInNlcnZpY2VzL2F1dGhlbnRpY2F0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBaUJBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLFVBQVUsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLFVBQVUsRUFBWSxNQUFNLE1BQU0sQ0FBQztBQUN2RSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUM1RCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDakQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUUzQyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsZUFBZSxFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFFckYsT0FBTyxFQUFFLEdBQUcsRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdEQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHNCQUFzQixDQUFDOztBQUVuRCxJQUFNLHNCQUFzQixHQUFHLHNCQUFzQixDQUFDOztBQUN0RCxJQUFNLGlCQUFpQixHQUFHLElBQUksR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLENBQUU7O0lBV2hELCtCQUNZLFdBQ0EsYUFDQSxRQUNBO1FBSEEsY0FBUyxHQUFULFNBQVM7UUFDVCxnQkFBVyxHQUFYLFdBQVc7UUFDWCxXQUFNLEdBQU4sTUFBTTtRQUNOLGVBQVUsR0FBVixVQUFVOzJCQVhrQixJQUFJO2tDQUVMLENBQUMsYUFBYSxFQUFFLFlBQVksRUFBRSxTQUFTLENBQUM7dUJBRXZELElBQUksT0FBTyxFQUFPO3dCQUNqQixJQUFJLE9BQU8sRUFBTztL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QWVDO1FBZEcsT0FBTyxVQUFVLENBQUMsTUFBTSxDQUFDLFVBQU8sUUFBdUI7OztnQkFDL0MsT0FBTyxHQUFHLFVBQVUsQ0FBQztnQkFDekIsSUFBSSxDQUFDLE9BQU8sRUFBRTtvQkFDVixPQUFPLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQztpQkFDL0I7Z0JBQ0QsSUFBSTtvQkFDTSxLQUFLLEdBQVcsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO29CQUN0QyxPQUFPLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLEVBQUUsU0FBUyxHQUFHLEtBQUssQ0FBQyxDQUFDO29CQUMxRCxRQUFRLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO29CQUN2QixRQUFRLENBQUMsUUFBUSxFQUFFLENBQUM7aUJBQ3ZCO2dCQUFDLE9BQU8sS0FBSyxFQUFFO29CQUNaLFFBQVEsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7aUJBQ3pCOzs7YUFDSixDQUFDLENBQUM7S0FDTjs7Z0JBN1FKLFVBQVU7Ozs7Z0JBUkYsZ0JBQWdCO2dCQUpoQixrQkFBa0I7Z0JBQ2xCLGFBQWE7Z0JBQ2IsVUFBVTs7Z0NBckJuQjs7U0FnQ2EscUJBQXFCIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTYgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCwgZnJvbSwgdGhyb3dFcnJvciwgT2JzZXJ2ZXIgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IEFsZnJlc2NvQXBpU2VydmljZSB9IGZyb20gJy4vYWxmcmVzY28tYXBpLnNlcnZpY2UnO1xuaW1wb3J0IHsgQ29va2llU2VydmljZSB9IGZyb20gJy4vY29va2llLnNlcnZpY2UnO1xuaW1wb3J0IHsgTG9nU2VydmljZSB9IGZyb20gJy4vbG9nLnNlcnZpY2UnO1xuaW1wb3J0IHsgUmVkaXJlY3Rpb25Nb2RlbCB9IGZyb20gJy4uL21vZGVscy9yZWRpcmVjdGlvbi5tb2RlbCc7XG5pbXBvcnQgeyBBcHBDb25maWdTZXJ2aWNlLCBBcHBDb25maWdWYWx1ZXMgfSBmcm9tICcuLi9hcHAtY29uZmlnL2FwcC1jb25maWcuc2VydmljZSc7XG5pbXBvcnQgeyBVc2VyUmVwcmVzZW50YXRpb24gfSBmcm9tICdhbGZyZXNjby1qcy1hcGknO1xuaW1wb3J0IHsgbWFwLCBjYXRjaEVycm9yLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBIdHRwSGVhZGVycyB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcblxuY29uc3QgUkVNRU1CRVJfTUVfQ09PS0lFX0tFWSA9ICdBTEZSRVNDT19SRU1FTUJFUl9NRSc7XG5jb25zdCBSRU1FTUJFUl9NRV9VTlRJTCA9IDEwMDAgKiA2MCAqIDYwICogMjQgKiAzMCA7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBBdXRoZW50aWNhdGlvblNlcnZpY2Uge1xuICAgIHByaXZhdGUgcmVkaXJlY3RVcmw6IFJlZGlyZWN0aW9uTW9kZWwgPSBudWxsO1xuXG4gICAgcHJpdmF0ZSBiZWFyZXJFeGNsdWRlZFVybHM6IHN0cmluZ1tdID0gWydhdXRoL3JlYWxtcycsICdyZXNvdXJjZXMvJywgJ2Fzc2V0cy8nXTtcblxuICAgIG9uTG9naW46IFN1YmplY3Q8YW55PiA9IG5ldyBTdWJqZWN0PGFueT4oKTtcbiAgICBvbkxvZ291dDogU3ViamVjdDxhbnk+ID0gbmV3IFN1YmplY3Q8YW55PigpO1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHByaXZhdGUgYXBwQ29uZmlnOiBBcHBDb25maWdTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIGFsZnJlc2NvQXBpOiBBbGZyZXNjb0FwaVNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgY29va2llOiBDb29raWVTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIGxvZ1NlcnZpY2U6IExvZ1NlcnZpY2UpIHtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVja3MgaWYgdGhlIHVzZXIgbG9nZ2VkIGluLlxuICAgICAqIEByZXR1cm5zIFRydWUgaWYgbG9nZ2VkIGluLCBmYWxzZSBvdGhlcndpc2VcbiAgICAgKi9cbiAgICBpc0xvZ2dlZEluKCk6IGJvb2xlYW4ge1xuICAgICAgICAgICAgaWYgKCF0aGlzLmlzT2F1dGgoKSAmJiB0aGlzLmNvb2tpZS5pc0VuYWJsZWQoKSAmJiAhdGhpcy5pc1JlbWVtYmVyTWVTZXQoKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB0aGlzLmFsZnJlc2NvQXBpLmdldEluc3RhbmNlKCkuaXNMb2dnZWRJbigpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIERvZXMgdGhlIHByb3ZpZGVyIHN1cHBvcnQgT0F1dGg/XG4gICAgICogQHJldHVybnMgVHJ1ZSBpZiBzdXBwb3J0ZWQsIGZhbHNlIG90aGVyd2lzZVxuICAgICAqL1xuICAgIGlzT2F1dGgoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmFsZnJlc2NvQXBpLmdldEluc3RhbmNlKCkuaXNPYXV0aENvbmZpZ3VyYXRpb24oKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBEb2VzIHRoZSBwcm92aWRlciBzdXBwb3J0IEVDTT9cbiAgICAgKiBAcmV0dXJucyBUcnVlIGlmIHN1cHBvcnRlZCwgZmFsc2Ugb3RoZXJ3aXNlXG4gICAgICovXG4gICAgaXNFQ01Qcm92aWRlcigpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYWxmcmVzY29BcGkuZ2V0SW5zdGFuY2UoKS5pc0VjbUNvbmZpZ3VyYXRpb24oKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBEb2VzIHRoZSBwcm92aWRlciBzdXBwb3J0IEJQTT9cbiAgICAgKiBAcmV0dXJucyBUcnVlIGlmIHN1cHBvcnRlZCwgZmFsc2Ugb3RoZXJ3aXNlXG4gICAgICovXG4gICAgaXNCUE1Qcm92aWRlcigpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYWxmcmVzY29BcGkuZ2V0SW5zdGFuY2UoKS5pc0JwbUNvbmZpZ3VyYXRpb24oKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBEb2VzIHRoZSBwcm92aWRlciBzdXBwb3J0IGJvdGggRUNNIGFuZCBCUE0/XG4gICAgICogQHJldHVybnMgVHJ1ZSBpZiBib3RoIGFyZSBzdXBwb3J0ZWQsIGZhbHNlIG90aGVyd2lzZVxuICAgICAqL1xuICAgIGlzQUxMUHJvdmlkZXIoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmFsZnJlc2NvQXBpLmdldEluc3RhbmNlKCkuaXNFY21CcG1Db25maWd1cmF0aW9uKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTG9ncyB0aGUgdXNlciBpbi5cbiAgICAgKiBAcGFyYW0gdXNlcm5hbWUgVXNlcm5hbWUgZm9yIHRoZSBsb2dpblxuICAgICAqIEBwYXJhbSBwYXNzd29yZCBQYXNzd29yZCBmb3IgdGhlIGxvZ2luXG4gICAgICogQHBhcmFtIHJlbWVtYmVyTWUgU3RvcmVzIHRoZSB1c2VyJ3MgbG9naW4gZGV0YWlscyBpZiB0cnVlXG4gICAgICogQHJldHVybnMgT2JqZWN0IHdpdGggYXV0aCB0eXBlIChcIkVDTVwiLCBcIkJQTVwiIG9yIFwiQUxMXCIpIGFuZCBhdXRoIHRpY2tldFxuICAgICAqL1xuICAgIGxvZ2luKHVzZXJuYW1lOiBzdHJpbmcsIHBhc3N3b3JkOiBzdHJpbmcsIHJlbWVtYmVyTWU6IGJvb2xlYW4gPSBmYWxzZSk6IE9ic2VydmFibGU8eyB0eXBlOiBzdHJpbmcsIHRpY2tldDogYW55IH0+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5hbGZyZXNjb0FwaS5nZXRJbnN0YW5jZSgpLmxvZ2luKHVzZXJuYW1lLCBwYXNzd29yZCkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKHJlc3BvbnNlOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zYXZlUmVtZW1iZXJNZUNvb2tpZShyZW1lbWJlck1lKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5vbkxvZ2luLm5leHQocmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogdGhpcy5hcHBDb25maWcuZ2V0KEFwcENvbmZpZ1ZhbHVlcy5QUk9WSURFUlMpLFxuICAgICAgICAgICAgICAgICAgICAgICAgdGlja2V0OiByZXNwb25zZVxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoZXJyID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTG9ncyB0aGUgdXNlciBpbiB3aXRoIFNTT1xuICAgICAqL1xuICAgIHNzb0ltcGxpY2l0TG9naW4oKSB7XG4gICAgICAgIHRoaXMuYWxmcmVzY29BcGkuZ2V0SW5zdGFuY2UoKS5pbXBsaWNpdExvZ2luKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU2F2ZXMgdGhlIFwicmVtZW1iZXIgbWVcIiBjb29raWUgYXMgZWl0aGVyIGEgbG9uZy1saWZlIGNvb2tpZSBvciBhIHNlc3Npb24gY29va2llLlxuICAgICAqIEBwYXJhbSByZW1lbWJlck1lIEVuYWJsZXMgYSBsb25nLWxpZmUgY29va2llXG4gICAgICovXG4gICAgcHJpdmF0ZSBzYXZlUmVtZW1iZXJNZUNvb2tpZShyZW1lbWJlck1lOiBib29sZWFuKTogdm9pZCB7XG4gICAgICAgIGxldCBleHBpcmF0aW9uID0gbnVsbDtcblxuICAgICAgICBpZiAocmVtZW1iZXJNZSkge1xuICAgICAgICAgICAgZXhwaXJhdGlvbiA9IG5ldyBEYXRlKCk7XG4gICAgICAgICAgICBjb25zdCB0aW1lID0gZXhwaXJhdGlvbi5nZXRUaW1lKCk7XG4gICAgICAgICAgICBjb25zdCBleHBpcmVUaW1lID0gdGltZSArIFJFTUVNQkVSX01FX1VOVElMO1xuICAgICAgICAgICAgZXhwaXJhdGlvbi5zZXRUaW1lKGV4cGlyZVRpbWUpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuY29va2llLnNldEl0ZW0oUkVNRU1CRVJfTUVfQ09PS0lFX0tFWSwgJzEnLCBleHBpcmF0aW9uLCBudWxsKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVja3Mgd2hldGhlciB0aGUgXCJyZW1lbWJlciBtZVwiIGNvb2tpZSB3YXMgc2V0IG9yIG5vdC5cbiAgICAgKiBAcmV0dXJucyBUcnVlIGlmIHNldCwgZmFsc2Ugb3RoZXJ3aXNlXG4gICAgICovXG4gICAgaXNSZW1lbWJlck1lU2V0KCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gKHRoaXMuY29va2llLmdldEl0ZW0oUkVNRU1CRVJfTUVfQ09PS0lFX0tFWSkgPT09IG51bGwpID8gZmFsc2UgOiB0cnVlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIExvZ3MgdGhlIHVzZXIgb3V0LlxuICAgICAqIEByZXR1cm5zIFJlc3BvbnNlIGV2ZW50IGNhbGxlZCB3aGVuIGxvZ291dCBpcyBjb21wbGV0ZVxuICAgICAqL1xuICAgIGxvZ291dCgpIHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5jYWxsQXBpTG9nb3V0KCkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICB0YXAocmVzcG9uc2UgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLm9uTG9nb3V0Lm5leHQocmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2U7XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcihlcnIgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNhbGxBcGlMb2dvdXQoKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgaWYgKHRoaXMuYWxmcmVzY29BcGkuZ2V0SW5zdGFuY2UoKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWxmcmVzY29BcGkuZ2V0SW5zdGFuY2UoKS5sb2dvdXQoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIEVDTSB0aWNrZXQgc3RvcmVkIGluIHRoZSBTdG9yYWdlLlxuICAgICAqIEByZXR1cm5zIFRoZSB0aWNrZXQgb3IgYG51bGxgIGlmIG5vbmUgd2FzIGZvdW5kXG4gICAgICovXG4gICAgZ2V0VGlja2V0RWNtKCk6IHN0cmluZyB8IG51bGwge1xuICAgICAgICByZXR1cm4gdGhpcy5hbGZyZXNjb0FwaS5nZXRJbnN0YW5jZSgpLmdldFRpY2tldEVjbSgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIEJQTSB0aWNrZXQgc3RvcmVkIGluIHRoZSBTdG9yYWdlLlxuICAgICAqIEByZXR1cm5zIFRoZSB0aWNrZXQgb3IgYG51bGxgIGlmIG5vbmUgd2FzIGZvdW5kXG4gICAgICovXG4gICAgZ2V0VGlja2V0QnBtKCk6IHN0cmluZyB8IG51bGwge1xuICAgICAgICByZXR1cm4gdGhpcy5hbGZyZXNjb0FwaS5nZXRJbnN0YW5jZSgpLmdldFRpY2tldEJwbSgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIEJQTSB0aWNrZXQgZnJvbSB0aGUgU3RvcmFnZSBpbiBCYXNlIDY0IGZvcm1hdC5cbiAgICAgKiBAcmV0dXJucyBUaGUgdGlja2V0IG9yIGBudWxsYCBpZiBub25lIHdhcyBmb3VuZFxuICAgICAqL1xuICAgIGdldFRpY2tldEVjbUJhc2U2NCgpOiBzdHJpbmcgfCBudWxsIHtcbiAgICAgICAgbGV0IHRpY2tldCA9IHRoaXMuYWxmcmVzY29BcGkuZ2V0SW5zdGFuY2UoKS5nZXRUaWNrZXRFY20oKTtcbiAgICAgICAgaWYgKHRpY2tldCkge1xuICAgICAgICAgICAgcmV0dXJuICdCYXNpYyAnICsgYnRvYSh0aWNrZXQpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrcyBpZiB0aGUgdXNlciBpcyBsb2dnZWQgaW4gb24gYW4gRUNNIHByb3ZpZGVyLlxuICAgICAqIEByZXR1cm5zIFRydWUgaWYgbG9nZ2VkIGluLCBmYWxzZSBvdGhlcndpc2VcbiAgICAgKi9cbiAgICBpc0VjbUxvZ2dlZEluKCk6IGJvb2xlYW4ge1xuICAgICAgICBpZiAodGhpcy5pc0VDTVByb3ZpZGVyKCkgfHwgdGhpcy5pc0FMTFByb3ZpZGVyKCkpIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5pc09hdXRoKCkgJiYgdGhpcy5jb29raWUuaXNFbmFibGVkKCkgJiYgIXRoaXMuaXNSZW1lbWJlck1lU2V0KCkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5hbGZyZXNjb0FwaS5nZXRJbnN0YW5jZSgpLmlzRWNtTG9nZ2VkSW4oKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2tzIGlmIHRoZSB1c2VyIGlzIGxvZ2dlZCBpbiBvbiBhIEJQTSBwcm92aWRlci5cbiAgICAgKiBAcmV0dXJucyBUcnVlIGlmIGxvZ2dlZCBpbiwgZmFsc2Ugb3RoZXJ3aXNlXG4gICAgICovXG4gICAgaXNCcG1Mb2dnZWRJbigpOiBib29sZWFuIHtcbiAgICAgICAgaWYgKHRoaXMuaXNCUE1Qcm92aWRlcigpIHx8IHRoaXMuaXNBTExQcm92aWRlcigpKSB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuaXNPYXV0aCgpICYmIHRoaXMuY29va2llLmlzRW5hYmxlZCgpICYmICF0aGlzLmlzUmVtZW1iZXJNZVNldCgpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWxmcmVzY29BcGkuZ2V0SW5zdGFuY2UoKS5pc0JwbUxvZ2dlZEluKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIEVDTSB1c2VybmFtZS5cbiAgICAgKiBAcmV0dXJucyBUaGUgRUNNIHVzZXJuYW1lXG4gICAgICovXG4gICAgZ2V0RWNtVXNlcm5hbWUoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYWxmcmVzY29BcGkuZ2V0SW5zdGFuY2UoKS5nZXRFY21Vc2VybmFtZSgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIEJQTSB1c2VybmFtZVxuICAgICAqIEByZXR1cm5zIFRoZSBCUE0gdXNlcm5hbWVcbiAgICAgKi9cbiAgICBnZXRCcG1Vc2VybmFtZSgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5hbGZyZXNjb0FwaS5nZXRJbnN0YW5jZSgpLmdldEJwbVVzZXJuYW1lKCk7XG4gICAgfVxuXG4gICAgLyoqIFNldHMgdGhlIFVSTCB0byByZWRpcmVjdCB0byBhZnRlciBsb2dpbi5cbiAgICAgKiBAcGFyYW0gdXJsIFVSTCB0byByZWRpcmVjdCB0b1xuICAgICAqL1xuICAgIHNldFJlZGlyZWN0KHVybDogUmVkaXJlY3Rpb25Nb2RlbCkge1xuICAgICAgICB0aGlzLnJlZGlyZWN0VXJsID0gdXJsO1xuICAgIH1cblxuICAgIC8qKiBHZXRzIHRoZSBVUkwgdG8gcmVkaXJlY3QgdG8gYWZ0ZXIgbG9naW4uXG4gICAgICogQHBhcmFtIHByb3ZpZGVyIFNlcnZpY2UgcHJvdmlkZXIuIENhbiBiZSBcIkVDTVwiLCBcIkJQTVwiIG9yIFwiQUxMXCIuXG4gICAgICogQHJldHVybnMgVGhlIHJlZGlyZWN0IFVSTFxuICAgICAqL1xuICAgIGdldFJlZGlyZWN0KHByb3ZpZGVyOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5oYXNWYWxpZFJlZGlyZWN0aW9uKHByb3ZpZGVyKSA/IHRoaXMucmVkaXJlY3RVcmwudXJsIDogbnVsbDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIGluZm9ybWF0aW9uIGFib3V0IHRoZSB1c2VyIGN1cnJlbnRseSBsb2dnZWQgaW50byBBUFMuXG4gICAgICogQHJldHVybnMgVXNlciBpbmZvcm1hdGlvblxuICAgICAqL1xuICAgIGdldEJwbUxvZ2dlZFVzZXIoKTogT2JzZXJ2YWJsZTxVc2VyUmVwcmVzZW50YXRpb24+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5hbGZyZXNjb0FwaS5nZXRJbnN0YW5jZSgpLmFjdGl2aXRpLnByb2ZpbGVBcGkuZ2V0UHJvZmlsZSgpKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGhhc1ZhbGlkUmVkaXJlY3Rpb24ocHJvdmlkZXI6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5yZWRpcmVjdFVybCAmJiAodGhpcy5yZWRpcmVjdFVybC5wcm92aWRlciA9PT0gcHJvdmlkZXIgfHwgdGhpcy5oYXNTZWxlY3RlZFByb3ZpZGVyQWxsKHByb3ZpZGVyKSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBoYXNTZWxlY3RlZFByb3ZpZGVyQWxsKHByb3ZpZGVyOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucmVkaXJlY3RVcmwgJiYgKHRoaXMucmVkaXJlY3RVcmwucHJvdmlkZXIgPT09ICdBTEwnIHx8IHByb3ZpZGVyID09PSAnQUxMJyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUHJpbnRzIGFuIGVycm9yIG1lc3NhZ2UgaW4gdGhlIGNvbnNvbGUgYnJvd3NlclxuICAgICAqIEBwYXJhbSBlcnJvciBFcnJvciBtZXNzYWdlXG4gICAgICogQHJldHVybnMgT2JqZWN0IHJlcHJlc2VudGluZyB0aGUgZXJyb3IgbWVzc2FnZVxuICAgICAqL1xuICAgIGhhbmRsZUVycm9yKGVycm9yOiBhbnkpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICB0aGlzLmxvZ1NlcnZpY2UuZXJyb3IoJ0Vycm9yIHdoZW4gbG9nZ2luZyBpbicsIGVycm9yKTtcbiAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoZXJyb3IgfHwgJ1NlcnZlciBlcnJvcicpO1xuICAgIH1cblxuICAgIGdldEJlYXJlckV4Y2x1ZGVkVXJscygpOiBzdHJpbmdbXSB7XG4gICAgICAgIHJldHVybiB0aGlzLmJlYXJlckV4Y2x1ZGVkVXJscztcbiAgICB9XG5cbiAgICBnZXRUb2tlbigpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2FjY2Vzc190b2tlbicpO1xuICAgIH1cblxuICAgIGFkZFRva2VuVG9IZWFkZXIoaGVhZGVyc0FyZz86IEh0dHBIZWFkZXJzKTogT2JzZXJ2YWJsZTxIdHRwSGVhZGVycz4ge1xuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5jcmVhdGUoYXN5bmMgKG9ic2VydmVyOiBPYnNlcnZlcjxhbnk+KSA9PiB7XG4gICAgICAgICAgICBsZXQgaGVhZGVycyA9IGhlYWRlcnNBcmc7XG4gICAgICAgICAgICBpZiAoIWhlYWRlcnMpIHtcbiAgICAgICAgICAgICAgICBoZWFkZXJzID0gbmV3IEh0dHBIZWFkZXJzKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHRva2VuOiBzdHJpbmcgPSB0aGlzLmdldFRva2VuKCk7XG4gICAgICAgICAgICAgICAgaGVhZGVycyA9IGhlYWRlcnMuc2V0KCdBdXRob3JpemF0aW9uJywgJ2JlYXJlciAnICsgdG9rZW4pO1xuICAgICAgICAgICAgICAgIG9ic2VydmVyLm5leHQoaGVhZGVycyk7XG4gICAgICAgICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgb2JzZXJ2ZXIuZXJyb3IoZXJyb3IpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG59XG4iXX0=