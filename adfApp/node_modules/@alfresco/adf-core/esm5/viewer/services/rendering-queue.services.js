/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
/* tslint:disable:adf-license-banner  */
import { Injectable } from '@angular/core';
/**
 *
 * RenderingQueueServices rendering of the views for pages and thumbnails.
 *
 */
var RenderingQueueServices = /** @class */ (function () {
    function RenderingQueueServices() {
        this.renderingStates = {
            INITIAL: 0,
            RUNNING: 1,
            PAUSED: 2,
            FINISHED: 3
        };
        this.CLEANUP_TIMEOUT = 30000;
        this.pdfViewer = null;
        this.pdfThumbnailViewer = null;
        this.onIdle = null;
        this.highestPriorityPage = null;
        this.idleTimeout = null;
        this.printing = false;
        this.isThumbnailViewEnabled = false;
    }
    /**
     * @param pdfViewer
     */
    /**
     * @param {?} pdfViewer
     * @return {?}
     */
    RenderingQueueServices.prototype.setViewer = /**
     * @param {?} pdfViewer
     * @return {?}
     */
    function (pdfViewer) {
        this.pdfViewer = pdfViewer;
    };
    /**
     * @param pdfThumbnailViewer
     */
    /**
     * @param {?} pdfThumbnailViewer
     * @return {?}
     */
    RenderingQueueServices.prototype.setThumbnailViewer = /**
     * @param {?} pdfThumbnailViewer
     * @return {?}
     */
    function (pdfThumbnailViewer) {
        this.pdfThumbnailViewer = pdfThumbnailViewer;
    };
    /**
     * @param  view
     */
    /**
     * @param {?} view
     * @return {?}
     */
    RenderingQueueServices.prototype.isHighestPriority = /**
     * @param {?} view
     * @return {?}
     */
    function (view) {
        return this.highestPriorityPage === view.renderingId;
    };
    /**
     * @param {?} currentlyVisiblePages
     * @return {?}
     */
    RenderingQueueServices.prototype.renderHighestPriority = /**
     * @param {?} currentlyVisiblePages
     * @return {?}
     */
    function (currentlyVisiblePages) {
        if (this.idleTimeout) {
            clearTimeout(this.idleTimeout);
            this.idleTimeout = null;
        }
        // Pages have a higher priority than thumbnails, so check them first.
        if (this.pdfViewer.forceRendering(currentlyVisiblePages)) {
            return;
        }
        // No pages needed rendering so check thumbnails.
        if (this.pdfThumbnailViewer && this.isThumbnailViewEnabled) {
            if (this.pdfThumbnailViewer.forceRendering()) {
                return;
            }
        }
        if (this.printing) {
            // If printing is currently ongoing do not reschedule cleanup.
            return;
        }
        if (this.onIdle) {
            this.idleTimeout = setTimeout(this.onIdle.bind(this), this.CLEANUP_TIMEOUT);
        }
    };
    /**
     * @param {?} visible
     * @param {?} views
     * @param {?} scrolledDown
     * @return {?}
     */
    RenderingQueueServices.prototype.getHighestPriority = /**
     * @param {?} visible
     * @param {?} views
     * @param {?} scrolledDown
     * @return {?}
     */
    function (visible, views, scrolledDown) {
        /** @type {?} */
        var visibleViews = visible.views;
        /** @type {?} */
        var numVisible = visibleViews.length;
        if (numVisible === 0) {
            return false;
        }
        for (var i = 0; i < numVisible; ++i) {
            /** @type {?} */
            var view = visibleViews[i].view;
            if (!this.isViewFinished(view)) {
                return view;
            }
        }
        // All the visible views have rendered, try to render next/previous pages.
        if (scrolledDown) {
            /** @type {?} */
            var nextPageIndex = visible.last.id;
            // ID's start at 1 so no need to add 1.
            if (views[nextPageIndex] && !this.isViewFinished(views[nextPageIndex])) {
                return views[nextPageIndex];
            }
        }
        else {
            /** @type {?} */
            var previousPageIndex = visible.first.id - 2;
            if (views[previousPageIndex] && !this.isViewFinished(views[previousPageIndex])) {
                return views[previousPageIndex];
            }
        }
        // Everything that needs to be rendered has been.
        return null;
    };
    /**
     * @param view
     */
    /**
     * @param {?} view
     * @return {?}
     */
    RenderingQueueServices.prototype.isViewFinished = /**
     * @param {?} view
     * @return {?}
     */
    function (view) {
        return view.renderingState === this.renderingStates.FINISHED;
    };
    /**
     * Render a page or thumbnail view. This calls the appropriate function
     * based on the views state. If the view is already rendered it will return
     * false.
     * @param view
     */
    /**
     * Render a page or thumbnail view. This calls the appropriate function
     * based on the views state. If the view is already rendered it will return
     * false.
     * @param {?} view
     * @return {?}
     */
    RenderingQueueServices.prototype.renderView = /**
     * Render a page or thumbnail view. This calls the appropriate function
     * based on the views state. If the view is already rendered it will return
     * false.
     * @param {?} view
     * @return {?}
     */
    function (view) {
        /** @type {?} */
        var state = view.renderingState;
        switch (state) {
            case this.renderingStates.FINISHED:
                return false;
            case this.renderingStates.PAUSED:
                this.highestPriorityPage = view.renderingId;
                view.resume();
                break;
            case this.renderingStates.RUNNING:
                this.highestPriorityPage = view.renderingId;
                break;
            case this.renderingStates.INITIAL:
                this.highestPriorityPage = view.renderingId;
                /** @type {?} */
                var continueRendering = function () {
                    this.renderHighestPriority();
                }.bind(this);
                view.draw().then(continueRendering, continueRendering);
                break;
            default:
                break;
        }
        return true;
    };
    RenderingQueueServices.decorators = [
        { type: Injectable }
    ];
    return RenderingQueueServices;
}());
export { RenderingQueueServices };
if (false) {
    /** @type {?} */
    RenderingQueueServices.prototype.renderingStates;
    /** @type {?} */
    RenderingQueueServices.prototype.CLEANUP_TIMEOUT;
    /** @type {?} */
    RenderingQueueServices.prototype.pdfViewer;
    /** @type {?} */
    RenderingQueueServices.prototype.pdfThumbnailViewer;
    /** @type {?} */
    RenderingQueueServices.prototype.onIdle;
    /** @type {?} */
    RenderingQueueServices.prototype.highestPriorityPage;
    /** @type {?} */
    RenderingQueueServices.prototype.idleTimeout;
    /** @type {?} */
    RenderingQueueServices.prototype.printing;
    /** @type {?} */
    RenderingQueueServices.prototype.isThumbnailViewEnabled;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGVyaW5nLXF1ZXVlLnNlcnZpY2VzLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGFsZnJlc2NvL2FkZi1jb3JlLyIsInNvdXJjZXMiOlsidmlld2VyL3NlcnZpY2VzL3JlbmRlcmluZy1xdWV1ZS5zZXJ2aWNlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQWlCQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDOzs7Ozs7OzsrQkFVckI7WUFDZCxPQUFPLEVBQUUsQ0FBQztZQUNWLE9BQU8sRUFBRSxDQUFDO1lBQ1YsTUFBTSxFQUFFLENBQUM7WUFDVCxRQUFRLEVBQUUsQ0FBQztTQUNkOytCQUV5QixLQUFLO3lCQUVkLElBQUk7a0NBQ0ssSUFBSTtzQkFDaEIsSUFBSTttQ0FFUyxJQUFJOzJCQUNaLElBQUk7d0JBQ1AsS0FBSztzQ0FDUyxLQUFLOztJQUVuQzs7T0FFRzs7Ozs7SUFDSCwwQ0FBUzs7OztJQUFULFVBQVUsU0FBUztRQUNmLElBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO0tBQzlCO0lBRUQ7O09BRUc7Ozs7O0lBQ0gsbURBQWtCOzs7O0lBQWxCLFVBQW1CLGtCQUFrQjtRQUNqQyxJQUFJLENBQUMsa0JBQWtCLEdBQUcsa0JBQWtCLENBQUM7S0FDaEQ7SUFFRDs7T0FFRzs7Ozs7SUFDSCxrREFBaUI7Ozs7SUFBakIsVUFBa0IsSUFBUztRQUN2QixPQUFPLElBQUksQ0FBQyxtQkFBbUIsS0FBSyxJQUFJLENBQUMsV0FBVyxDQUFDO0tBQ3hEOzs7OztJQUVELHNEQUFxQjs7OztJQUFyQixVQUFzQixxQkFBcUI7UUFDdkMsSUFBSSxJQUFJLENBQUMsV0FBVyxFQUFFO1lBQ2xCLFlBQVksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDL0IsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7U0FDM0I7O1FBR0QsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLGNBQWMsQ0FBQyxxQkFBcUIsQ0FBQyxF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QUFJLGlCQUFpQixHQUFHO29CQUNwQixJQUFJLENBQUMscUJBQXFCLEVBQUUsQ0FBQztpQkFDaEMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ2IsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO2dCQUN2RCxNQUFNO1lBQ1Y7Z0JBQ0ksTUFBTTtTQUNiO1FBQ0QsT0FBTyxJQUFJLENBQUM7S0FDZjs7Z0JBOUlKLFVBQVU7O2lDQXhCWDs7U0F5QmEsc0JBQXNCIiwic291cmNlc0NvbnRlbnQiOlsiLyogdHNsaW50OmRpc2FibGU6YWRmLWxpY2Vuc2UtYmFubmVyICAqL1xuXG4vKiBDb3B5cmlnaHQgMjAxMiBNb3ppbGxhIEZvdW5kYXRpb25cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG4vKipcbiAqXG4gKiBSZW5kZXJpbmdRdWV1ZVNlcnZpY2VzIHJlbmRlcmluZyBvZiB0aGUgdmlld3MgZm9yIHBhZ2VzIGFuZCB0aHVtYm5haWxzLlxuICpcbiAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFJlbmRlcmluZ1F1ZXVlU2VydmljZXMge1xuXG4gICAgcmVuZGVyaW5nU3RhdGVzID0ge1xuICAgICAgICBJTklUSUFMOiAwLFxuICAgICAgICBSVU5OSU5HOiAxLFxuICAgICAgICBQQVVTRUQ6IDIsXG4gICAgICAgIEZJTklTSEVEOiAzXG4gICAgfTtcblxuICAgIENMRUFOVVBfVElNRU9VVDogbnVtYmVyID0gMzAwMDA7XG5cbiAgICBwZGZWaWV3ZXI6IGFueSA9IG51bGw7XG4gICAgcGRmVGh1bWJuYWlsVmlld2VyOiBhbnkgPSBudWxsO1xuICAgIG9uSWRsZTogYW55ID0gbnVsbDtcblxuICAgIGhpZ2hlc3RQcmlvcml0eVBhZ2U6IGFueSA9IG51bGw7XG4gICAgaWRsZVRpbWVvdXQ6IGFueSA9IG51bGw7XG4gICAgcHJpbnRpbmc6IGFueSA9IGZhbHNlO1xuICAgIGlzVGh1bWJuYWlsVmlld0VuYWJsZWQ6IGFueSA9IGZhbHNlO1xuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHBkZlZpZXdlclxuICAgICAqL1xuICAgIHNldFZpZXdlcihwZGZWaWV3ZXIpIHtcbiAgICAgICAgdGhpcy5wZGZWaWV3ZXIgPSBwZGZWaWV3ZXI7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHBkZlRodW1ibmFpbFZpZXdlclxuICAgICAqL1xuICAgIHNldFRodW1ibmFpbFZpZXdlcihwZGZUaHVtYm5haWxWaWV3ZXIpIHtcbiAgICAgICAgdGhpcy5wZGZUaHVtYm5haWxWaWV3ZXIgPSBwZGZUaHVtYm5haWxWaWV3ZXI7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHBhcmFtICB2aWV3XG4gICAgICovXG4gICAgaXNIaWdoZXN0UHJpb3JpdHkodmlldzogYW55KTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmhpZ2hlc3RQcmlvcml0eVBhZ2UgPT09IHZpZXcucmVuZGVyaW5nSWQ7XG4gICAgfVxuXG4gICAgcmVuZGVySGlnaGVzdFByaW9yaXR5KGN1cnJlbnRseVZpc2libGVQYWdlcykge1xuICAgICAgICBpZiAodGhpcy5pZGxlVGltZW91dCkge1xuICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuaWRsZVRpbWVvdXQpO1xuICAgICAgICAgICAgdGhpcy5pZGxlVGltZW91dCA9IG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBQYWdlcyBoYXZlIGEgaGlnaGVyIHByaW9yaXR5IHRoYW4gdGh1bWJuYWlscywgc28gY2hlY2sgdGhlbSBmaXJzdC5cbiAgICAgICAgaWYgKHRoaXMucGRmVmlld2VyLmZvcmNlUmVuZGVyaW5nKGN1cnJlbnRseVZpc2libGVQYWdlcykpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICAvLyBObyBwYWdlcyBuZWVkZWQgcmVuZGVyaW5nIHNvIGNoZWNrIHRodW1ibmFpbHMuXG4gICAgICAgIGlmICh0aGlzLnBkZlRodW1ibmFpbFZpZXdlciAmJiB0aGlzLmlzVGh1bWJuYWlsVmlld0VuYWJsZWQpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLnBkZlRodW1ibmFpbFZpZXdlci5mb3JjZVJlbmRlcmluZygpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMucHJpbnRpbmcpIHtcbiAgICAgICAgICAgIC8vIElmIHByaW50aW5nIGlzIGN1cnJlbnRseSBvbmdvaW5nIGRvIG5vdCByZXNjaGVkdWxlIGNsZWFudXAuXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5vbklkbGUpIHtcbiAgICAgICAgICAgIHRoaXMuaWRsZVRpbWVvdXQgPSBzZXRUaW1lb3V0KHRoaXMub25JZGxlLmJpbmQodGhpcyksIHRoaXMuQ0xFQU5VUF9USU1FT1VUKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGdldEhpZ2hlc3RQcmlvcml0eSh2aXNpYmxlLCB2aWV3cywgc2Nyb2xsZWREb3duKSB7XG4gICAgICAgIC8vIFRoZSBzdGF0ZSBoYXMgY2hhbmdlZCBmaWd1cmUgb3V0IHdoaWNoIHBhZ2UgaGFzIHRoZSBoaWdoZXN0IHByaW9yaXR5IHRvXG4gICAgICAgIC8vIHJlbmRlciBuZXh0IChpZiBhbnkpLlxuICAgICAgICAvLyBQcmlvcml0eTpcbiAgICAgICAgLy8gMSB2aXNpYmxlIHBhZ2VzXG4gICAgICAgIC8vIDIgaWYgbGFzdCBzY3JvbGxlZCBkb3duIHBhZ2UgYWZ0ZXIgdGhlIHZpc2libGUgcGFnZXNcbiAgICAgICAgLy8gMiBpZiBsYXN0IHNjcm9sbGVkIHVwIHBhZ2UgYmVmb3JlIHRoZSB2aXNpYmxlIHBhZ2VzXG4gICAgICAgIGxldCB2aXNpYmxlVmlld3MgPSB2aXNpYmxlLnZpZXdzO1xuXG4gICAgICAgIGxldCBudW1WaXNpYmxlID0gdmlzaWJsZVZpZXdzLmxlbmd0aDtcbiAgICAgICAgaWYgKG51bVZpc2libGUgPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bVZpc2libGU7ICsraSkge1xuICAgICAgICAgICAgbGV0IHZpZXcgPSB2aXNpYmxlVmlld3NbaV0udmlldztcbiAgICAgICAgICAgIGlmICghdGhpcy5pc1ZpZXdGaW5pc2hlZCh2aWV3KSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB2aWV3O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gQWxsIHRoZSB2aXNpYmxlIHZpZXdzIGhhdmUgcmVuZGVyZWQsIHRyeSB0byByZW5kZXIgbmV4dC9wcmV2aW91cyBwYWdlcy5cbiAgICAgICAgaWYgKHNjcm9sbGVkRG93bikge1xuICAgICAgICAgICAgbGV0IG5leHRQYWdlSW5kZXggPSB2aXNpYmxlLmxhc3QuaWQ7XG4gICAgICAgICAgICAvLyBJRCdzIHN0YXJ0IGF0IDEgc28gbm8gbmVlZCB0byBhZGQgMS5cbiAgICAgICAgICAgIGlmICh2aWV3c1tuZXh0UGFnZUluZGV4XSAmJiAhdGhpcy5pc1ZpZXdGaW5pc2hlZCh2aWV3c1tuZXh0UGFnZUluZGV4XSkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdmlld3NbbmV4dFBhZ2VJbmRleF07XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsZXQgcHJldmlvdXNQYWdlSW5kZXggPSB2aXNpYmxlLmZpcnN0LmlkIC0gMjtcbiAgICAgICAgICAgIGlmICh2aWV3c1twcmV2aW91c1BhZ2VJbmRleF0gJiYgIXRoaXMuaXNWaWV3RmluaXNoZWQodmlld3NbcHJldmlvdXNQYWdlSW5kZXhdKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB2aWV3c1twcmV2aW91c1BhZ2VJbmRleF07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgLy8gRXZlcnl0aGluZyB0aGF0IG5lZWRzIHRvIGJlIHJlbmRlcmVkIGhhcyBiZWVuLlxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0gdmlld1xuICAgICAqL1xuICAgIGlzVmlld0ZpbmlzaGVkKHZpZXcpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHZpZXcucmVuZGVyaW5nU3RhdGUgPT09IHRoaXMucmVuZGVyaW5nU3RhdGVzLkZJTklTSEVEO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbmRlciBhIHBhZ2Ugb3IgdGh1bWJuYWlsIHZpZXcuIFRoaXMgY2FsbHMgdGhlIGFwcHJvcHJpYXRlIGZ1bmN0aW9uXG4gICAgICogYmFzZWQgb24gdGhlIHZpZXdzIHN0YXRlLiBJZiB0aGUgdmlldyBpcyBhbHJlYWR5IHJlbmRlcmVkIGl0IHdpbGwgcmV0dXJuXG4gICAgICogZmFsc2UuXG4gICAgICogQHBhcmFtIHZpZXdcbiAgICAgKi9cbiAgICByZW5kZXJWaWV3KHZpZXc6IGFueSkge1xuICAgICAgICBsZXQgc3RhdGUgPSB2aWV3LnJlbmRlcmluZ1N0YXRlO1xuICAgICAgICBzd2l0Y2ggKHN0YXRlKSB7XG4gICAgICAgICAgICBjYXNlIHRoaXMucmVuZGVyaW5nU3RhdGVzLkZJTklTSEVEOlxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIGNhc2UgdGhpcy5yZW5kZXJpbmdTdGF0ZXMuUEFVU0VEOlxuICAgICAgICAgICAgICAgIHRoaXMuaGlnaGVzdFByaW9yaXR5UGFnZSA9IHZpZXcucmVuZGVyaW5nSWQ7XG4gICAgICAgICAgICAgICAgdmlldy5yZXN1bWUoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgdGhpcy5yZW5kZXJpbmdTdGF0ZXMuUlVOTklORzpcbiAgICAgICAgICAgICAgICB0aGlzLmhpZ2hlc3RQcmlvcml0eVBhZ2UgPSB2aWV3LnJlbmRlcmluZ0lkO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSB0aGlzLnJlbmRlcmluZ1N0YXRlcy5JTklUSUFMOlxuICAgICAgICAgICAgICAgIHRoaXMuaGlnaGVzdFByaW9yaXR5UGFnZSA9IHZpZXcucmVuZGVyaW5nSWQ7XG4gICAgICAgICAgICAgICAgbGV0IGNvbnRpbnVlUmVuZGVyaW5nID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRlckhpZ2hlc3RQcmlvcml0eSgpO1xuICAgICAgICAgICAgICAgIH0uYmluZCh0aGlzKTtcbiAgICAgICAgICAgICAgICB2aWV3LmRyYXcoKS50aGVuKGNvbnRpbnVlUmVuZGVyaW5nLCBjb250aW51ZVJlbmRlcmluZyk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbn1cbiJdfQ==