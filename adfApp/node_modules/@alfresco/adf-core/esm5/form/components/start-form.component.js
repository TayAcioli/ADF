/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
/*!
 * @license
 * Copyright 2016 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import * as tslib_1 from "tslib";
import { Component, ElementRef, EventEmitter, Input, Output, ViewChild, ViewEncapsulation } from '@angular/core';
import { FormService } from './../services/form.service';
import { WidgetVisibilityService } from './../services/widget-visibility.service';
import { FormComponent } from './form.component';
import { FormOutcomeModel } from './widgets/core/index';
var StartFormComponent = /** @class */ (function (_super) {
    tslib_1.__extends(StartFormComponent, _super);
    function StartFormComponent(formService, visibilityService) {
        var _this = _super.call(this, formService, visibilityService, null, null) || this;
        /**
         * Should form outcome buttons be shown?
         */
        _this.showOutcomeButtons = true;
        /**
         * Should the refresh button be shown?
         */
        _this.showRefreshButton = true;
        /**
         * Is the form read-only (ie, can't be edited)?
         */
        _this.readOnlyForm = false;
        /**
         * Emitted when the user clicks one of the outcome buttons that completes the form.
         */
        _this.outcomeClick = new EventEmitter();
        /**
         * Emitted when a field of the form is clicked.
         */
        _this.formContentClicked = new EventEmitter();
        _this.outcomesContainer = null;
        _this.showTitle = false;
        return _this;
    }
    /**
     * @return {?}
     */
    StartFormComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this.subscriptions.push(this.formService.formContentClicked.subscribe(function (content) {
            _this.formContentClicked.emit(content);
        }), this.formService.validateForm.subscribe(function (validateFormEvent) {
            if (validateFormEvent.errorsField.length > 0) {
                _this.formError.next(validateFormEvent.errorsField);
            }
        }));
    };
    /**
     * @return {?}
     */
    StartFormComponent.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        this.subscriptions.forEach(function (subscription) { return subscription.unsubscribe(); });
        this.subscriptions = [];
    };
    /**
     * @param {?} changes
     * @return {?}
     */
    StartFormComponent.prototype.ngOnChanges = /**
     * @param {?} changes
     * @return {?}
     */
    function (changes) {
        /** @type {?} */
        var processDefinitionId = changes['processDefinitionId'];
        if (processDefinitionId && processDefinitionId.currentValue) {
            this.visibilityService.cleanProcessVariable();
            this.getStartFormDefinition(processDefinitionId.currentValue);
            return;
        }
        /** @type {?} */
        var processId = changes['processId'];
        if (processId && processId.currentValue) {
            this.visibilityService.cleanProcessVariable();
            this.loadStartForm(processId.currentValue);
            return;
        }
    };
    /**
     * @param {?} processId
     * @return {?}
     */
    StartFormComponent.prototype.loadStartForm = /**
     * @param {?} processId
     * @return {?}
     */
    function (processId) {
        var _this = this;
        this.formService.getProcessIntance(processId)
            .subscribe(function (instance) {
            _this.formService
                .getStartFormInstance(processId)
                .subscribe(function (form) {
                _this.formName = form.name;
                if (instance.variables) {
                    form.processVariables = instance.variables;
                }
                _this.form = _this.parseForm(form);
                _this.visibilityService.refreshVisibility(_this.form);
                _this.form.validateForm();
                _this.form.readOnly = _this.readOnlyForm;
                _this.onFormLoaded(_this.form);
            }, function (error) { return _this.handleError(error); });
        });
    };
    /**
     * @param {?} processId
     * @return {?}
     */
    StartFormComponent.prototype.getStartFormDefinition = /**
     * @param {?} processId
     * @return {?}
     */
    function (processId) {
        var _this = this;
        this.formService
            .getStartFormDefinition(processId)
            .subscribe(function (form) {
            _this.formName = form.processDefinitionName;
            _this.form = _this.parseForm(form);
            _this.visibilityService.refreshVisibility(_this.form);
            _this.form.validateForm();
            _this.form.readOnly = _this.readOnlyForm;
            _this.onFormLoaded(_this.form);
        }, function (error) { return _this.handleError(error); });
    };
    /** @override */
    /**
     * @override
     * @param {?} outcome
     * @param {?} isFormReadOnly
     * @return {?}
     */
    StartFormComponent.prototype.isOutcomeButtonVisible = /**
     * @override
     * @param {?} outcome
     * @param {?} isFormReadOnly
     * @return {?}
     */
    function (outcome, isFormReadOnly) {
        if (outcome && outcome.isSystem && (outcome.name === FormOutcomeModel.SAVE_ACTION ||
            outcome.name === FormOutcomeModel.COMPLETE_ACTION)) {
            return false;
        }
        else if (outcome && outcome.name === FormOutcomeModel.START_PROCESS_ACTION) {
            return true;
        }
        return _super.prototype.isOutcomeButtonVisible.call(this, outcome, isFormReadOnly);
    };
    /** @override */
    /**
     * @override
     * @return {?}
     */
    StartFormComponent.prototype.saveTaskForm = /**
     * @override
     * @return {?}
     */
    function () {
        // do nothing
    };
    /** @override */
    /**
     * @override
     * @return {?}
     */
    StartFormComponent.prototype.onRefreshClicked = /**
     * @override
     * @return {?}
     */
    function () {
        if (this.processDefinitionId) {
            this.visibilityService.cleanProcessVariable();
            this.getStartFormDefinition(this.processDefinitionId);
        }
        else if (this.processId) {
            this.visibilityService.cleanProcessVariable();
            this.loadStartForm(this.processId);
        }
    };
    /**
     * @param {?=} outcome
     * @return {?}
     */
    StartFormComponent.prototype.completeTaskForm = /**
     * @param {?=} outcome
     * @return {?}
     */
    function (outcome) {
        this.outcomeClick.emit(outcome);
    };
    StartFormComponent.decorators = [
        { type: Component, args: [{
                    selector: 'adf-start-form',
                    template: "<div class=\"adf-start-form-container\" *ngIf=\"hasForm()\">\n    <mat-card>\n        <mat-card-header>\n            <mat-card-title>\n                <h2 *ngIf=\"isTitleEnabled()\" class=\"mdl-card__title-text\">{{form.taskName}}</h2>\n            </mat-card-title>\n        </mat-card-header>\n        <mat-card-content>\n            <div *ngIf=\"form.hasTabs()\">\n                <tabs-widget [tabs]=\"form.tabs\" (formTabChanged)=\"checkVisibility($event);\"></tabs-widget>\n            </div>\n\n            <div *ngIf=\"!form.hasTabs() && form.hasFields()\">\n                <div *ngFor=\"let field of form.fields\">\n                    <adf-form-field [field]=\"field.field\"></adf-form-field>\n                </div>\n            </div>\n        </mat-card-content>\n        <mat-card-content class=\"adf-start-form-actions\" *ngIf=\"showOutcomeButtons && form.hasOutcomes()\"\n                          #outcomesContainer>\n            <ng-content select=\"[form-custom-button]\"></ng-content>\n            <button *ngFor=\"let outcome of form.outcomes\"\n                    mat-button\n                    [attr.data-automation-id]=\"'adf-form-' + outcome.name  | lowercase\"\n                    [disabled]=\"!isOutcomeButtonEnabled(outcome)\"\n                    [class.mdl-button--colored]=\"!outcome.isSystem\"\n                    [class.adf-form-hide-button]=\"!isOutcomeButtonVisible(outcome, form.readOnly)\"\n                    (click)=\"onOutcomeClicked(outcome)\">\n                {{ outcome.name | translate | uppercase}}\n            </button>\n        </mat-card-content>\n        <mat-card-actions *ngIf=\"showRefreshButton\">\n            <button mat-button\n                    (click)=\"onRefreshClicked()\">\n                <mat-icon>refresh</mat-icon>\n            </button>\n        </mat-card-actions>\n    </mat-card>\n</div>\n",
                    encapsulation: ViewEncapsulation.None,
                    styles: [""]
                }] }
    ];
    /** @nocollapse */
    StartFormComponent.ctorParameters = function () { return [
        { type: FormService },
        { type: WidgetVisibilityService }
    ]; };
    StartFormComponent.propDecorators = {
        processDefinitionId: [{ type: Input }],
        processId: [{ type: Input }],
        showOutcomeButtons: [{ type: Input }],
        showRefreshButton: [{ type: Input }],
        readOnlyForm: [{ type: Input }],
        outcomeClick: [{ type: Output }],
        formContentClicked: [{ type: Output }],
        outcomesContainer: [{ type: ViewChild, args: ['outcomesContainer', {},] }]
    };
    return StartFormComponent;
}(FormComponent));
export { StartFormComponent };
if (false) {
    /**
     * Definition ID of the process to start.
     * @type {?}
     */
    StartFormComponent.prototype.processDefinitionId;
    /**
     * Process ID of the process to start.
     * @type {?}
     */
    StartFormComponent.prototype.processId;
    /**
     * Should form outcome buttons be shown?
     * @type {?}
     */
    StartFormComponent.prototype.showOutcomeButtons;
    /**
     * Should the refresh button be shown?
     * @type {?}
     */
    StartFormComponent.prototype.showRefreshButton;
    /**
     * Is the form read-only (ie, can't be edited)?
     * @type {?}
     */
    StartFormComponent.prototype.readOnlyForm;
    /**
     * Emitted when the user clicks one of the outcome buttons that completes the form.
     * @type {?}
     */
    StartFormComponent.prototype.outcomeClick;
    /**
     * Emitted when a field of the form is clicked.
     * @type {?}
     */
    StartFormComponent.prototype.formContentClicked;
    /** @type {?} */
    StartFormComponent.prototype.outcomesContainer;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhcnQtZm9ybS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYWxmcmVzY28vYWRmLWNvcmUvIiwic291cmNlcyI6WyJmb3JtL2NvbXBvbmVudHMvc3RhcnQtZm9ybS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBaUJBLE9BQU8sRUFDSCxTQUFTLEVBQ1QsVUFBVSxFQUNWLFlBQVksRUFDWixLQUFLLEVBR0wsTUFBTSxFQUVOLFNBQVMsRUFDVCxpQkFBaUIsRUFFcEIsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQ3pELE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLHlDQUF5QyxDQUFDO0FBQ2xGLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUVqRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQzs7SUFTaEIsOENBQWE7SUFpQ2pELDRCQUFZLFdBQXdCLEVBQ3hCLGlCQUEwQztRQUR0RCxZQUVJLGtCQUFNLFdBQVcsRUFBRSxpQkFBaUIsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBRXBEOzs7O21DQXpCNkIsSUFBSTs7OztrQ0FJTCxJQUFJOzs7OzZCQUlULEtBQUs7Ozs7NkJBSUssSUFBSSxZQUFZLEVBQU87Ozs7bUNBSUosSUFBSSxZQUFZLEVBQW9CO2tDQUd6RCxJQUFJO1FBS2hDLEtBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDOztLQUMxQjs7OztJQUVELHFDQUFROzs7SUFBUjtRQUFBLGlCQVdDO1FBVkcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQ25CLElBQUksQ0FBQyxXQUFXLENBQUMsa0JBQWtCLENBQUMsU0FBUyxDQUFDLFVBQUEsT0FBTztZQUNqRCxLQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQ3pDLENBQUMsRUFDRixJQUFJLENBQUMsV0FBVyxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsVUFBQyxpQkFBb0M7WUFDekUsSUFBSSxpQkFBaUIsQ0FBQyxXQUFXLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtnQkFDMUMsS0FBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsV0FBVyxDQUFDLENBQUM7YUFDdEQ7U0FDSixDQUFDLENBQ0wsQ0FBQztLQUNMOzs7O0lBRUQsd0NBQVc7OztJQUFYO1FBQ0ksSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsVUFBQSxZQUFZLElBQUksT0FBQSxZQUFZLENBQUMsV0FBVyxFQUFFLEVBQTFCLENBQTBCLENBQUMsQ0FBQztRQUN2RSxJQUFJLENBQUMsYUFBYSxHQUFHLEVBQUUsQ0FBQztLQUMzQjs7Ozs7SUFFRCx3Q0FBVzs7OztJQUFYLFVBQVksT0FBc0I7O1FBQzlCLElBQUksbUJBQW1CLEdBQUcsT0FBTyxDQUFDLHFCQUFxQixDQUFDLENBQUM7UUFDekQsSUFBSSxtQkFBbUIsSUFBSSxtQkFBbUIsQ0FBQyxZQUFZLEVBQUU7WUFDekQsSUFBSSxDQUFDLGlCQUFpQixDQUFDLG9CQUFvQixFQUFFLENBQUM7WUFDOUMsSUFBSSxDQUFDLHNCQUFzQixDQUFDLG1CQUFtQixDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQzlELE9BQU87U0FDVjs7UUFFRCxJQUFJLFNBQVMsR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDckMsSUFBSSxTQUFTLElBQUksU0FBUyxDQUFDLFlBQVksRUFBRTtZQUNyQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztZQUM5QyxJQUFJLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUMzQyxPQUFPO1NBQ1Y7S0FDSjs7Ozs7SUFFRCwwQ0FBYTs7OztJQUFiLFVBQWMsU0FBaUI7UUFBL0IsaUJBb0JDO1FBbkJHLElBQUksQ0FBQyxXQUFXLENBQUMsaUJBQWlCLENBQUMsU0FBUyxDQUFDO2FBQ3hDLFNBQVMsQ0FBQyxVQUFDLFFBQWE7WUFDckIsS0FBSSxDQUFDLFdBQVc7aUJBQ1gsb0JBQW9CLENBQUMsU0FBUyxDQUFDO2lCQUMvQixTQUFTLENBQ04sVUFBQSxJQUFJO2dCQUNBLEtBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztnQkFDMUIsSUFBSSxRQUFRLENBQUMsU0FBUyxFQUFFO29CQUNwQixJQUFJLENBQUMsZ0JBQWdCLEdBQUcsUUFBUSxDQUFDLFNBQVMsQ0FBQztpQkFDOUM7Z0JBQ0QsS0FBSSxDQUFDLElBQUksR0FBRyxLQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNqQyxLQUFJLENBQUMsaUJBQWlCLENBQUMsaUJBQWlCLENBQUMsS0FBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNwRCxLQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO2dCQUN6QixLQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsR0FBRyxLQUFJLENBQUMsWUFBWSxDQUFDO2dCQUN2QyxLQUFJLENBQUMsWUFBWSxDQUFDLEtBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUNoQyxFQUNELFVBQUEsS0FBSyxJQUFJLE9BQUEsS0FBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsRUFBdkIsQ0FBdUIsQ0FDbkMsQ0FBQztTQUNULENBQUMsQ0FBQztLQUNWOzs7OztJQUVELG1EQUFzQjs7OztJQUF0QixVQUF1QixTQUFpQjtRQUF4QyxpQkFjQztRQWJHLElBQUksQ0FBQyxXQUFXO2FBQ1gsc0JBQXNCLENBQUMsU0FBUyxDQUFDO2FBQ2pDLFNBQVMsQ0FDTixVQUFBLElBQUk7WUFDQSxLQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxxQkFBcUIsQ0FBQztZQUMzQyxLQUFJLENBQUMsSUFBSSxHQUFHLEtBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDakMsS0FBSSxDQUFDLGlCQUFpQixDQUFDLGlCQUFpQixDQUFDLEtBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNwRCxLQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1lBQ3pCLEtBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxHQUFHLEtBQUksQ0FBQyxZQUFZLENBQUM7WUFDdkMsS0FBSSxDQUFDLFlBQVksQ0FBQyxLQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDaEMsRUFDRCxVQUFBLEtBQUssSUFBSSxPQUFBLEtBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLEVBQXZCLENBQXVCLENBQ25DLENBQUM7S0FDVDtJQUVELGdCQUFnQjs7Ozs7OztJQUNoQixtREFBc0I7Ozs7OztJQUF0QixVQUF1QixPQUF5QixFQUFFLGNBQXVCO1FBQ3JFLElBQUksT0FBTyxJQUFJLE9BQU8sQ0FBQyxRQUFRLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxLQUFLLGdCQUFnQixDQUFDLFdBQVc7WUFDN0UsT0FBTyxDQUFDLElBQUksS0FBSyxnQkFBZ0IsQ0FBQyxlQUFlLENBQUMsRUFBRTtZQUNwRCxPQUFPLEtBQUssQ0FBQztTQUNoQjthQUFNLElBQUksT0FBTyxJQUFJLE9BQU8sQ0FBQyxJQUFJLEtBQUssZ0JBQWdCLENBQUMsb0JBQW9CLEVBQUU7WUFDMUUsT0FBTyxJQUFJLENBQUM7U0FDZjtRQUNELE9BQU8saUJBQU0sc0JBQXNCLFlBQUMsT0FBTyxFQUFFLGNBQWMsQ0FBQyxDQUFDO0tBQ2hFO0lBRUQsZ0JBQWdCOzs7OztJQUNoQix5Q0FBWTs7OztJQUFaOztLQUVDO0lBRUQsZ0JBQWdCOzs7OztJQUNoQiw2Q0FBZ0I7Ozs7SUFBaEI7UUFDSSxJQUFJLElBQUksQ0FBQyxtQkFBbUIsRUFBRTtZQUMxQixJQUFJLENBQUMsaUJBQWlCLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztZQUM5QyxJQUFJLENBQUMsc0JBQXNCLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLENBQUM7U0FDekQ7YUFBTSxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDdkIsSUFBSSxDQUFDLGlCQUFpQixDQUFDLG9CQUFvQixFQUFFLENBQUM7WUFDOUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7U0FDdEM7S0FDSjs7Ozs7SUFFRCw2Q0FBZ0I7Ozs7SUFBaEIsVUFBaUIsT0FBZ0I7UUFDN0IsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7S0FDbkM7O2dCQWxKSixTQUFTLFNBQUM7b0JBQ1AsUUFBUSxFQUFFLGdCQUFnQjtvQkFDMUIsdzFEQUEwQztvQkFFMUMsYUFBYSxFQUFFLGlCQUFpQixDQUFDLElBQUk7O2lCQUN4Qzs7OztnQkFaUSxXQUFXO2dCQUNYLHVCQUF1Qjs7O3NDQWUzQixLQUFLOzRCQUlMLEtBQUs7cUNBSUwsS0FBSztvQ0FJTCxLQUFLOytCQUlMLEtBQUs7K0JBSUwsTUFBTTtxQ0FJTixNQUFNO29DQUdOLFNBQVMsU0FBQyxtQkFBbUIsRUFBRSxFQUFFOzs2QkF6RXRDO0VBMkN3QyxhQUFhO1NBQXhDLGtCQUFrQiIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE2IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7XG4gICAgQ29tcG9uZW50LFxuICAgIEVsZW1lbnRSZWYsXG4gICAgRXZlbnRFbWl0dGVyLFxuICAgIElucHV0LFxuICAgIE9uQ2hhbmdlcyxcbiAgICBPbkluaXQsXG4gICAgT3V0cHV0LFxuICAgIFNpbXBsZUNoYW5nZXMsXG4gICAgVmlld0NoaWxkLFxuICAgIFZpZXdFbmNhcHN1bGF0aW9uLFxuICAgIE9uRGVzdHJveVxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEZvcm1TZXJ2aWNlIH0gZnJvbSAnLi8uLi9zZXJ2aWNlcy9mb3JtLnNlcnZpY2UnO1xuaW1wb3J0IHsgV2lkZ2V0VmlzaWJpbGl0eVNlcnZpY2UgfSBmcm9tICcuLy4uL3NlcnZpY2VzL3dpZGdldC12aXNpYmlsaXR5LnNlcnZpY2UnO1xuaW1wb3J0IHsgRm9ybUNvbXBvbmVudCB9IGZyb20gJy4vZm9ybS5jb21wb25lbnQnO1xuaW1wb3J0IHsgQ29udGVudExpbmtNb2RlbCB9IGZyb20gJy4vd2lkZ2V0cy9jb3JlL2NvbnRlbnQtbGluay5tb2RlbCc7XG5pbXBvcnQgeyBGb3JtT3V0Y29tZU1vZGVsIH0gZnJvbSAnLi93aWRnZXRzL2NvcmUvaW5kZXgnO1xuaW1wb3J0IHsgVmFsaWRhdGVGb3JtRXZlbnQgfSBmcm9tICcuLy4uL2V2ZW50cy92YWxpZGF0ZS1mb3JtLmV2ZW50JztcblxuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6ICdhZGYtc3RhcnQtZm9ybScsXG4gICAgdGVtcGxhdGVVcmw6ICcuL3N0YXJ0LWZvcm0uY29tcG9uZW50Lmh0bWwnLFxuICAgIHN0eWxlVXJsczogWycuL2Zvcm0uY29tcG9uZW50LnNjc3MnXSxcbiAgICBlbmNhcHN1bGF0aW9uOiBWaWV3RW5jYXBzdWxhdGlvbi5Ob25lXG59KVxuZXhwb3J0IGNsYXNzIFN0YXJ0Rm9ybUNvbXBvbmVudCBleHRlbmRzIEZvcm1Db21wb25lbnQgaW1wbGVtZW50cyBPbkNoYW5nZXMsIE9uSW5pdCwgT25EZXN0cm95IHtcblxuICAgIC8qKiBEZWZpbml0aW9uIElEIG9mIHRoZSBwcm9jZXNzIHRvIHN0YXJ0LiAqL1xuICAgIEBJbnB1dCgpXG4gICAgcHJvY2Vzc0RlZmluaXRpb25JZDogc3RyaW5nO1xuXG4gICAgLyoqIFByb2Nlc3MgSUQgb2YgdGhlIHByb2Nlc3MgdG8gc3RhcnQuICovXG4gICAgQElucHV0KClcbiAgICBwcm9jZXNzSWQ6IHN0cmluZztcblxuICAgIC8qKiBTaG91bGQgZm9ybSBvdXRjb21lIGJ1dHRvbnMgYmUgc2hvd24/ICovXG4gICAgQElucHV0KClcbiAgICBzaG93T3V0Y29tZUJ1dHRvbnM6IGJvb2xlYW4gPSB0cnVlO1xuXG4gICAgLyoqIFNob3VsZCB0aGUgcmVmcmVzaCBidXR0b24gYmUgc2hvd24/ICovXG4gICAgQElucHV0KClcbiAgICBzaG93UmVmcmVzaEJ1dHRvbjogYm9vbGVhbiA9IHRydWU7XG5cbiAgICAvKiogSXMgdGhlIGZvcm0gcmVhZC1vbmx5IChpZSwgY2FuJ3QgYmUgZWRpdGVkKT8gKi9cbiAgICBASW5wdXQoKVxuICAgIHJlYWRPbmx5Rm9ybTogYm9vbGVhbiA9IGZhbHNlO1xuXG4gICAgLyoqIEVtaXR0ZWQgd2hlbiB0aGUgdXNlciBjbGlja3Mgb25lIG9mIHRoZSBvdXRjb21lIGJ1dHRvbnMgdGhhdCBjb21wbGV0ZXMgdGhlIGZvcm0uICovXG4gICAgQE91dHB1dCgpXG4gICAgb3V0Y29tZUNsaWNrOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gICAgLyoqIEVtaXR0ZWQgd2hlbiBhIGZpZWxkIG9mIHRoZSBmb3JtIGlzIGNsaWNrZWQuICovXG4gICAgQE91dHB1dCgpXG4gICAgZm9ybUNvbnRlbnRDbGlja2VkOiBFdmVudEVtaXR0ZXI8Q29udGVudExpbmtNb2RlbD4gPSBuZXcgRXZlbnRFbWl0dGVyPENvbnRlbnRMaW5rTW9kZWw+KCk7XG5cbiAgICBAVmlld0NoaWxkKCdvdXRjb21lc0NvbnRhaW5lcicsIHt9KVxuICAgIG91dGNvbWVzQ29udGFpbmVyOiBFbGVtZW50UmVmID0gbnVsbDtcblxuICAgIGNvbnN0cnVjdG9yKGZvcm1TZXJ2aWNlOiBGb3JtU2VydmljZSxcbiAgICAgICAgICAgICAgICB2aXNpYmlsaXR5U2VydmljZTogV2lkZ2V0VmlzaWJpbGl0eVNlcnZpY2UpIHtcbiAgICAgICAgc3VwZXIoZm9ybVNlcnZpY2UsIHZpc2liaWxpdHlTZXJ2aWNlLCBudWxsLCBudWxsKTtcbiAgICAgICAgdGhpcy5zaG93VGl0bGUgPSBmYWxzZTtcbiAgICB9XG5cbiAgICBuZ09uSW5pdCgpIHtcbiAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25zLnB1c2goXG4gICAgICAgICAgICB0aGlzLmZvcm1TZXJ2aWNlLmZvcm1Db250ZW50Q2xpY2tlZC5zdWJzY3JpYmUoY29udGVudCA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5mb3JtQ29udGVudENsaWNrZWQuZW1pdChjb250ZW50KTtcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgdGhpcy5mb3JtU2VydmljZS52YWxpZGF0ZUZvcm0uc3Vic2NyaWJlKCh2YWxpZGF0ZUZvcm1FdmVudDogVmFsaWRhdGVGb3JtRXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAodmFsaWRhdGVGb3JtRXZlbnQuZXJyb3JzRmllbGQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmZvcm1FcnJvci5uZXh0KHZhbGlkYXRlRm9ybUV2ZW50LmVycm9yc0ZpZWxkKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgIH1cblxuICAgIG5nT25EZXN0cm95KCkge1xuICAgICAgICB0aGlzLnN1YnNjcmlwdGlvbnMuZm9yRWFjaChzdWJzY3JpcHRpb24gPT4gc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCkpO1xuICAgICAgICB0aGlzLnN1YnNjcmlwdGlvbnMgPSBbXTtcbiAgICB9XG5cbiAgICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XG4gICAgICAgIGxldCBwcm9jZXNzRGVmaW5pdGlvbklkID0gY2hhbmdlc1sncHJvY2Vzc0RlZmluaXRpb25JZCddO1xuICAgICAgICBpZiAocHJvY2Vzc0RlZmluaXRpb25JZCAmJiBwcm9jZXNzRGVmaW5pdGlvbklkLmN1cnJlbnRWYWx1ZSkge1xuICAgICAgICAgICAgdGhpcy52aXNpYmlsaXR5U2VydmljZS5jbGVhblByb2Nlc3NWYXJpYWJsZSgpO1xuICAgICAgICAgICAgdGhpcy5nZXRTdGFydEZvcm1EZWZpbml0aW9uKHByb2Nlc3NEZWZpbml0aW9uSWQuY3VycmVudFZhbHVlKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBwcm9jZXNzSWQgPSBjaGFuZ2VzWydwcm9jZXNzSWQnXTtcbiAgICAgICAgaWYgKHByb2Nlc3NJZCAmJiBwcm9jZXNzSWQuY3VycmVudFZhbHVlKSB7XG4gICAgICAgICAgICB0aGlzLnZpc2liaWxpdHlTZXJ2aWNlLmNsZWFuUHJvY2Vzc1ZhcmlhYmxlKCk7XG4gICAgICAgICAgICB0aGlzLmxvYWRTdGFydEZvcm0ocHJvY2Vzc0lkLmN1cnJlbnRWYWx1ZSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBsb2FkU3RhcnRGb3JtKHByb2Nlc3NJZDogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMuZm9ybVNlcnZpY2UuZ2V0UHJvY2Vzc0ludGFuY2UocHJvY2Vzc0lkKVxuICAgICAgICAgICAgLnN1YnNjcmliZSgoaW5zdGFuY2U6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuZm9ybVNlcnZpY2VcbiAgICAgICAgICAgICAgICAgICAgLmdldFN0YXJ0Rm9ybUluc3RhbmNlKHByb2Nlc3NJZClcbiAgICAgICAgICAgICAgICAgICAgLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvcm0gPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZm9ybU5hbWUgPSBmb3JtLm5hbWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnZhcmlhYmxlcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtLnByb2Nlc3NWYXJpYWJsZXMgPSBpbnN0YW5jZS52YXJpYWJsZXM7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZm9ybSA9IHRoaXMucGFyc2VGb3JtKGZvcm0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmlzaWJpbGl0eVNlcnZpY2UucmVmcmVzaFZpc2liaWxpdHkodGhpcy5mb3JtKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmZvcm0udmFsaWRhdGVGb3JtKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5mb3JtLnJlYWRPbmx5ID0gdGhpcy5yZWFkT25seUZvcm07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vbkZvcm1Mb2FkZWQodGhpcy5mb3JtKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICBlcnJvciA9PiB0aGlzLmhhbmRsZUVycm9yKGVycm9yKVxuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZ2V0U3RhcnRGb3JtRGVmaW5pdGlvbihwcm9jZXNzSWQ6IHN0cmluZykge1xuICAgICAgICB0aGlzLmZvcm1TZXJ2aWNlXG4gICAgICAgICAgICAuZ2V0U3RhcnRGb3JtRGVmaW5pdGlvbihwcm9jZXNzSWQpXG4gICAgICAgICAgICAuc3Vic2NyaWJlKFxuICAgICAgICAgICAgICAgIGZvcm0gPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmZvcm1OYW1lID0gZm9ybS5wcm9jZXNzRGVmaW5pdGlvbk5hbWU7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZm9ybSA9IHRoaXMucGFyc2VGb3JtKGZvcm0pO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnZpc2liaWxpdHlTZXJ2aWNlLnJlZnJlc2hWaXNpYmlsaXR5KHRoaXMuZm9ybSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZm9ybS52YWxpZGF0ZUZvcm0oKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5mb3JtLnJlYWRPbmx5ID0gdGhpcy5yZWFkT25seUZvcm07XG4gICAgICAgICAgICAgICAgICAgIHRoaXMub25Gb3JtTG9hZGVkKHRoaXMuZm9ybSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBlcnJvciA9PiB0aGlzLmhhbmRsZUVycm9yKGVycm9yKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKiogQG92ZXJyaWRlICovXG4gICAgaXNPdXRjb21lQnV0dG9uVmlzaWJsZShvdXRjb21lOiBGb3JtT3V0Y29tZU1vZGVsLCBpc0Zvcm1SZWFkT25seTogYm9vbGVhbik6IGJvb2xlYW4ge1xuICAgICAgICBpZiAob3V0Y29tZSAmJiBvdXRjb21lLmlzU3lzdGVtICYmIChvdXRjb21lLm5hbWUgPT09IEZvcm1PdXRjb21lTW9kZWwuU0FWRV9BQ1RJT04gfHxcbiAgICAgICAgICAgIG91dGNvbWUubmFtZSA9PT0gRm9ybU91dGNvbWVNb2RlbC5DT01QTEVURV9BQ1RJT04pKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0gZWxzZSBpZiAob3V0Y29tZSAmJiBvdXRjb21lLm5hbWUgPT09IEZvcm1PdXRjb21lTW9kZWwuU1RBUlRfUFJPQ0VTU19BQ1RJT04pIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBzdXBlci5pc091dGNvbWVCdXR0b25WaXNpYmxlKG91dGNvbWUsIGlzRm9ybVJlYWRPbmx5KTtcbiAgICB9XG5cbiAgICAvKiogQG92ZXJyaWRlICovXG4gICAgc2F2ZVRhc2tGb3JtKCkge1xuICAgICAgICAvLyBkbyBub3RoaW5nXG4gICAgfVxuXG4gICAgLyoqIEBvdmVycmlkZSAqL1xuICAgIG9uUmVmcmVzaENsaWNrZWQoKSB7XG4gICAgICAgIGlmICh0aGlzLnByb2Nlc3NEZWZpbml0aW9uSWQpIHtcbiAgICAgICAgICAgIHRoaXMudmlzaWJpbGl0eVNlcnZpY2UuY2xlYW5Qcm9jZXNzVmFyaWFibGUoKTtcbiAgICAgICAgICAgIHRoaXMuZ2V0U3RhcnRGb3JtRGVmaW5pdGlvbih0aGlzLnByb2Nlc3NEZWZpbml0aW9uSWQpO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMucHJvY2Vzc0lkKSB7XG4gICAgICAgICAgICB0aGlzLnZpc2liaWxpdHlTZXJ2aWNlLmNsZWFuUHJvY2Vzc1ZhcmlhYmxlKCk7XG4gICAgICAgICAgICB0aGlzLmxvYWRTdGFydEZvcm0odGhpcy5wcm9jZXNzSWQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgY29tcGxldGVUYXNrRm9ybShvdXRjb21lPzogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMub3V0Y29tZUNsaWNrLmVtaXQob3V0Y29tZSk7XG4gICAgfVxufVxuIl19