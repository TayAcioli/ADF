/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
/*!
 * @license
 * Copyright 2016 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { Compiler, Component, ComponentFactoryResolver, Input, NgModule, ViewChild, ViewContainerRef, ViewEncapsulation } from '@angular/core';
import { FormRenderingService } from './../../services/form-rendering.service';
import { WidgetVisibilityService } from './../../services/widget-visibility.service';
import { FormFieldModel } from './../widgets/core/form-field.model';
var FormFieldComponent = /** @class */ (function () {
    function FormFieldComponent(formRenderingService, componentFactoryResolver, visibilityService, compiler) {
        this.formRenderingService = formRenderingService;
        this.componentFactoryResolver = componentFactoryResolver;
        this.visibilityService = visibilityService;
        this.compiler = compiler;
        /**
         * Contains all the necessary data needed to determine what UI Widget
         * to use when rendering the field in the form. You would typically not
         * create this data manually but instead create the form in APS and export
         * it to get to all the `FormFieldModel` definitions.
         */
        this.field = null;
        this.focus = false;
    }
    /**
     * @return {?}
     */
    FormFieldComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var w = window;
        if (w.adf === undefined) {
            w.adf = {};
        }
        /** @type {?} */
        var originalField = this.getField();
        if (originalField) {
            /** @type {?} */
            var customTemplate = this.field.form.customFieldTemplates[originalField.type];
            if (customTemplate && this.hasController(originalField.type)) {
                /** @type {?} */
                var factory = this.getComponentFactorySync(originalField.type, customTemplate);
                this.componentRef = this.container.createComponent(factory);
                /** @type {?} */
                var instance = this.componentRef.instance;
                if (instance) {
                    instance.field = originalField;
                }
            }
            else {
                /** @type {?} */
                var componentType = this.formRenderingService.resolveComponentType(originalField);
                if (componentType) {
                    /** @type {?} */
                    var factory = this.componentFactoryResolver.resolveComponentFactory(componentType);
                    this.componentRef = this.container.createComponent(factory);
                    /** @type {?} */
                    var instance = /** @type {?} */ (this.componentRef.instance);
                    instance.field = this.field;
                    instance.fieldChanged.subscribe(function (field) {
                        if (field && _this.field.form) {
                            _this.visibilityService.refreshVisibility(field.form);
                            field.form.onFormFieldChanged(field);
                        }
                    });
                }
            }
        }
    };
    /**
     * @return {?}
     */
    FormFieldComponent.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        if (this.componentRef) {
            this.componentRef.destroy();
            this.componentRef = null;
        }
    };
    /**
     * @return {?}
     */
    FormFieldComponent.prototype.getField = /**
     * @return {?}
     */
    function () {
        if (this.field && this.field.params) {
            /** @type {?} */
            var wrappedField = this.field.params["field"];
            if (wrappedField && wrappedField.type) {
                return wrappedField;
            }
        }
        return this.field;
    };
    /**
     * @param {?} type
     * @return {?}
     */
    FormFieldComponent.prototype.hasController = /**
     * @param {?} type
     * @return {?}
     */
    function (type) {
        return (adf && adf.components && adf.components[type]);
    };
    /**
     * @param {?} type
     * @param {?} template
     * @return {?}
     */
    FormFieldComponent.prototype.getComponentFactorySync = /**
     * @param {?} type
     * @param {?} template
     * @return {?}
     */
    function (type, template) {
        /** @type {?} */
        var componentInfo = adf.components[type];
        if (componentInfo.factory) {
            return componentInfo.factory;
        }
        /** @type {?} */
        var metadata = {
            selector: "runtime-component-" + type,
            template: template
        };
        /** @type {?} */
        var factory = this.createComponentFactorySync(this.compiler, metadata, componentInfo.class);
        componentInfo.factory = factory;
        return factory;
    };
    /**
     * @param {?} compiler
     * @param {?} metadata
     * @param {?} componentClass
     * @return {?}
     */
    FormFieldComponent.prototype.createComponentFactorySync = /**
     * @param {?} compiler
     * @param {?} metadata
     * @param {?} componentClass
     * @return {?}
     */
    function (compiler, metadata, componentClass) {
        /** @type {?} */
        var cmpClass = componentClass || /** @class */ (function () {
            function RuntimeComponent() {
            }
            return RuntimeComponent;
        }());
        /** @type {?} */
        var decoratedCmp = Component(metadata)(cmpClass);
        var RuntimeComponentModule = /** @class */ (function () {
            function RuntimeComponentModule() {
            }
            RuntimeComponentModule.decorators = [
                { type: NgModule, args: [{ imports: [], declarations: [decoratedCmp] },] },
            ];
            return RuntimeComponentModule;
        }());
        /** @type {?} */
        var module = compiler.compileModuleAndAllComponentsSync(RuntimeComponentModule);
        return module.componentFactories.find(function (x) { return x.componentType === decoratedCmp; });
    };
    /**
     * @return {?}
     */
    FormFieldComponent.prototype.focusToggle = /**
     * @return {?}
     */
    function () {
        this.focus = !this.focus;
    };
    FormFieldComponent.decorators = [
        { type: Component, args: [{
                    selector: 'adf-form-field',
                    template: "\n        <div [id]=\"'field-'+field?.id+'-container'\"\n            [hidden]=\"!field?.isVisible\"\n            [class.adf-focus]=\"focus\"\n            (focusin)=\"focusToggle()\"\n            (focusout)=\"focusToggle()\">\n            <div #container></div>\n        </div>\n    ",
                    encapsulation: ViewEncapsulation.None
                }] }
    ];
    /** @nocollapse */
    FormFieldComponent.ctorParameters = function () { return [
        { type: FormRenderingService },
        { type: ComponentFactoryResolver },
        { type: WidgetVisibilityService },
        { type: Compiler }
    ]; };
    FormFieldComponent.propDecorators = {
        container: [{ type: ViewChild, args: ['container', { read: ViewContainerRef },] }],
        field: [{ type: Input }]
    };
    return FormFieldComponent;
}());
export { FormFieldComponent };
if (false) {
    /** @type {?} */
    FormFieldComponent.prototype.container;
    /**
     * Contains all the necessary data needed to determine what UI Widget
     * to use when rendering the field in the form. You would typically not
     * create this data manually but instead create the form in APS and export
     * it to get to all the `FormFieldModel` definitions.
     * @type {?}
     */
    FormFieldComponent.prototype.field;
    /** @type {?} */
    FormFieldComponent.prototype.componentRef;
    /** @type {?} */
    FormFieldComponent.prototype.focus;
    /** @type {?} */
    FormFieldComponent.prototype.formRenderingService;
    /** @type {?} */
    FormFieldComponent.prototype.componentFactoryResolver;
    /** @type {?} */
    FormFieldComponent.prototype.visibilityService;
    /** @type {?} */
    FormFieldComponent.prototype.compiler;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS1maWVsZC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYWxmcmVzY28vYWRmLWNvcmUvIiwic291cmNlcyI6WyJmb3JtL2NvbXBvbmVudHMvZm9ybS1maWVsZC9mb3JtLWZpZWxkLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQWlCQSxPQUFPLEVBQ0gsUUFBUSxFQUNSLFNBQVMsRUFDVCx3QkFBd0IsRUFFeEIsS0FBSyxFQUVMLFFBQVEsRUFHUixTQUFTLEVBQ1QsZ0JBQWdCLEVBQ2hCLGlCQUFpQixFQUNwQixNQUFNLGVBQWUsQ0FBQztBQUV2QixPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSx5Q0FBeUMsQ0FBQztBQUMvRSxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSw0Q0FBNEMsQ0FBQztBQUNyRixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sb0NBQW9DLENBQUM7O0lBbUNoRSw0QkFBb0Isb0JBQTBDLEVBQzFDLDBCQUNBLG1CQUNBO1FBSEEseUJBQW9CLEdBQXBCLG9CQUFvQixDQUFzQjtRQUMxQyw2QkFBd0IsR0FBeEIsd0JBQXdCO1FBQ3hCLHNCQUFpQixHQUFqQixpQkFBaUI7UUFDakIsYUFBUSxHQUFSLFFBQVE7Ozs7Ozs7cUJBVEosSUFBSTtxQkFJWCxLQUFLO0tBTXJCOzs7O0lBRUQscUNBQVE7OztJQUFSO1FBQUEsaUJBK0JDOztRQTlCRyxJQUFNLENBQUMsR0FBUSxNQUFNLENBQUM7UUFDdEIsSUFBSSxDQUFDLENBQUMsR0FBRyxLQUFLLFNBQVMsRUFBRTtZQUNyQixDQUFDLENBQUMsR0FBRyxHQUFHLEVBQUUsQ0FBQztTQUNkOztRQUNELElBQUksYUFBYSxHQUFHLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNwQyxJQUFJLGFBQWEsRUFBRTs7WUFDZixJQUFJLGNBQWMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FB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ZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQge1xuICAgIENvbXBpbGVyLFxuICAgIENvbXBvbmVudCwgQ29tcG9uZW50RmFjdG9yeSxcbiAgICBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gICAgQ29tcG9uZW50UmVmLFxuICAgIElucHV0LFxuICAgIE1vZHVsZVdpdGhDb21wb25lbnRGYWN0b3JpZXMsXG4gICAgTmdNb2R1bGUsXG4gICAgT25EZXN0cm95LFxuICAgIE9uSW5pdCxcbiAgICBWaWV3Q2hpbGQsXG4gICAgVmlld0NvbnRhaW5lclJlZixcbiAgICBWaWV3RW5jYXBzdWxhdGlvblxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgRm9ybVJlbmRlcmluZ1NlcnZpY2UgfSBmcm9tICcuLy4uLy4uL3NlcnZpY2VzL2Zvcm0tcmVuZGVyaW5nLnNlcnZpY2UnO1xuaW1wb3J0IHsgV2lkZ2V0VmlzaWJpbGl0eVNlcnZpY2UgfSBmcm9tICcuLy4uLy4uL3NlcnZpY2VzL3dpZGdldC12aXNpYmlsaXR5LnNlcnZpY2UnO1xuaW1wb3J0IHsgRm9ybUZpZWxkTW9kZWwgfSBmcm9tICcuLy4uL3dpZGdldHMvY29yZS9mb3JtLWZpZWxkLm1vZGVsJztcbmltcG9ydCB7IFdpZGdldENvbXBvbmVudCB9IGZyb20gJy4vLi4vd2lkZ2V0cy93aWRnZXQuY29tcG9uZW50JztcblxuZGVjbGFyZSB2YXIgYWRmOiBhbnk7XG5cbkBDb21wb25lbnQoe1xuICAgIHNlbGVjdG9yOiAnYWRmLWZvcm0tZmllbGQnLFxuICAgIHRlbXBsYXRlOiBgXG4gICAgICAgIDxkaXYgW2lkXT1cIidmaWVsZC0nK2ZpZWxkPy5pZCsnLWNvbnRhaW5lcidcIlxuICAgICAgICAgICAgW2hpZGRlbl09XCIhZmllbGQ/LmlzVmlzaWJsZVwiXG4gICAgICAgICAgICBbY2xhc3MuYWRmLWZvY3VzXT1cImZvY3VzXCJcbiAgICAgICAgICAgIChmb2N1c2luKT1cImZvY3VzVG9nZ2xlKClcIlxuICAgICAgICAgICAgKGZvY3Vzb3V0KT1cImZvY3VzVG9nZ2xlKClcIj5cbiAgICAgICAgICAgIDxkaXYgI2NvbnRhaW5lcj48L2Rpdj5cbiAgICAgICAgPC9kaXY+XG4gICAgYCxcbiAgICBlbmNhcHN1bGF0aW9uOiBWaWV3RW5jYXBzdWxhdGlvbi5Ob25lXG59KVxuZXhwb3J0IGNsYXNzIEZvcm1GaWVsZENvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcblxuICAgIEBWaWV3Q2hpbGQoJ2NvbnRhaW5lcicsIHsgcmVhZDogVmlld0NvbnRhaW5lclJlZiB9KVxuICAgIGNvbnRhaW5lcjogVmlld0NvbnRhaW5lclJlZjtcblxuICAgIC8qKiBDb250YWlucyBhbGwgdGhlIG5lY2Vzc2FyeSBkYXRhIG5lZWRlZCB0byBkZXRlcm1pbmUgd2hhdCBVSSBXaWRnZXRcbiAgICAgKiB0byB1c2Ugd2hlbiByZW5kZXJpbmcgdGhlIGZpZWxkIGluIHRoZSBmb3JtLiBZb3Ugd291bGQgdHlwaWNhbGx5IG5vdFxuICAgICAqIGNyZWF0ZSB0aGlzIGRhdGEgbWFudWFsbHkgYnV0IGluc3RlYWQgY3JlYXRlIHRoZSBmb3JtIGluIEFQUyBhbmQgZXhwb3J0XG4gICAgICogaXQgdG8gZ2V0IHRvIGFsbCB0aGUgYEZvcm1GaWVsZE1vZGVsYCBkZWZpbml0aW9ucy5cbiAgICAgKi9cbiAgICBASW5wdXQoKVxuICAgIGZpZWxkOiBGb3JtRmllbGRNb2RlbCA9IG51bGw7XG5cbiAgICBjb21wb25lbnRSZWY6IENvbXBvbmVudFJlZjx7fT47XG5cbiAgICBmb2N1czogYm9vbGVhbiA9IGZhbHNlO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBmb3JtUmVuZGVyaW5nU2VydmljZTogRm9ybVJlbmRlcmluZ1NlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBjb21wb25lbnRGYWN0b3J5UmVzb2x2ZXI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcbiAgICAgICAgICAgICAgICBwcml2YXRlIHZpc2liaWxpdHlTZXJ2aWNlOiBXaWRnZXRWaXNpYmlsaXR5U2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIGNvbXBpbGVyOiBDb21waWxlcikge1xuICAgIH1cblxuICAgIG5nT25Jbml0KCkge1xuICAgICAgICBjb25zdCB3OiBhbnkgPSB3aW5kb3c7XG4gICAgICAgIGlmICh3LmFkZiA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB3LmFkZiA9IHt9O1xuICAgICAgICB9XG4gICAgICAgIGxldCBvcmlnaW5hbEZpZWxkID0gdGhpcy5nZXRGaWVsZCgpO1xuICAgICAgICBpZiAob3JpZ2luYWxGaWVsZCkge1xuICAgICAgICAgICAgbGV0IGN1c3RvbVRlbXBsYXRlID0gdGhpcy5maWVsZC5mb3JtLmN1c3RvbUZpZWxkVGVtcGxhdGVzW29yaWdpbmFsRmllbGQudHlwZV07XG4gICAgICAgICAgICBpZiAoY3VzdG9tVGVtcGxhdGUgJiYgdGhpcy5oYXNDb250cm9sbGVyKG9yaWdpbmFsRmllbGQudHlwZSkpIHtcbiAgICAgICAgICAgICAgICBsZXQgZmFjdG9yeSA9IHRoaXMuZ2V0Q29tcG9uZW50RmFjdG9yeVN5bmMob3JpZ2luYWxGaWVsZC50eXBlLCBjdXN0b21UZW1wbGF0ZSk7XG4gICAgICAgICAgICAgICAgdGhpcy5jb21wb25lbnRSZWYgPSB0aGlzLmNvbnRhaW5lci5jcmVhdGVDb21wb25lbnQoZmFjdG9yeSk7XG4gICAgICAgICAgICAgICAgbGV0IGluc3RhbmNlOiBhbnkgPSB0aGlzLmNvbXBvbmVudFJlZi5pbnN0YW5jZTtcbiAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuZmllbGQgPSBvcmlnaW5hbEZpZWxkO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgbGV0IGNvbXBvbmVudFR5cGUgPSB0aGlzLmZvcm1SZW5kZXJpbmdTZXJ2aWNlLnJlc29sdmVDb21wb25lbnRUeXBlKG9yaWdpbmFsRmllbGQpO1xuICAgICAgICAgICAgICAgIGlmIChjb21wb25lbnRUeXBlKSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBmYWN0b3J5ID0gdGhpcy5jb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoY29tcG9uZW50VHlwZSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY29tcG9uZW50UmVmID0gdGhpcy5jb250YWluZXIuY3JlYXRlQ29tcG9uZW50KGZhY3RvcnkpO1xuICAgICAgICAgICAgICAgICAgICBsZXQgaW5zdGFuY2UgPSA8V2lkZ2V0Q29tcG9uZW50PiB0aGlzLmNvbXBvbmVudFJlZi5pbnN0YW5jZTtcbiAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuZmllbGQgPSB0aGlzLmZpZWxkO1xuICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZS5maWVsZENoYW5nZWQuc3Vic2NyaWJlKGZpZWxkID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmaWVsZCAmJiB0aGlzLmZpZWxkLmZvcm0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZpc2liaWxpdHlTZXJ2aWNlLnJlZnJlc2hWaXNpYmlsaXR5KGZpZWxkLmZvcm0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkLmZvcm0ub25Gb3JtRmllbGRDaGFuZ2VkKGZpZWxkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgbmdPbkRlc3Ryb3koKSB7XG4gICAgICAgIGlmICh0aGlzLmNvbXBvbmVudFJlZikge1xuICAgICAgICAgICAgdGhpcy5jb21wb25lbnRSZWYuZGVzdHJveSgpO1xuICAgICAgICAgICAgdGhpcy5jb21wb25lbnRSZWYgPSBudWxsO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRGaWVsZCgpOiBGb3JtRmllbGRNb2RlbCB7XG4gICAgICAgIGlmICh0aGlzLmZpZWxkICYmIHRoaXMuZmllbGQucGFyYW1zKSB7XG4gICAgICAgICAgICBjb25zdCB3cmFwcGVkRmllbGQgPSB0aGlzLmZpZWxkLnBhcmFtcy5maWVsZDtcbiAgICAgICAgICAgIGlmICh3cmFwcGVkRmllbGQgJiYgd3JhcHBlZEZpZWxkLnR5cGUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gd3JhcHBlZEZpZWxkO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLmZpZWxkO1xuICAgIH1cblxuICAgIHByaXZhdGUgaGFzQ29udHJvbGxlcih0eXBlOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIChhZGYgJiYgYWRmLmNvbXBvbmVudHMgJiYgYWRmLmNvbXBvbmVudHNbdHlwZV0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0Q29tcG9uZW50RmFjdG9yeVN5bmModHlwZTogc3RyaW5nLCB0ZW1wbGF0ZTogc3RyaW5nKTogQ29tcG9uZW50RmFjdG9yeTxhbnk+IHtcbiAgICAgICAgbGV0IGNvbXBvbmVudEluZm8gPSBhZGYuY29tcG9uZW50c1t0eXBlXTtcblxuICAgICAgICBpZiAoY29tcG9uZW50SW5mby5mYWN0b3J5KSB7XG4gICAgICAgICAgICByZXR1cm4gY29tcG9uZW50SW5mby5mYWN0b3J5O1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IG1ldGFkYXRhID0ge1xuICAgICAgICAgICAgc2VsZWN0b3I6IGBydW50aW1lLWNvbXBvbmVudC0ke3R5cGV9YCxcbiAgICAgICAgICAgIHRlbXBsYXRlOiB0ZW1wbGF0ZVxuICAgICAgICB9O1xuXG4gICAgICAgIGxldCBmYWN0b3J5ID0gdGhpcy5jcmVhdGVDb21wb25lbnRGYWN0b3J5U3luYyh0aGlzLmNvbXBpbGVyLCBtZXRhZGF0YSwgY29tcG9uZW50SW5mby5jbGFzcyk7XG4gICAgICAgIGNvbXBvbmVudEluZm8uZmFjdG9yeSA9IGZhY3Rvcnk7XG4gICAgICAgIHJldHVybiBmYWN0b3J5O1xuICAgIH1cblxuICAgIHByaXZhdGUgY3JlYXRlQ29tcG9uZW50RmFjdG9yeVN5bmMoY29tcGlsZXI6IENvbXBpbGVyLCBtZXRhZGF0YTogQ29tcG9uZW50LCBjb21wb25lbnRDbGFzczogYW55KTogQ29tcG9uZW50RmFjdG9yeTxhbnk+IHtcbiAgICAgICAgY29uc3QgY21wQ2xhc3MgPSBjb21wb25lbnRDbGFzcyB8fCBjbGFzcyBSdW50aW1lQ29tcG9uZW50IHtcbiAgICAgICAgfTtcbiAgICAgICAgY29uc3QgZGVjb3JhdGVkQ21wID0gQ29tcG9uZW50KG1ldGFkYXRhKShjbXBDbGFzcyk7XG5cbiAgICAgICAgQE5nTW9kdWxlKHsgaW1wb3J0czogW10sIGRlY2xhcmF0aW9uczogW2RlY29yYXRlZENtcF0gfSlcbiAgICAgICAgY2xhc3MgUnVudGltZUNvbXBvbmVudE1vZHVsZSB7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgbW9kdWxlOiBNb2R1bGVXaXRoQ29tcG9uZW50RmFjdG9yaWVzPGFueT4gPSBjb21waWxlci5jb21waWxlTW9kdWxlQW5kQWxsQ29tcG9uZW50c1N5bmMoUnVudGltZUNvbXBvbmVudE1vZHVsZSk7XG4gICAgICAgIHJldHVybiBtb2R1bGUuY29tcG9uZW50RmFjdG9yaWVzLmZpbmQoeCA9PiB4LmNvbXBvbmVudFR5cGUgPT09IGRlY29yYXRlZENtcCk7XG4gICAgfVxuXG4gICAgZm9jdXNUb2dnbGUoKSB7XG4gICAgICAgIHRoaXMuZm9jdXMgPSAhdGhpcy5mb2N1cztcbiAgICB9XG59XG4iXX0=