/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
/*!
 * @license
 * Copyright 2016 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { FormFieldEvent } from './../../../events/form-field.event';
import { ValidateFormFieldEvent } from './../../../events/validate-form-field.event';
import { ValidateFormEvent } from './../../../events/validate-form.event';
import { ContainerModel } from './container.model';
import { FormFieldTypes } from './form-field-types';
import { FormFieldModel } from './form-field.model';
import { FormOutcomeModel } from './form-outcome.model';
import { TabModel } from './tab.model';
import { FORM_FIELD_VALIDATORS } from './form-field-validator';
export class FormModel {
    /**
     * @param {?=} json
     * @param {?=} data
     * @param {?=} readOnly
     * @param {?=} formService
     */
    constructor(json, data, readOnly = false, formService) {
        this.formService = formService;
        this.taskName = FormModel.UNSET_TASK_NAME;
        this._isValid = true;
        this.readOnly = false;
        this.tabs = [];
        /**
         * Stores root containers
         */
        this.fields = [];
        this.outcomes = [];
        this.customFieldTemplates = {};
        this.fieldValidators = [...FORM_FIELD_VALIDATORS];
        this.values = {};
        this.readOnly = readOnly;
        if (json) {
            this.json = json;
            this.id = json.id;
            this.name = json.name;
            this.taskId = json.taskId;
            this.taskName = json.taskName || json.name || FormModel.UNSET_TASK_NAME;
            this.processDefinitionId = json.processDefinitionId;
            this.customFieldTemplates = json.customFieldTemplates || {};
            this.selectedOutcome = json.selectedOutcome || {};
            this.className = json.className || '';
            /** @type {?} */
            let tabCache = {};
            this.processVariables = json.processVariables;
            this.tabs = (json.tabs || []).map(t => {
                /** @type {?} */
                let model = new TabModel(this, t);
                tabCache[model.id] = model;
                return model;
            });
            this.fields = this.parseRootFields(json);
            if (data) {
                this.loadData(data);
            }
            for (let i = 0; i < this.fields.length; i++) {
                /** @type {?} */
                let field = this.fields[i];
                if (field.tab) {
                    /** @type {?} */
                    let tab = tabCache[field.tab];
                    if (tab) {
                        tab.fields.push(field);
                    }
                }
            }
            if (json.fields) {
                /** @type {?} */
                let saveOutcome = new FormOutcomeModel(this, {
                    id: FormModel.SAVE_OUTCOME,
                    name: 'Save',
                    isSystem: true
                });
                /** @type {?} */
                let completeOutcome = new FormOutcomeModel(this, {
                    id: FormModel.COMPLETE_OUTCOME,
                    name: 'Complete',
                    isSystem: true
                });
                /** @type {?} */
                let startProcessOutcome = new FormOutcomeModel(this, {
                    id: FormModel.START_PROCESS_OUTCOME,
                    name: 'Start Process',
                    isSystem: true
                });
                /** @type {?} */
                let customOutcomes = (json.outcomes || []).map(obj => new FormOutcomeModel(this, obj));
                this.outcomes = [saveOutcome].concat(customOutcomes.length > 0 ? customOutcomes : [completeOutcome, startProcessOutcome]);
            }
        }
        this.validateForm();
    }
    /**
     * @return {?}
     */
    get isValid() {
        return this._isValid;
    }
    /**
     * @return {?}
     */
    hasTabs() {
        return this.tabs && this.tabs.length > 0;
    }
    /**
     * @return {?}
     */
    hasFields() {
        return this.fields && this.fields.length > 0;
    }
    /**
     * @return {?}
     */
    hasOutcomes() {
        return this.outcomes && this.outcomes.length > 0;
    }
    /**
     * @param {?} field
     * @return {?}
     */
    onFormFieldChanged(field) {
        this.validateField(field);
        if (this.formService) {
            this.formService.formFieldValueChanged.next(new FormFieldEvent(this, field));
        }
    }
    /**
     * @param {?} fieldId
     * @return {?}
     */
    getFieldById(fieldId) {
        return this.getFormFields().find(field => field.id === fieldId);
    }
    /**
     * @return {?}
     */
    getFormFields() {
        /** @type {?} */
        let result = [];
        for (let i = 0; i < this.fields.length; i++) {
            /** @type {?} */
            let field = this.fields[i];
            if (field instanceof ContainerModel) {
                /** @type {?} */
                let container = /** @type {?} */ (field);
                result.push(container.field);
                container.field.columns.forEach((column) => {
                    result.push(...column.fields);
                });
            }
        }
        return result;
    }
    /**
     * @return {?}
     */
    markAsInvalid() {
        this._isValid = false;
    }
    /**
     * Validates entire form and all form fields.
     *
     * \@memberof FormModel
     * @return {?}
     */
    validateForm() {
        /** @type {?} */
        const validateFormEvent = new ValidateFormEvent(this);
        /** @type {?} */
        let errorsField = [];
        /** @type {?} */
        let fields = this.getFormFields();
        for (let i = 0; i < fields.length; i++) {
            if (!fields[i].validate()) {
                errorsField.push(fields[i]);
            }
        }
        this._isValid = errorsField.length > 0 ? false : true;
        if (this.formService) {
            validateFormEvent.isValid = this._isValid;
            validateFormEvent.errorsField = errorsField;
            this.formService.validateForm.next(validateFormEvent);
        }
    }
    /**
     * Validates a specific form field, triggers form validation.
     *
     * \@memberof FormModel
     * @param {?} field Form field to validate.
     * @return {?}
     */
    validateField(field) {
        if (!field) {
            return;
        }
        /** @type {?} */
        const validateFieldEvent = new ValidateFormFieldEvent(this, field);
        if (this.formService) {
            this.formService.validateFormField.next(validateFieldEvent);
        }
        if (!validateFieldEvent.isValid) {
            this._isValid = false;
            return;
        }
        if (validateFieldEvent.defaultPrevented) {
            return;
        }
        if (!field.validate()) {
            this._isValid = false;
        }
        this.validateForm();
    }
    /**
     * @param {?} json
     * @return {?}
     */
    parseRootFields(json) {
        /** @type {?} */
        let fields = [];
        if (json.fields) {
            fields = json.fields;
        }
        else if (json.formDefinition && json.formDefinition.fields) {
            fields = json.formDefinition.fields;
        }
        /** @type {?} */
        let result = [];
        for (let field of fields) {
            if (field.type === FormFieldTypes.DISPLAY_VALUE) {
                // workaround for dynamic table on a completed/readonly form
                if (field.params) {
                    /** @type {?} */
                    let originalField = field.params['field'];
                    if (originalField.type === FormFieldTypes.DYNAMIC_TABLE) {
                        result.push(new ContainerModel(new FormFieldModel(this, field)));
                    }
                }
            }
            else {
                result.push(new ContainerModel(new FormFieldModel(this, field)));
            }
        }
        return result;
    }
    /**
     * @param {?} data
     * @return {?}
     */
    loadData(data) {
        for (let field of this.getFormFields()) {
            if (data[field.id]) {
                field.json.value = data[field.id];
                field.value = field.parseValue(field.json);
            }
        }
    }
}
FormModel.UNSET_TASK_NAME = 'Nameless task';
FormModel.SAVE_OUTCOME = '$save';
FormModel.COMPLETE_OUTCOME = '$complete';
FormModel.START_PROCESS_OUTCOME = '$startProcess';
if (false) {
    /** @type {?} */
    FormModel.UNSET_TASK_NAME;
    /** @type {?} */
    FormModel.SAVE_OUTCOME;
    /** @type {?} */
    FormModel.COMPLETE_OUTCOME;
    /** @type {?} */
    FormModel.START_PROCESS_OUTCOME;
    /** @type {?} */
    FormModel.prototype.id;
    /** @type {?} */
    FormModel.prototype.name;
    /** @type {?} */
    FormModel.prototype.taskId;
    /** @type {?} */
    FormModel.prototype.taskName;
    /** @type {?} */
    FormModel.prototype.processDefinitionId;
    /** @type {?} */
    FormModel.prototype._isValid;
    /** @type {?} */
    FormModel.prototype.className;
    /** @type {?} */
    FormModel.prototype.readOnly;
    /** @type {?} */
    FormModel.prototype.tabs;
    /**
     * Stores root containers
     * @type {?}
     */
    FormModel.prototype.fields;
    /** @type {?} */
    FormModel.prototype.outcomes;
    /** @type {?} */
    FormModel.prototype.customFieldTemplates;
    /** @type {?} */
    FormModel.prototype.fieldValidators;
    /** @type {?} */
    FormModel.prototype.selectedOutcome;
    /** @type {?} */
    FormModel.prototype.values;
    /** @type {?} */
    FormModel.prototype.processVariables;
    /** @type {?} */
    FormModel.prototype.json;
    /** @type {?} */
    FormModel.prototype.formService;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS5tb2RlbC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BhbGZyZXNjby9hZGYtY29yZS8iLCJzb3VyY2VzIjpbImZvcm0vY29tcG9uZW50cy93aWRnZXRzL2NvcmUvZm9ybS5tb2RlbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQW1CQSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFDcEUsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sNkNBQTZDLENBQUM7QUFDckYsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sdUNBQXVDLENBQUM7QUFFMUUsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRW5ELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNwRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDcEQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFHeEQsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUV2QyxPQUFPLEVBQ0gscUJBQXFCLEVBRXhCLE1BQU0sd0JBQXdCLENBQUM7QUFFaEMsTUFBTTs7Ozs7OztJQTZDRixZQUFZLElBQVUsRUFBRSxJQUFpQixFQUFFLFdBQW9CLEtBQUssRUFBWSxXQUF5QjtRQUF6QixnQkFBVyxHQUFYLFdBQVcsQ0FBYzt3QkFuQzdFLFNBQVMsQ0FBQyxlQUFlO3dCQUV6QixJQUFJO3dCQU9aLEtBQUs7b0JBQ04sRUFBRTs7OztzQkFFTyxFQUFFO3dCQUNDLEVBQUU7b0NBQ1UsRUFBRTsrQkFDTCxDQUFDLEdBQUcscUJBQXFCLENBQUM7c0JBRzdDLEVBQUU7UUFrQm5CLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO1FBRXpCLElBQUksSUFBSSxFQUFFO1lBQ04sSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7WUFFakIs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QUFPOzZCQUNILFdBQVc7a0NBQ04sZUFBZSIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE2IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbi8qIHRzbGludDpkaXNhYmxlOmNvbXBvbmVudC1zZWxlY3RvciAgKi9cblxuaW1wb3J0IHsgRm9ybUZpZWxkRXZlbnQgfSBmcm9tICcuLy4uLy4uLy4uL2V2ZW50cy9mb3JtLWZpZWxkLmV2ZW50JztcbmltcG9ydCB7IFZhbGlkYXRlRm9ybUZpZWxkRXZlbnQgfSBmcm9tICcuLy4uLy4uLy4uL2V2ZW50cy92YWxpZGF0ZS1mb3JtLWZpZWxkLmV2ZW50JztcbmltcG9ydCB7IFZhbGlkYXRlRm9ybUV2ZW50IH0gZnJvbSAnLi8uLi8uLi8uLi9ldmVudHMvdmFsaWRhdGUtZm9ybS5ldmVudCc7XG5pbXBvcnQgeyBGb3JtU2VydmljZSB9IGZyb20gJy4vLi4vLi4vLi4vc2VydmljZXMvZm9ybS5zZXJ2aWNlJztcbmltcG9ydCB7IENvbnRhaW5lck1vZGVsIH0gZnJvbSAnLi9jb250YWluZXIubW9kZWwnO1xuaW1wb3J0IHsgRm9ybUZpZWxkVGVtcGxhdGVzIH0gZnJvbSAnLi9mb3JtLWZpZWxkLXRlbXBsYXRlcyc7XG5pbXBvcnQgeyBGb3JtRmllbGRUeXBlcyB9IGZyb20gJy4vZm9ybS1maWVsZC10eXBlcyc7XG5pbXBvcnQgeyBGb3JtRmllbGRNb2RlbCB9IGZyb20gJy4vZm9ybS1maWVsZC5tb2RlbCc7XG5pbXBvcnQgeyBGb3JtT3V0Y29tZU1vZGVsIH0gZnJvbSAnLi9mb3JtLW91dGNvbWUubW9kZWwnO1xuaW1wb3J0IHsgRm9ybVZhbHVlcyB9IGZyb20gJy4vZm9ybS12YWx1ZXMnO1xuaW1wb3J0IHsgRm9ybVdpZGdldE1vZGVsLCBGb3JtV2lkZ2V0TW9kZWxDYWNoZSB9IGZyb20gJy4vZm9ybS13aWRnZXQubW9kZWwnO1xuaW1wb3J0IHsgVGFiTW9kZWwgfSBmcm9tICcuL3RhYi5tb2RlbCc7XG5cbmltcG9ydCB7XG4gICAgRk9STV9GSUVMRF9WQUxJREFUT1JTLFxuICAgIEZvcm1GaWVsZFZhbGlkYXRvclxufSBmcm9tICcuL2Zvcm0tZmllbGQtdmFsaWRhdG9yJztcblxuZXhwb3J0IGNsYXNzIEZvcm1Nb2RlbCB7XG5cbiAgICBzdGF0aWMgVU5TRVRfVEFTS19OQU1FOiBzdHJpbmcgPSAnTmFtZWxlc3MgdGFzayc7XG4gICAgc3RhdGljIFNBVkVfT1VUQ09NRTogc3RyaW5nID0gJyRzYXZlJztcbiAgICBzdGF0aWMgQ09NUExFVEVfT1VUQ09NRTogc3RyaW5nID0gJyRjb21wbGV0ZSc7XG4gICAgc3RhdGljIFNUQVJUX1BST0NFU1NfT1VUQ09NRTogc3RyaW5nID0gJyRzdGFydFByb2Nlc3MnO1xuXG4gICAgcmVhZG9ubHkgaWQ6IHN0cmluZztcbiAgICByZWFkb25seSBuYW1lOiBzdHJpbmc7XG4gICAgcmVhZG9ubHkgdGFza0lkOiBzdHJpbmc7XG4gICAgcmVhZG9ubHkgdGFza05hbWU6IHN0cmluZyA9IEZvcm1Nb2RlbC5VTlNFVF9UQVNLX05BTUU7XG4gICAgcHJvY2Vzc0RlZmluaXRpb25JZDogc3RyaW5nO1xuICAgIHByaXZhdGUgX2lzVmFsaWQ6IGJvb2xlYW4gPSB0cnVlO1xuXG4gICAgZ2V0IGlzVmFsaWQoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLl9pc1ZhbGlkO1xuICAgIH1cblxuICAgIGNsYXNzTmFtZTogc3RyaW5nO1xuICAgIHJlYWRPbmx5OiBib29sZWFuID0gZmFsc2U7XG4gICAgdGFiczogVGFiTW9kZWxbXSA9IFtdO1xuICAgIC8qKiBTdG9yZXMgcm9vdCBjb250YWluZXJzICovXG4gICAgZmllbGRzOiBGb3JtV2lkZ2V0TW9kZWxbXSA9IFtdO1xuICAgIG91dGNvbWVzOiBGb3JtT3V0Y29tZU1vZGVsW10gPSBbXTtcbiAgICBjdXN0b21GaWVsZFRlbXBsYXRlczogRm9ybUZpZWxkVGVtcGxhdGVzID0ge307XG4gICAgZmllbGRWYWxpZGF0b3JzOiBGb3JtRmllbGRWYWxpZGF0b3JbXSA9IFsuLi5GT1JNX0ZJRUxEX1ZBTElEQVRPUlNdO1xuICAgIHJlYWRvbmx5IHNlbGVjdGVkT3V0Y29tZTogc3RyaW5nO1xuXG4gICAgdmFsdWVzOiBGb3JtVmFsdWVzID0ge307XG4gICAgcHJvY2Vzc1ZhcmlhYmxlczogYW55O1xuXG4gICAgcmVhZG9ubHkganNvbjogYW55O1xuXG4gICAgaGFzVGFicygpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMudGFicyAmJiB0aGlzLnRhYnMubGVuZ3RoID4gMDtcbiAgICB9XG5cbiAgICBoYXNGaWVsZHMoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmZpZWxkcyAmJiB0aGlzLmZpZWxkcy5sZW5ndGggPiAwO1xuICAgIH1cblxuICAgIGhhc091dGNvbWVzKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5vdXRjb21lcyAmJiB0aGlzLm91dGNvbWVzLmxlbmd0aCA+IDA7XG4gICAgfVxuXG4gICAgY29uc3RydWN0b3IoanNvbj86IGFueSwgZGF0YT86IEZvcm1WYWx1ZXMsIHJlYWRPbmx5OiBib29sZWFuID0gZmFsc2UsIHByb3RlY3RlZCBmb3JtU2VydmljZT86IEZvcm1TZXJ2aWNlKSB7XG4gICAgICAgIHRoaXMucmVhZE9ubHkgPSByZWFkT25seTtcblxuICAgICAgICBpZiAoanNvbikge1xuICAgICAgICAgICAgdGhpcy5qc29uID0ganNvbjtcblxuICAgICAgICAgICAgdGhpcy5pZCA9IGpzb24uaWQ7XG4gICAgICAgICAgICB0aGlzLm5hbWUgPSBqc29uLm5hbWU7XG4gICAgICAgICAgICB0aGlzLnRhc2tJZCA9IGpzb24udGFza0lkO1xuICAgICAgICAgICAgdGhpcy50YXNrTmFtZSA9IGpzb24udGFza05hbWUgfHwganNvbi5uYW1lIHx8IEZvcm1Nb2RlbC5VTlNFVF9UQVNLX05BTUU7XG4gICAgICAgICAgICB0aGlzLnByb2Nlc3NEZWZpbml0aW9uSWQgPSBqc29uLnByb2Nlc3NEZWZpbml0aW9uSWQ7XG4gICAgICAgICAgICB0aGlzLmN1c3RvbUZpZWxkVGVtcGxhdGVzID0ganNvbi5jdXN0b21GaWVsZFRlbXBsYXRlcyB8fCB7fTtcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRPdXRjb21lID0ganNvbi5zZWxlY3RlZE91dGNvbWUgfHwge307XG4gICAgICAgICAgICB0aGlzLmNsYXNzTmFtZSA9IGpzb24uY2xhc3NOYW1lIHx8ICcnO1xuXG4gICAgICAgICAgICBsZXQgdGFiQ2FjaGU6IEZvcm1XaWRnZXRNb2RlbENhY2hlPFRhYk1vZGVsPiA9IHt9O1xuXG4gICAgICAgICAgICB0aGlzLnByb2Nlc3NWYXJpYWJsZXMgPSBqc29uLnByb2Nlc3NWYXJpYWJsZXM7XG5cbiAgICAgICAgICAgIHRoaXMudGFicyA9IChqc29uLnRhYnMgfHwgW10pLm1hcCh0ID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgbW9kZWwgPSBuZXcgVGFiTW9kZWwodGhpcywgdCk7XG4gICAgICAgICAgICAgICAgdGFiQ2FjaGVbbW9kZWwuaWRdID0gbW9kZWw7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG1vZGVsO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHRoaXMuZmllbGRzID0gdGhpcy5wYXJzZVJvb3RGaWVsZHMoanNvbik7XG5cbiAgICAgICAgICAgIGlmIChkYXRhKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2FkRGF0YShkYXRhKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmZpZWxkcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIGxldCBmaWVsZCA9IHRoaXMuZmllbGRzW2ldO1xuICAgICAgICAgICAgICAgIGlmIChmaWVsZC50YWIpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHRhYiA9IHRhYkNhY2hlW2ZpZWxkLnRhYl07XG4gICAgICAgICAgICAgICAgICAgIGlmICh0YWIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhYi5maWVsZHMucHVzaChmaWVsZCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChqc29uLmZpZWxkcykge1xuICAgICAgICAgICAgICAgIGxldCBzYXZlT3V0Y29tZSA9IG5ldyBGb3JtT3V0Y29tZU1vZGVsKHRoaXMsIHtcbiAgICAgICAgICAgICAgICAgICAgaWQ6IEZvcm1Nb2RlbC5TQVZFX09VVENPTUUsXG4gICAgICAgICAgICAgICAgICAgIG5hbWU6ICdTYXZlJyxcbiAgICAgICAgICAgICAgICAgICAgaXNTeXN0ZW06IHRydWVcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBsZXQgY29tcGxldGVPdXRjb21lID0gbmV3IEZvcm1PdXRjb21lTW9kZWwodGhpcywge1xuICAgICAgICAgICAgICAgICAgICBpZDogRm9ybU1vZGVsLkNPTVBMRVRFX09VVENPTUUsXG4gICAgICAgICAgICAgICAgICAgIG5hbWU6ICdDb21wbGV0ZScsXG4gICAgICAgICAgICAgICAgICAgIGlzU3lzdGVtOiB0cnVlXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgbGV0IHN0YXJ0UHJvY2Vzc091dGNvbWUgPSBuZXcgRm9ybU91dGNvbWVNb2RlbCh0aGlzLCB7XG4gICAgICAgICAgICAgICAgICAgIGlkOiBGb3JtTW9kZWwuU1RBUlRfUFJPQ0VTU19PVVRDT01FLFxuICAgICAgICAgICAgICAgICAgICBuYW1lOiAnU3RhcnQgUHJvY2VzcycsXG4gICAgICAgICAgICAgICAgICAgIGlzU3lzdGVtOiB0cnVlXG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICBsZXQgY3VzdG9tT3V0Y29tZXMgPSAoanNvbi5vdXRjb21lcyB8fCBbXSkubWFwKG9iaiA9PiBuZXcgRm9ybU91dGNvbWVNb2RlbCh0aGlzLCBvYmopKTtcblxuICAgICAgICAgICAgICAgIHRoaXMub3V0Y29tZXMgPSBbc2F2ZU91dGNvbWVdLmNvbmNhdChcbiAgICAgICAgICAgICAgICAgICAgY3VzdG9tT3V0Y29tZXMubGVuZ3RoID4gMCA/IGN1c3RvbU91dGNvbWVzIDogW2NvbXBsZXRlT3V0Y29tZSwgc3RhcnRQcm9jZXNzT3V0Y29tZV1cbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy52YWxpZGF0ZUZvcm0oKTtcbiAgICB9XG5cbiAgICBvbkZvcm1GaWVsZENoYW5nZWQoZmllbGQ6IEZvcm1GaWVsZE1vZGVsKSB7XG4gICAgICAgIHRoaXMudmFsaWRhdGVGaWVsZChmaWVsZCk7XG4gICAgICAgIGlmICh0aGlzLmZvcm1TZXJ2aWNlKSB7XG4gICAgICAgICAgICB0aGlzLmZvcm1TZXJ2aWNlLmZvcm1GaWVsZFZhbHVlQ2hhbmdlZC5uZXh0KG5ldyBGb3JtRmllbGRFdmVudCh0aGlzLCBmaWVsZCkpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZ2V0RmllbGRCeUlkKGZpZWxkSWQ6IHN0cmluZyk6IEZvcm1GaWVsZE1vZGVsIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0Rm9ybUZpZWxkcygpLmZpbmQoZmllbGQgPT4gZmllbGQuaWQgPT09IGZpZWxkSWQpO1xuICAgIH1cblxuICAgIC8vIFRPRE86IGNvbnNpZGVyIGV2YWx1YXRpbmcgYW5kIGNhY2hpbmcgb25jZSB0aGUgZm9ybSBpcyBsb2FkZWRcbiAgICBnZXRGb3JtRmllbGRzKCk6IEZvcm1GaWVsZE1vZGVsW10ge1xuICAgICAgICBsZXQgcmVzdWx0OiBGb3JtRmllbGRNb2RlbFtdID0gW107XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmZpZWxkcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgbGV0IGZpZWxkID0gdGhpcy5maWVsZHNbaV07XG5cbiAgICAgICAgICAgIGlmIChmaWVsZCBpbnN0YW5jZW9mIENvbnRhaW5lck1vZGVsKSB7XG4gICAgICAgICAgICAgICAgbGV0IGNvbnRhaW5lciA9IDxDb250YWluZXJNb2RlbD4gZmllbGQ7XG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goY29udGFpbmVyLmZpZWxkKTtcblxuICAgICAgICAgICAgICAgIGNvbnRhaW5lci5maWVsZC5jb2x1bW5zLmZvckVhY2goKGNvbHVtbikgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaCguLi5jb2x1bW4uZmllbGRzKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG4gICAgbWFya0FzSW52YWxpZCgpIHtcbiAgICAgICAgdGhpcy5faXNWYWxpZCA9IGZhbHNlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFZhbGlkYXRlcyBlbnRpcmUgZm9ybSBhbmQgYWxsIGZvcm0gZmllbGRzLlxuICAgICAqXG4gICAgICogQG1lbWJlcm9mIEZvcm1Nb2RlbFxuICAgICAqL1xuICAgIHZhbGlkYXRlRm9ybSgpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgdmFsaWRhdGVGb3JtRXZlbnQ6IGFueSA9IG5ldyBWYWxpZGF0ZUZvcm1FdmVudCh0aGlzKTtcblxuICAgICAgICBsZXQgZXJyb3JzRmllbGQ6IEZvcm1GaWVsZE1vZGVsW10gPSBbXTtcblxuICAgICAgICBsZXQgZmllbGRzID0gdGhpcy5nZXRGb3JtRmllbGRzKCk7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZmllbGRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBpZiAoIWZpZWxkc1tpXS52YWxpZGF0ZSgpKSB7XG4gICAgICAgICAgICAgICAgZXJyb3JzRmllbGQucHVzaChmaWVsZHNbaV0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5faXNWYWxpZCA9IGVycm9yc0ZpZWxkLmxlbmd0aCA+IDAgPyBmYWxzZSA6IHRydWU7XG5cbiAgICAgICAgaWYgKHRoaXMuZm9ybVNlcnZpY2UpIHtcbiAgICAgICAgICAgIHZhbGlkYXRlRm9ybUV2ZW50LmlzVmFsaWQgPSB0aGlzLl9pc1ZhbGlkO1xuICAgICAgICAgICAgdmFsaWRhdGVGb3JtRXZlbnQuZXJyb3JzRmllbGQgPSBlcnJvcnNGaWVsZDtcbiAgICAgICAgICAgIHRoaXMuZm9ybVNlcnZpY2UudmFsaWRhdGVGb3JtLm5leHQodmFsaWRhdGVGb3JtRXZlbnQpO1xuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBWYWxpZGF0ZXMgYSBzcGVjaWZpYyBmb3JtIGZpZWxkLCB0cmlnZ2VycyBmb3JtIHZhbGlkYXRpb24uXG4gICAgICpcbiAgICAgKiBAcGFyYW0gZmllbGQgRm9ybSBmaWVsZCB0byB2YWxpZGF0ZS5cbiAgICAgKiBAbWVtYmVyb2YgRm9ybU1vZGVsXG4gICAgICovXG4gICAgdmFsaWRhdGVGaWVsZChmaWVsZDogRm9ybUZpZWxkTW9kZWwpOiB2b2lkIHtcbiAgICAgICAgaWYgKCFmaWVsZCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdmFsaWRhdGVGaWVsZEV2ZW50ID0gbmV3IFZhbGlkYXRlRm9ybUZpZWxkRXZlbnQodGhpcywgZmllbGQpO1xuXG4gICAgICAgIGlmICh0aGlzLmZvcm1TZXJ2aWNlKSB7XG4gICAgICAgICAgICB0aGlzLmZvcm1TZXJ2aWNlLnZhbGlkYXRlRm9ybUZpZWxkLm5leHQodmFsaWRhdGVGaWVsZEV2ZW50KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghdmFsaWRhdGVGaWVsZEV2ZW50LmlzVmFsaWQpIHtcbiAgICAgICAgICAgIHRoaXMuX2lzVmFsaWQgPSBmYWxzZTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh2YWxpZGF0ZUZpZWxkRXZlbnQuZGVmYXVsdFByZXZlbnRlZCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFmaWVsZC52YWxpZGF0ZSgpKSB7XG4gICAgICAgICAgICB0aGlzLl9pc1ZhbGlkID0gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnZhbGlkYXRlRm9ybSgpO1xuICAgIH1cblxuICAgIC8vIEFjdGl2aXRpIHN1cHBvcnRzIDMgdHlwZXMgb2Ygcm9vdCBmaWVsZHM6IGNvbnRhaW5lcnxncm91cHxkeW5hbWljLXRhYmxlXG4gICAgcHJpdmF0ZSBwYXJzZVJvb3RGaWVsZHMoanNvbjogYW55KTogRm9ybVdpZGdldE1vZGVsW10ge1xuICAgICAgICBsZXQgZmllbGRzID0gW107XG5cbiAgICAgICAgaWYgKGpzb24uZmllbGRzKSB7XG4gICAgICAgICAgICBmaWVsZHMgPSBqc29uLmZpZWxkcztcbiAgICAgICAgfSBlbHNlIGlmIChqc29uLmZvcm1EZWZpbml0aW9uICYmIGpzb24uZm9ybURlZmluaXRpb24uZmllbGRzKSB7XG4gICAgICAgICAgICBmaWVsZHMgPSBqc29uLmZvcm1EZWZpbml0aW9uLmZpZWxkcztcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCByZXN1bHQ6IEZvcm1XaWRnZXRNb2RlbFtdID0gW107XG5cbiAgICAgICAgZm9yIChsZXQgZmllbGQgb2YgZmllbGRzKSB7XG4gICAgICAgICAgICBpZiAoZmllbGQudHlwZSA9PT0gRm9ybUZpZWxkVHlwZXMuRElTUExBWV9WQUxVRSkge1xuICAgICAgICAgICAgICAgIC8vIHdvcmthcm91bmQgZm9yIGR5bmFtaWMgdGFibGUgb24gYSBjb21wbGV0ZWQvcmVhZG9ubHkgZm9ybVxuICAgICAgICAgICAgICAgIGlmIChmaWVsZC5wYXJhbXMpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IG9yaWdpbmFsRmllbGQgPSBmaWVsZC5wYXJhbXNbJ2ZpZWxkJ107XG4gICAgICAgICAgICAgICAgICAgIGlmIChvcmlnaW5hbEZpZWxkLnR5cGUgPT09IEZvcm1GaWVsZFR5cGVzLkRZTkFNSUNfVEFCTEUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKG5ldyBDb250YWluZXJNb2RlbChuZXcgRm9ybUZpZWxkTW9kZWwodGhpcywgZmllbGQpKSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKG5ldyBDb250YWluZXJNb2RlbChuZXcgRm9ybUZpZWxkTW9kZWwodGhpcywgZmllbGQpKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuICAgIC8vIExvYWRzIGV4dGVybmFsIGRhdGEgYW5kIG92ZXJyaWRlcyBmaWVsZCB2YWx1ZXNcbiAgICAvLyBUeXBpY2FsbHkgdXNlZCB3aGVuIGZvcm0gZGVmaW5pdGlvbiBhbmQgZm9ybSBkYXRhIGNvbWluZyBmcm9tIGRpZmZlcmVudCBzb3VyY2VzXG4gICAgcHJpdmF0ZSBsb2FkRGF0YShkYXRhOiBGb3JtVmFsdWVzKSB7XG4gICAgICAgIGZvciAobGV0IGZpZWxkIG9mIHRoaXMuZ2V0Rm9ybUZpZWxkcygpKSB7XG4gICAgICAgICAgICBpZiAoZGF0YVtmaWVsZC5pZF0pIHtcbiAgICAgICAgICAgICAgICBmaWVsZC5qc29uLnZhbHVlID0gZGF0YVtmaWVsZC5pZF07XG4gICAgICAgICAgICAgICAgZmllbGQudmFsdWUgPSBmaWVsZC5wYXJzZVZhbHVlKGZpZWxkLmpzb24pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuIl19