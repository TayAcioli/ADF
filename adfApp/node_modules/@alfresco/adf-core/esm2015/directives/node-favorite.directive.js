/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
/*!
 * @license
 * Copyright 2016 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { Directive, EventEmitter, HostListener, Input, Output } from '@angular/core';
import { from, forkJoin, of } from 'rxjs';
import { AlfrescoApiService } from '../services/alfresco-api.service';
import { catchError, map } from 'rxjs/operators';
export class NodeFavoriteDirective {
    /**
     * @param {?} alfrescoApiService
     */
    constructor(alfrescoApiService) {
        this.alfrescoApiService = alfrescoApiService;
        this.favorites = [];
        /**
         * Array of nodes to toggle as favorites.
         */
        this.selection = [];
        /**
         * Emitted when the favorite setting is complete.
         */
        this.toggle = new EventEmitter();
        /**
         * Emitted when the favorite setting has fail.
         */
        this.error = new EventEmitter();
    }
    /**
     * @return {?}
     */
    onClick() {
        this.toggleFavorite();
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    ngOnChanges(changes) {
        if (!changes.selection.currentValue.length) {
            this.favorites = [];
            return;
        }
        this.markFavoritesNodes(changes.selection.currentValue);
    }
    /**
     * @return {?}
     */
    toggleFavorite() {
        if (!this.favorites.length) {
            return;
        }
        /** @type {?} */
        const every = this.favorites.every((selected) => selected.entry.isFavorite);
        if (every) {
            /** @type {?} */
            const batch = this.favorites.map((selected) => {
                /** @type {?} */
                const id = selected.entry.nodeId || selected.entry.id;
                return from(this.alfrescoApiService.favoritesApi.removeFavoriteSite('-me-', id));
            });
            forkJoin(batch).subscribe(() => {
                this.favorites.map(selected => selected.entry.isFavorite = false);
                this.toggle.emit();
            }, error => this.error.emit(error));
        }
        if (!every) {
            /** @type {?} */
            const notFavorite = this.favorites.filter((node) => !node.entry.isFavorite);
            /** @type {?} */
            const body = notFavorite.map((node) => this.createFavoriteBody(node));
            from(this.alfrescoApiService.favoritesApi.addFavorite('-me-', /** @type {?} */ (body)))
                .subscribe(() => {
                notFavorite.map(selected => selected.entry.isFavorite = true);
                this.toggle.emit();
            }, error => this.error.emit(error));
        }
    }
    /**
     * @param {?} selection
     * @return {?}
     */
    markFavoritesNodes(selection) {
        if (selection.length <= this.favorites.length) {
            /** @type {?} */
            const newFavorites = this.reduce(this.favorites, selection);
            this.favorites = newFavorites;
        }
        /** @type {?} */
        const result = this.diff(selection, this.favorites);
        /** @type {?} */
        const batch = this.getProcessBatch(result);
        forkJoin(batch).subscribe(data => {
            this.favorites.push(...data);
        });
    }
    /**
     * @return {?}
     */
    hasFavorites() {
        if (this.favorites && !this.favorites.length) {
            return false;
        }
        return this.favorites.every((selected) => selected.entry.isFavorite);
    }
    /**
     * @param {?} selection
     * @return {?}
     */
    getProcessBatch(selection) {
        return selection.map((selected) => this.getFavorite(selected));
    }
    /**
     * @param {?} selected
     * @return {?}
     */
    getFavorite(selected) {
        /** @type {?} */
        const node = selected.entry;
        // ACS 6.x with 'isFavorite' include
        if (node && node.hasOwnProperty('isFavorite')) {
            return of(selected);
        }
        const { name, isFile, isFolder } = node;
        /** @type {?} */
        const id = node.nodeId || node.id;
        /** @type {?} */
        const promise = this.alfrescoApiService.favoritesApi.getFavorite('-me-', id);
        return from(promise).pipe(map(() => ({
            entry: {
                id,
                isFolder,
                isFile,
                name,
                isFavorite: true
            }
        })), catchError(() => {
            return of({
                entry: {
                    id,
                    isFolder,
                    isFile,
                    name,
                    isFavorite: false
                }
            });
        }));
    }
    /**
     * @param {?} node
     * @return {?}
     */
    createFavoriteBody(node) {
        /** @type {?} */
        const type = this.getNodeType(node);
        /** @type {?} */
        const id = node.entry.nodeId || node.entry.id;
        return {
            target: {
                [type]: {
                    guid: id
                }
            }
        };
    }
    /**
     * @param {?} node
     * @return {?}
     */
    getNodeType(node) {
        // shared could only be files
        if (!node.entry.isFile && !node.entry.isFolder) {
            return 'file';
        }
        return node.entry.isFile ? 'file' : 'folder';
    }
    /**
     * @param {?} list
     * @param {?} patch
     * @return {?}
     */
    diff(list, patch) {
        /** @type {?} */
        const ids = patch.map(item => item.entry.id);
        return list.filter(item => ids.includes(item.entry.id) ? null : item);
    }
    /**
     * @param {?} patch
     * @param {?} comparator
     * @return {?}
     */
    reduce(patch, comparator) {
        /** @type {?} */
        const ids = comparator.map(item => item.entry.id);
        return patch.filter(item => ids.includes(item.entry.id) ? item : null);
    }
}
NodeFavoriteDirective.decorators = [
    { type: Directive, args: [{
                selector: '[adf-node-favorite]',
                exportAs: 'adfFavorite'
            },] }
];
/** @nocollapse */
NodeFavoriteDirective.ctorParameters = () => [
    { type: AlfrescoApiService }
];
NodeFavoriteDirective.propDecorators = {
    selection: [{ type: Input, args: ['adf-node-favorite',] }],
    toggle: [{ type: Output }],
    error: [{ type: Output }],
    onClick: [{ type: HostListener, args: ['click',] }]
};
if (false) {
    /** @type {?} */
    NodeFavoriteDirective.prototype.favorites;
    /**
     * Array of nodes to toggle as favorites.
     * @type {?}
     */
    NodeFavoriteDirective.prototype.selection;
    /**
     * Emitted when the favorite setting is complete.
     * @type {?}
     */
    NodeFavoriteDirective.prototype.toggle;
    /**
     * Emitted when the favorite setting has fail.
     * @type {?}
     */
    NodeFavoriteDirective.prototype.error;
    /** @type {?} */
    NodeFavoriteDirective.prototype.alfrescoApiService;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm9kZS1mYXZvcml0ZS5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYWxmcmVzY28vYWRmLWNvcmUvIiwic291cmNlcyI6WyJkaXJlY3RpdmVzL25vZGUtZmF2b3JpdGUuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBbUJBLE9BQU8sRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQWEsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRWhHLE9BQU8sRUFBYyxJQUFJLEVBQUUsUUFBUSxFQUFFLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN0RCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQUN0RSxPQUFPLEVBQUUsVUFBVSxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBTWpELE1BQU07Ozs7SUFrQkYsWUFBb0Isa0JBQXNDO1FBQXRDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7eUJBakJ2QyxFQUFFOzs7O3lCQUlZLEVBQUU7Ozs7c0JBR0csSUFBSSxZQUFZLEVBQUU7Ozs7cUJBR25CLElBQUksWUFBWSxFQUFFO0tBUXREOzs7O0lBTEQsT0FBTztRQUNILElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztLQUN6Qjs7Ozs7SUFLRCxXQUFXLENBQUMsT0FBTztRQUNmLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxNQUFNLEVBQUU7WUFDeEMsSUFBSSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUM7WUFFcEIsT0FBTztTQUNWO1FBRUQsSUFBSSxDQUFDLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLENBQUM7S0FDM0Q7Ozs7SUFFRCxjQUFjO1FBQ1YsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxFQUFFO1lBQ3hCLE9BQU87U0FDVjs7UUFFRCxN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RyxHQUFHLFVBQVUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRWxELE9BQU8sS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQzs7OztZQTNLOUUsU0FBUyxTQUFDO2dCQUNQLFFBQVEsRUFBRSxxQkFBcUI7Z0JBQy9CLFFBQVEsRUFBRSxhQUFhO2FBQzFCOzs7O1lBTlEsa0JBQWtCOzs7d0JBV3RCLEtBQUssU0FBQyxtQkFBbUI7cUJBSXpCLE1BQU07b0JBR04sTUFBTTtzQkFFTixZQUFZLFNBQUMsT0FBTyIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE2IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbi8qIHRzbGludDpkaXNhYmxlOm5vLWlucHV0LXJlbmFtZSAgKi9cblxuaW1wb3J0IHsgRGlyZWN0aXZlLCBFdmVudEVtaXR0ZXIsIEhvc3RMaXN0ZW5lciwgSW5wdXQsIE9uQ2hhbmdlcywgT3V0cHV0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBGYXZvcml0ZUJvZHksIE1pbmltYWxOb2RlRW50aXR5IH0gZnJvbSAnYWxmcmVzY28tanMtYXBpJztcbmltcG9ydCB7IE9ic2VydmFibGUsIGZyb20sIGZvcmtKb2luLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgQWxmcmVzY29BcGlTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvYWxmcmVzY28tYXBpLnNlcnZpY2UnO1xuaW1wb3J0IHsgY2F0Y2hFcnJvciwgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5ARGlyZWN0aXZlKHtcbiAgICBzZWxlY3RvcjogJ1thZGYtbm9kZS1mYXZvcml0ZV0nLFxuICAgIGV4cG9ydEFzOiAnYWRmRmF2b3JpdGUnXG59KVxuZXhwb3J0IGNsYXNzIE5vZGVGYXZvcml0ZURpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uQ2hhbmdlcyB7XG4gICAgZmF2b3JpdGVzOiBhbnlbXSA9IFtdO1xuXG4gICAgLyoqIEFycmF5IG9mIG5vZGVzIHRvIHRvZ2dsZSBhcyBmYXZvcml0ZXMuICovXG4gICAgQElucHV0KCdhZGYtbm9kZS1mYXZvcml0ZScpXG4gICAgc2VsZWN0aW9uOiBNaW5pbWFsTm9kZUVudGl0eVtdID0gW107XG5cbiAgICAvKiogRW1pdHRlZCB3aGVuIHRoZSBmYXZvcml0ZSBzZXR0aW5nIGlzIGNvbXBsZXRlLiAqL1xuICAgIEBPdXRwdXQoKSB0b2dnbGU6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gICAgLyoqIEVtaXR0ZWQgd2hlbiB0aGUgZmF2b3JpdGUgc2V0dGluZyBoYXMgZmFpbC4gKi9cbiAgICBAT3V0cHV0KCkgZXJyb3I6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gICAgQEhvc3RMaXN0ZW5lcignY2xpY2snKVxuICAgIG9uQ2xpY2soKSB7XG4gICAgICAgIHRoaXMudG9nZ2xlRmF2b3JpdGUoKTtcbiAgICB9XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFsZnJlc2NvQXBpU2VydmljZTogQWxmcmVzY29BcGlTZXJ2aWNlKSB7XG4gICAgfVxuXG4gICAgbmdPbkNoYW5nZXMoY2hhbmdlcykge1xuICAgICAgICBpZiAoIWNoYW5nZXMuc2VsZWN0aW9uLmN1cnJlbnRWYWx1ZS5sZW5ndGgpIHtcbiAgICAgICAgICAgIHRoaXMuZmF2b3JpdGVzID0gW107XG5cbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMubWFya0Zhdm9yaXRlc05vZGVzKGNoYW5nZXMuc2VsZWN0aW9uLmN1cnJlbnRWYWx1ZSk7XG4gICAgfVxuXG4gICAgdG9nZ2xlRmF2b3JpdGUoKSB7XG4gICAgICAgIGlmICghdGhpcy5mYXZvcml0ZXMubGVuZ3RoKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBldmVyeSA9IHRoaXMuZmF2b3JpdGVzLmV2ZXJ5KChzZWxlY3RlZCkgPT4gc2VsZWN0ZWQuZW50cnkuaXNGYXZvcml0ZSk7XG5cbiAgICAgICAgaWYgKGV2ZXJ5KSB7XG4gICAgICAgICAgICBjb25zdCBiYXRjaCA9IHRoaXMuZmF2b3JpdGVzLm1hcCgoc2VsZWN0ZWQpID0+IHtcbiAgICAgICAgICAgICAgICAvLyBzaGFyZWQgZmlsZXMgaGF2ZSBub2RlSWRcbiAgICAgICAgICAgICAgICBjb25zdCBpZCA9IHNlbGVjdGVkLmVudHJ5Lm5vZGVJZCB8fCBzZWxlY3RlZC5lbnRyeS5pZDtcblxuICAgICAgICAgICAgICAgIHJldHVybiBmcm9tKHRoaXMuYWxmcmVzY29BcGlTZXJ2aWNlLmZhdm9yaXRlc0FwaS5yZW1vdmVGYXZvcml0ZVNpdGUoJy1tZS0nLCBpZCkpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGZvcmtKb2luKGJhdGNoKS5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmZhdm9yaXRlcy5tYXAoc2VsZWN0ZWQgPT4gc2VsZWN0ZWQuZW50cnkuaXNGYXZvcml0ZSA9IGZhbHNlKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50b2dnbGUuZW1pdCgpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgZXJyb3IgPT4gdGhpcy5lcnJvci5lbWl0KGVycm9yKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghZXZlcnkpIHtcbiAgICAgICAgICAgIGNvbnN0IG5vdEZhdm9yaXRlID0gdGhpcy5mYXZvcml0ZXMuZmlsdGVyKChub2RlKSA9PiAhbm9kZS5lbnRyeS5pc0Zhdm9yaXRlKTtcbiAgICAgICAgICAgIGNvbnN0IGJvZHk6IEZhdm9yaXRlQm9keVtdID0gbm90RmF2b3JpdGUubWFwKChub2RlKSA9PiB0aGlzLmNyZWF0ZUZhdm9yaXRlQm9keShub2RlKSk7XG5cbiAgICAgICAgICAgIGZyb20odGhpcy5hbGZyZXNjb0FwaVNlcnZpY2UuZmF2b3JpdGVzQXBpLmFkZEZhdm9yaXRlKCctbWUtJywgPGFueT4gYm9keSkpXG4gICAgICAgICAgICAgICAgLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgICAgICAgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgbm90RmF2b3JpdGUubWFwKHNlbGVjdGVkID0+IHNlbGVjdGVkLmVudHJ5LmlzRmF2b3JpdGUgPSB0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudG9nZ2xlLmVtaXQoKTtcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgZXJyb3IgPT4gdGhpcy5lcnJvci5lbWl0KGVycm9yKVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBtYXJrRmF2b3JpdGVzTm9kZXMoc2VsZWN0aW9uOiBNaW5pbWFsTm9kZUVudGl0eVtdKSB7XG4gICAgICAgIGlmIChzZWxlY3Rpb24ubGVuZ3RoIDw9IHRoaXMuZmF2b3JpdGVzLmxlbmd0aCkge1xuICAgICAgICAgICAgY29uc3QgbmV3RmF2b3JpdGVzID0gdGhpcy5yZWR1Y2UodGhpcy5mYXZvcml0ZXMsIHNlbGVjdGlvbik7XG4gICAgICAgICAgICB0aGlzLmZhdm9yaXRlcyA9IG5ld0Zhdm9yaXRlcztcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuZGlmZihzZWxlY3Rpb24sIHRoaXMuZmF2b3JpdGVzKTtcbiAgICAgICAgY29uc3QgYmF0Y2ggPSB0aGlzLmdldFByb2Nlc3NCYXRjaChyZXN1bHQpO1xuXG4gICAgICAgIGZvcmtKb2luKGJhdGNoKS5zdWJzY3JpYmUoZGF0YSA9PiB7XG4gICAgICAgICAgICB0aGlzLmZhdm9yaXRlcy5wdXNoKC4uLmRhdGEpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBoYXNGYXZvcml0ZXMoKTogYm9vbGVhbiB7XG4gICAgICAgIGlmICh0aGlzLmZhdm9yaXRlcyAmJiAhdGhpcy5mYXZvcml0ZXMubGVuZ3RoKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5mYXZvcml0ZXMuZXZlcnkoKHNlbGVjdGVkKSA9PiBzZWxlY3RlZC5lbnRyeS5pc0Zhdm9yaXRlKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFByb2Nlc3NCYXRjaChzZWxlY3Rpb24pOiBhbnlbXSB7XG4gICAgICAgIHJldHVybiBzZWxlY3Rpb24ubWFwKChzZWxlY3RlZDogTWluaW1hbE5vZGVFbnRpdHkpID0+IHRoaXMuZ2V0RmF2b3JpdGUoc2VsZWN0ZWQpKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldEZhdm9yaXRlKHNlbGVjdGVkOiBNaW5pbWFsTm9kZUVudGl0eSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIGNvbnN0IG5vZGUgPSBzZWxlY3RlZC5lbnRyeTtcblxuICAgICAgICAvLyBBQ1MgNi54IHdpdGggJ2lzRmF2b3JpdGUnIGluY2x1ZGVcbiAgICAgICAgaWYgKG5vZGUgJiYgbm9kZS5oYXNPd25Qcm9wZXJ0eSgnaXNGYXZvcml0ZScpKSB7XG4gICAgICAgICAgICByZXR1cm4gb2Yoc2VsZWN0ZWQpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gQUNTIDUueCBhbmQgNi54IHdpdGhvdXQgJ2lzRmF2b3JpdGUnIGluY2x1ZGVcbiAgICAgICAgY29uc3QgeyBuYW1lLCBpc0ZpbGUsIGlzRm9sZGVyIH0gPSBub2RlO1xuICAgICAgICAvLyBzaGFyZWQgZmlsZXMgaGF2ZSBub2RlSWRcbiAgICAgICAgY29uc3QgaWQgPSBub2RlLm5vZGVJZCB8fCBub2RlLmlkO1xuXG4gICAgICAgIGNvbnN0IHByb21pc2UgPSB0aGlzLmFsZnJlc2NvQXBpU2VydmljZS5mYXZvcml0ZXNBcGkuZ2V0RmF2b3JpdGUoJy1tZS0nLCBpZCk7XG5cbiAgICAgICAgcmV0dXJuIGZyb20ocHJvbWlzZSkucGlwZShcbiAgICAgICAgICAgIG1hcCgoKSA9PiAoe1xuICAgICAgICAgICAgICAgIGVudHJ5OiB7XG4gICAgICAgICAgICAgICAgICAgIGlkLFxuICAgICAgICAgICAgICAgICAgICBpc0ZvbGRlcixcbiAgICAgICAgICAgICAgICAgICAgaXNGaWxlLFxuICAgICAgICAgICAgICAgICAgICBuYW1lLFxuICAgICAgICAgICAgICAgICAgICBpc0Zhdm9yaXRlOiB0cnVlXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSkpLFxuICAgICAgICAgICAgY2F0Y2hFcnJvcigoKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG9mKHtcbiAgICAgICAgICAgICAgICAgICAgZW50cnk6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgaXNGb2xkZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICBpc0ZpbGUsXG4gICAgICAgICAgICAgICAgICAgICAgICBuYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgaXNGYXZvcml0ZTogZmFsc2VcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNyZWF0ZUZhdm9yaXRlQm9keShub2RlKTogRmF2b3JpdGVCb2R5IHtcbiAgICAgICAgY29uc3QgdHlwZSA9IHRoaXMuZ2V0Tm9kZVR5cGUobm9kZSk7XG4gICAgICAgIC8vIHNoYXJlZCBmaWxlcyBoYXZlIG5vZGVJZFxuICAgICAgICBjb25zdCBpZCA9IG5vZGUuZW50cnkubm9kZUlkIHx8IG5vZGUuZW50cnkuaWQ7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHRhcmdldDoge1xuICAgICAgICAgICAgICAgIFt0eXBlXToge1xuICAgICAgICAgICAgICAgICAgICBndWlkOiBpZFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldE5vZGVUeXBlKG5vZGUpOiBzdHJpbmcge1xuICAgICAgICAvLyBzaGFyZWQgY291bGQgb25seSBiZSBmaWxlc1xuICAgICAgICBpZiAoIW5vZGUuZW50cnkuaXNGaWxlICYmICFub2RlLmVudHJ5LmlzRm9sZGVyKSB7XG4gICAgICAgICAgICByZXR1cm4gJ2ZpbGUnO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG5vZGUuZW50cnkuaXNGaWxlID8gJ2ZpbGUnIDogJ2ZvbGRlcic7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkaWZmKGxpc3QsIHBhdGNoKTogYW55W10ge1xuICAgICAgICBjb25zdCBpZHMgPSBwYXRjaC5tYXAoaXRlbSA9PiBpdGVtLmVudHJ5LmlkKTtcblxuICAgICAgICByZXR1cm4gbGlzdC5maWx0ZXIoaXRlbSA9PiBpZHMuaW5jbHVkZXMoaXRlbS5lbnRyeS5pZCkgPyBudWxsIDogaXRlbSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZWR1Y2UocGF0Y2gsIGNvbXBhcmF0b3IpOiBhbnlbXSB7XG4gICAgICAgIGNvbnN0IGlkcyA9IGNvbXBhcmF0b3IubWFwKGl0ZW0gPT4gaXRlbS5lbnRyeS5pZCk7XG5cbiAgICAgICAgcmV0dXJuIHBhdGNoLmZpbHRlcihpdGVtID0+IGlkcy5pbmNsdWRlcyhpdGVtLmVudHJ5LmlkKSA/IGl0ZW0gOiBudWxsKTtcbiAgICB9XG59XG4iXX0=