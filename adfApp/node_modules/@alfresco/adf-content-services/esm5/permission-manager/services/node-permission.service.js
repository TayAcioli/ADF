/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
/*!
 * @license
 * Copyright 2016 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { Injectable } from '@angular/core';
import { of, from, throwError } from 'rxjs';
import { AlfrescoApiService, SearchService, NodesApiService, TranslationService } from '@alfresco/adf-core';
import { switchMap, map } from 'rxjs/operators';
var NodePermissionService = /** @class */ (function () {
    function NodePermissionService(apiService, searchApiService, nodeService, translation) {
        this.apiService = apiService;
        this.searchApiService = searchApiService;
        this.nodeService = nodeService;
        this.translation = translation;
    }
    /**
     * Gets a list of roles for the current node.
     * @param node The target node
     * @returns Array of strings representing the roles
     */
    /**
     * Gets a list of roles for the current node.
     * @param {?} node The target node
     * @return {?} Array of strings representing the roles
     */
    NodePermissionService.prototype.getNodeRoles = /**
     * Gets a list of roles for the current node.
     * @param {?} node The target node
     * @return {?} Array of strings representing the roles
     */
    function (node) {
        var _this = this;
        /** @type {?} */
        var retrieveSiteQueryBody = this.buildRetrieveSiteQueryBody(node.path.elements);
        return this.searchApiService.searchByQueryBody(retrieveSiteQueryBody)
            .pipe(switchMap(function (siteNodeList) {
            if (siteNodeList.list.entries.length > 0) {
                /** @type {?} */
                var siteName = siteNodeList.list.entries[0].entry.name;
                return _this.getGroupMembersBySiteName(siteName);
            }
            else {
                return of(node.permissions.settable);
            }
        }));
    };
    /**
     * Updates the permission role for a node.
     * @param node Target node
     * @param updatedPermissionRole Permission role to update or add
     * @returns Node with updated permission
     */
    /**
     * Updates the permission role for a node.
     * @param {?} node Target node
     * @param {?} updatedPermissionRole Permission role to update or add
     * @return {?} Node with updated permission
     */
    NodePermissionService.prototype.updatePermissionRole = /**
     * Updates the permission role for a node.
     * @param {?} node Target node
     * @param {?} updatedPermissionRole Permission role to update or add
     * @return {?} Node with updated permission
     */
    function (node, updatedPermissionRole) {
        /** @type {?} */
        var permissionBody = { permissions: { locallySet: [] } };
        /** @type {?} */
        var index = node.permissions.locallySet.map(function (permission) { return permission.authorityId; }).indexOf(updatedPermissionRole.authorityId);
        permissionBody.permissions.locallySet = permissionBody.permissions.locallySet.concat(node.permissions.locallySet);
        if (index !== -1) {
            permissionBody.permissions.locallySet[index] = updatedPermissionRole;
        }
        else {
            permissionBody.permissions.locallySet.push(updatedPermissionRole);
        }
        return this.nodeService.updateNode(node.id, permissionBody);
    };
    /**
     * Update permissions for a node.
     * @param nodeId ID of the target node
     * @param permissionList New permission settings
     * @returns Node with updated permissions
     */
    /**
     * Update permissions for a node.
     * @param {?} nodeId ID of the target node
     * @param {?} permissionList New permission settings
     * @return {?} Node with updated permissions
     */
    NodePermissionService.prototype.updateNodePermissions = /**
     * Update permissions for a node.
     * @param {?} nodeId ID of the target node
     * @param {?} permissionList New permission settings
     * @return {?} Node with updated permissions
     */
    function (nodeId, permissionList) {
        var _this = this;
        return this.nodeService.getNode(nodeId).pipe(switchMap(function (node) {
            return _this.getNodeRoles(node).pipe(switchMap(function (nodeRoles) { return of({ node: node, nodeRoles: nodeRoles }); }));
        }), switchMap(function (_a) {
            var node = _a.node, nodeRoles = _a.nodeRoles;
            return _this.updateLocallySetPermissions(node, permissionList, nodeRoles);
        }));
    };
    /**
     * Updates the locally set permissions for a node.
     * @param node ID of the target node
     * @param nodes Permission settings
     * @param nodeRole Permission role
     * @returns Node with updated permissions
     */
    /**
     * Updates the locally set permissions for a node.
     * @param {?} node ID of the target node
     * @param {?} nodes Permission settings
     * @param {?} nodeRole Permission role
     * @return {?} Node with updated permissions
     */
    NodePermissionService.prototype.updateLocallySetPermissions = /**
     * Updates the locally set permissions for a node.
     * @param {?} node ID of the target node
     * @param {?} nodes Permission settings
     * @param {?} nodeRole Permission role
     * @return {?} Node with updated permissions
     */
    function (node, nodes, nodeRole) {
        /** @type {?} */
        var permissionBody = { permissions: { locallySet: [] } };
        /** @type {?} */
        var permissionList = this.transformNodeToPermissionElement(nodes, nodeRole[0]);
        /** @type {?} */
        var duplicatedPermissions = this.getDuplicatedPermissions(node.permissions.locallySet, permissionList);
        if (duplicatedPermissions.length > 0) {
            /** @type {?} */
            var list = duplicatedPermissions.map(function (permission) { return 'authority -> ' + permission.authorityId + ' / role -> ' + permission.name; }).join(', ');
            /** @type {?} */
            var duplicatePermissionMessage = this.translation.instant('PERMISSION_MANAGER.ERROR.DUPLICATE-PERMISSION', { list: list });
            return throwError(duplicatePermissionMessage);
        }
        permissionBody.permissions.locallySet = node.permissions.locallySet ? node.permissions.locallySet.concat(permissionList) : permissionList;
        return this.nodeService.updateNode(node.id, permissionBody);
    };
    /**
     * @param {?} nodeLocallySet
     * @param {?} permissionListAdded
     * @return {?}
     */
    NodePermissionService.prototype.getDuplicatedPermissions = /**
     * @param {?} nodeLocallySet
     * @param {?} permissionListAdded
     * @return {?}
     */
    function (nodeLocallySet, permissionListAdded) {
        var _this = this;
        /** @type {?} */
        var duplicatePermissions = [];
        if (nodeLocallySet) {
            permissionListAdded.forEach(function (permission) {
                /** @type {?} */
                var duplicate = nodeLocallySet.find(function (localPermission) { return _this.isEqualPermission(localPermission, permission); });
                if (duplicate) {
                    duplicatePermissions.push(duplicate);
                }
            });
        }
        return duplicatePermissions;
    };
    /**
     * @param {?} oldPermission
     * @param {?} newPermission
     * @return {?}
     */
    NodePermissionService.prototype.isEqualPermission = /**
     * @param {?} oldPermission
     * @param {?} newPermission
     * @return {?}
     */
    function (oldPermission, newPermission) {
        return oldPermission.accessStatus === newPermission.accessStatus &&
            oldPermission.authorityId === newPermission.authorityId &&
            oldPermission.name === newPermission.name;
    };
    /**
     * @param {?} nodes
     * @param {?} nodeRole
     * @return {?}
     */
    NodePermissionService.prototype.transformNodeToPermissionElement = /**
     * @param {?} nodes
     * @param {?} nodeRole
     * @return {?}
     */
    function (nodes, nodeRole) {
        return nodes.map(function (node) {
            /** @type {?} */
            var newPermissionElement = /** @type {?} */ ({
                'authorityId': node.entry.properties['cm:authorityName'] ?
                    node.entry.properties['cm:authorityName'] :
                    node.entry.properties['cm:userName'],
                'name': nodeRole,
                'accessStatus': 'ALLOWED'
            });
            return newPermissionElement;
        });
    };
    /**
     * Removes a permission setting from a node.
     * @param node ID of the target node
     * @param permissionToRemove Permission setting to remove
     * @returns Node with modified permissions
     */
    /**
     * Removes a permission setting from a node.
     * @param {?} node ID of the target node
     * @param {?} permissionToRemove Permission setting to remove
     * @return {?} Node with modified permissions
     */
    NodePermissionService.prototype.removePermission = /**
     * Removes a permission setting from a node.
     * @param {?} node ID of the target node
     * @param {?} permissionToRemove Permission setting to remove
     * @return {?} Node with modified permissions
     */
    function (node, permissionToRemove) {
        /** @type {?} */
        var permissionBody = { permissions: { locallySet: [] } };
        /** @type {?} */
        var index = node.permissions.locallySet.map(function (permission) { return permission.authorityId; }).indexOf(permissionToRemove.authorityId);
        if (index !== -1) {
            node.permissions.locallySet.splice(index, 1);
            permissionBody.permissions.locallySet = node.permissions.locallySet;
            return this.nodeService.updateNode(node.id, permissionBody);
        }
    };
    /**
     * @param {?} siteName
     * @return {?}
     */
    NodePermissionService.prototype.getGroupMembersBySiteName = /**
     * @param {?} siteName
     * @return {?}
     */
    function (siteName) {
        var _this = this;
        /** @type {?} */
        var groupName = 'GROUP_site_' + siteName;
        return this.getGroupMemeberByGroupName(groupName)
            .pipe(map(function (res) {
            /** @type {?} */
            var displayResult = [];
            res.list.entries.forEach(function (member) {
                displayResult.push(_this.formattedRoleName(member.entry.displayName, 'site_' + siteName));
            });
            return displayResult;
        }));
    };
    /**
     * Gets all members related to a group name.
     * @param groupName Name of group to look for members
     * @param opts Extra options supported by JSAPI
     * @returns List of members
     */
    /**
     * Gets all members related to a group name.
     * @param {?} groupName Name of group to look for members
     * @param {?=} opts Extra options supported by JSAPI
     * @return {?} List of members
     */
    NodePermissionService.prototype.getGroupMemeberByGroupName = /**
     * Gets all members related to a group name.
     * @param {?} groupName Name of group to look for members
     * @param {?=} opts Extra options supported by JSAPI
     * @return {?} List of members
     */
    function (groupName, opts) {
        return from(this.apiService.groupsApi.getGroupMembers(groupName, opts));
    };
    /**
     * @param {?} displayName
     * @param {?} siteName
     * @return {?}
     */
    NodePermissionService.prototype.formattedRoleName = /**
     * @param {?} displayName
     * @param {?} siteName
     * @return {?}
     */
    function (displayName, siteName) {
        return displayName.replace(siteName + '_', '');
    };
    /**
     * @param {?} nodePath
     * @return {?}
     */
    NodePermissionService.prototype.buildRetrieveSiteQueryBody = /**
     * @param {?} nodePath
     * @return {?}
     */
    function (nodePath) {
        /** @type {?} */
        var pathNames = nodePath.map(function (node) { return 'name: "' + node.name + '"'; });
        /** @type {?} */
        var buildedPathNames = pathNames.join(' OR ');
        return {
            'query': {
                'query': buildedPathNames
            },
            'paging': {
                'maxItems': 100,
                'skipCount': 0
            },
            'include': ['aspectNames', 'properties'],
            'filterQueries': [
                {
                    'query': "TYPE:'st:site'"
                }
            ]
        };
    };
    NodePermissionService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    NodePermissionService.ctorParameters = function () { return [
        { type: AlfrescoApiService },
        { type: SearchService },
        { type: NodesApiService },
        { type: TranslationService }
    ]; };
    return NodePermissionService;
}());
export { NodePermissionService };
if (false) {
    /** @type {?} */
    NodePermissionService.prototype.apiService;
    /** @type {?} */
    NodePermissionService.prototype.searchApiService;
    /** @type {?} */
    NodePermissionService.prototype.nodeService;
    /** @type {?} */
    NodePermissionService.prototype.translation;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm9kZS1wZXJtaXNzaW9uLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYWxmcmVzY28vYWRmLWNvbnRlbnQtc2VydmljZXMvIiwic291cmNlcyI6WyJwZXJtaXNzaW9uLW1hbmFnZXIvc2VydmljZXMvbm9kZS1wZXJtaXNzaW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFpQkEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQWMsRUFBRSxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDeEQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLGFBQWEsRUFBRSxlQUFlLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUU1RyxPQUFPLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDOztJQUs1QywrQkFBb0IsVUFBOEIsRUFDOUIsa0JBQ0EsYUFDQTtRQUhBLGVBQVUsR0FBVixVQUFVLENBQW9CO1FBQzlCLHFCQUFnQixHQUFoQixnQkFBZ0I7UUFDaEIsZ0JBQVcsR0FBWCxXQUFXO1FBQ1gsZ0JBQVcsR0FBWCxXQUFXO0tBQzlCO0lBRUQ7Ozs7T0FJRzs7Ozs7O0lBQ0gsNENBQVk7Ozs7O0lBQVosVUFBYSxJQUE0QjtRQUF6QyxpQkFhQzs7UUFaRyxJQUFNLHFCQUFxQixHQUFjLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzdGLE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLGlCQUFpQixDQUFDLHFCQUFxQixDQUFDO2FBQ2hFLElBQUksQ0FDRCxTQUFTLENBQUMsVUFBQyxZQUFpQjtZQUN4QixJQUFLLFlBQVksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUc7O2dCQUN4QyxJQUFJLFFBQVEsR0FB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QUFDLEdBQUcsQ0FBQyxVQUFDLElBQWlCLElBQUssT0FBQSxTQUFTLEdBQUcsSUFBSSxDQUFDLElBQUksR0FBRyxHQUFHLEVBQTNCLENBQTJCLENBQUMsQ0FBQzs7UUFDbkYsSUFBTSxnQkFBZ0IsR0FBRyxTQUFTLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ2hELE9BQU87WUFDSCxPQUFPLEVBQUU7Z0JBQ0wsT0FBTyxFQUFFLGdCQUFnQjthQUM1QjtZQUNELFFBQVEsRUFBRTtnQkFDTixVQUFVLEVBQUUsR0FBRztnQkFDZixXQUFXLEVBQUUsQ0FBQzthQUNqQjtZQUNELFNBQVMsRUFBRSxDQUFDLGFBQWEsRUFBRSxZQUFZLENBQUM7WUFDeEMsZUFBZSxFQUFFO2dCQUNiO29CQUNJLE9BQU8sRUFDSCxnQkFBZ0I7aUJBQ3ZCO2FBQ0o7U0FDSixDQUFDOzs7Z0JBbExULFVBQVU7Ozs7Z0JBSkYsa0JBQWtCO2dCQUFFLGFBQWE7Z0JBQUUsZUFBZTtnQkFBRSxrQkFBa0I7O2dDQW5CL0U7O1NBd0JhLHFCQUFxQiIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE2IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mLCBmcm9tLCB0aHJvd0Vycm9yIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBBbGZyZXNjb0FwaVNlcnZpY2UsIFNlYXJjaFNlcnZpY2UsIE5vZGVzQXBpU2VydmljZSwgVHJhbnNsYXRpb25TZXJ2aWNlIH0gZnJvbSAnQGFsZnJlc2NvL2FkZi1jb3JlJztcbmltcG9ydCB7IFF1ZXJ5Qm9keSwgTWluaW1hbE5vZGVFbnRyeUVudGl0eSwgTWluaW1hbE5vZGVFbnRpdHksIFBhdGhFbGVtZW50LCBHcm91cE1lbWJlckVudHJ5LCBHcm91cHNQYWdpbmcsIEdyb3VwTWVtYmVyUGFnaW5nLCBQZXJtaXNzaW9uRWxlbWVudCB9IGZyb20gJ2FsZnJlc2NvLWpzLWFwaSc7XG5pbXBvcnQgeyBzd2l0Y2hNYXAsIG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE5vZGVQZXJtaXNzaW9uU2VydmljZSB7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFwaVNlcnZpY2U6IEFsZnJlc2NvQXBpU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIHNlYXJjaEFwaVNlcnZpY2U6IFNlYXJjaFNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBub2RlU2VydmljZTogTm9kZXNBcGlTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgdHJhbnNsYXRpb246IFRyYW5zbGF0aW9uU2VydmljZSkge1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgYSBsaXN0IG9mIHJvbGVzIGZvciB0aGUgY3VycmVudCBub2RlLlxuICAgICAqIEBwYXJhbSBub2RlIFRoZSB0YXJnZXQgbm9kZVxuICAgICAqIEByZXR1cm5zIEFycmF5IG9mIHN0cmluZ3MgcmVwcmVzZW50aW5nIHRoZSByb2xlc1xuICAgICAqL1xuICAgIGdldE5vZGVSb2xlcyhub2RlOiBNaW5pbWFsTm9kZUVudHJ5RW50aXR5KTogT2JzZXJ2YWJsZTxzdHJpbmdbXT4ge1xuICAgICAgICBjb25zdCByZXRyaWV2ZVNpdGVRdWVyeUJvZHk6IFF1ZXJ5Qm9keSA9IHRoaXMuYnVpbGRSZXRyaWV2ZVNpdGVRdWVyeUJvZHkobm9kZS5wYXRoLmVsZW1lbnRzKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2VhcmNoQXBpU2VydmljZS5zZWFyY2hCeVF1ZXJ5Qm9keShyZXRyaWV2ZVNpdGVRdWVyeUJvZHkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBzd2l0Y2hNYXAoKHNpdGVOb2RlTGlzdDogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmICggc2l0ZU5vZGVMaXN0Lmxpc3QuZW50cmllcy5sZW5ndGggPiAwICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHNpdGVOYW1lID0gc2l0ZU5vZGVMaXN0Lmxpc3QuZW50cmllc1swXS5lbnRyeS5uYW1lO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0R3JvdXBNZW1iZXJzQnlTaXRlTmFtZShzaXRlTmFtZSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2Yobm9kZS5wZXJtaXNzaW9ucy5zZXR0YWJsZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGVzIHRoZSBwZXJtaXNzaW9uIHJvbGUgZm9yIGEgbm9kZS5cbiAgICAgKiBAcGFyYW0gbm9kZSBUYXJnZXQgbm9kZVxuICAgICAqIEBwYXJhbSB1cGRhdGVkUGVybWlzc2lvblJvbGUgUGVybWlzc2lvbiByb2xlIHRvIHVwZGF0ZSBvciBhZGRcbiAgICAgKiBAcmV0dXJucyBOb2RlIHdpdGggdXBkYXRlZCBwZXJtaXNzaW9uXG4gICAgICovXG4gICAgdXBkYXRlUGVybWlzc2lvblJvbGUobm9kZTogTWluaW1hbE5vZGVFbnRyeUVudGl0eSwgdXBkYXRlZFBlcm1pc3Npb25Sb2xlOiBQZXJtaXNzaW9uRWxlbWVudCk6IE9ic2VydmFibGU8TWluaW1hbE5vZGVFbnRyeUVudGl0eT4ge1xuICAgICAgICBsZXQgcGVybWlzc2lvbkJvZHkgPSB7IHBlcm1pc3Npb25zOiB7IGxvY2FsbHlTZXQ6IFtdfSB9O1xuICAgICAgICBjb25zdCBpbmRleCA9IG5vZGUucGVybWlzc2lvbnMubG9jYWxseVNldC5tYXAoKHBlcm1pc3Npb24pID0+IHBlcm1pc3Npb24uYXV0aG9yaXR5SWQpLmluZGV4T2YodXBkYXRlZFBlcm1pc3Npb25Sb2xlLmF1dGhvcml0eUlkKTtcbiAgICAgICAgcGVybWlzc2lvbkJvZHkucGVybWlzc2lvbnMubG9jYWxseVNldCA9IHBlcm1pc3Npb25Cb2R5LnBlcm1pc3Npb25zLmxvY2FsbHlTZXQuY29uY2F0KG5vZGUucGVybWlzc2lvbnMubG9jYWxseVNldCk7XG4gICAgICAgIGlmIChpbmRleCAhPT0gLTEpIHtcbiAgICAgICAgICAgIHBlcm1pc3Npb25Cb2R5LnBlcm1pc3Npb25zLmxvY2FsbHlTZXRbaW5kZXhdID0gdXBkYXRlZFBlcm1pc3Npb25Sb2xlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcGVybWlzc2lvbkJvZHkucGVybWlzc2lvbnMubG9jYWxseVNldC5wdXNoKHVwZGF0ZWRQZXJtaXNzaW9uUm9sZSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMubm9kZVNlcnZpY2UudXBkYXRlTm9kZShub2RlLmlkLCBwZXJtaXNzaW9uQm9keSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIHBlcm1pc3Npb25zIGZvciBhIG5vZGUuXG4gICAgICogQHBhcmFtIG5vZGVJZCBJRCBvZiB0aGUgdGFyZ2V0IG5vZGVcbiAgICAgKiBAcGFyYW0gcGVybWlzc2lvbkxpc3QgTmV3IHBlcm1pc3Npb24gc2V0dGluZ3NcbiAgICAgKiBAcmV0dXJucyBOb2RlIHdpdGggdXBkYXRlZCBwZXJtaXNzaW9uc1xuICAgICAqL1xuICAgIHVwZGF0ZU5vZGVQZXJtaXNzaW9ucyhub2RlSWQ6IHN0cmluZywgcGVybWlzc2lvbkxpc3Q6IE1pbmltYWxOb2RlRW50aXR5W10pOiBPYnNlcnZhYmxlPE1pbmltYWxOb2RlRW50cnlFbnRpdHk+IHtcbiAgICAgICByZXR1cm4gdGhpcy5ub2RlU2VydmljZS5nZXROb2RlKG5vZGVJZCkucGlwZShcbiAgICAgICAgICAgc3dpdGNoTWFwKG5vZGUgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldE5vZGVSb2xlcyhub2RlKS5waXBlKFxuICAgICAgICAgICAgICAgICAgICBzd2l0Y2hNYXAoKG5vZGVSb2xlcykgPT4gb2Yoe25vZGUsIG5vZGVSb2xlc30pIClcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICBzd2l0Y2hNYXAoKHtub2RlLCBub2RlUm9sZXN9KSA9PiB0aGlzLnVwZGF0ZUxvY2FsbHlTZXRQZXJtaXNzaW9ucyhub2RlLCBwZXJtaXNzaW9uTGlzdCwgbm9kZVJvbGVzKSlcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGVzIHRoZSBsb2NhbGx5IHNldCBwZXJtaXNzaW9ucyBmb3IgYSBub2RlLlxuICAgICAqIEBwYXJhbSBub2RlIElEIG9mIHRoZSB0YXJnZXQgbm9kZVxuICAgICAqIEBwYXJhbSBub2RlcyBQZXJtaXNzaW9uIHNldHRpbmdzXG4gICAgICogQHBhcmFtIG5vZGVSb2xlIFBlcm1pc3Npb24gcm9sZVxuICAgICAqIEByZXR1cm5zIE5vZGUgd2l0aCB1cGRhdGVkIHBlcm1pc3Npb25zXG4gICAgICovXG4gICAgdXBkYXRlTG9jYWxseVNldFBlcm1pc3Npb25zKG5vZGU6IE1pbmltYWxOb2RlRW50cnlFbnRpdHksIG5vZGVzOiBNaW5pbWFsTm9kZUVudGl0eVtdLCBub2RlUm9sZTogc3RyaW5nW10pOiBPYnNlcnZhYmxlPE1pbmltYWxOb2RlRW50cnlFbnRpdHk+IHtcbiAgICAgICAgbGV0IHBlcm1pc3Npb25Cb2R5ID0geyBwZXJtaXNzaW9uczogeyBsb2NhbGx5U2V0OiBbXX0gfTtcbiAgICAgICAgY29uc3QgcGVybWlzc2lvbkxpc3QgPSB0aGlzLnRyYW5zZm9ybU5vZGVUb1Blcm1pc3Npb25FbGVtZW50KG5vZGVzLCBub2RlUm9sZVswXSk7XG4gICAgICAgIGNvbnN0IGR1cGxpY2F0ZWRQZXJtaXNzaW9ucyA9IHRoaXMuZ2V0RHVwbGljYXRlZFBlcm1pc3Npb25zKG5vZGUucGVybWlzc2lvbnMubG9jYWxseVNldCwgcGVybWlzc2lvbkxpc3QpO1xuICAgICAgICBpZiAoZHVwbGljYXRlZFBlcm1pc3Npb25zLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGNvbnN0IGxpc3QgPSBkdXBsaWNhdGVkUGVybWlzc2lvbnMubWFwKChwZXJtaXNzaW9uKSA9PiAnYXV0aG9yaXR5IC0+ICcgKyBwZXJtaXNzaW9uLmF1dGhvcml0eUlkICsgJyAvIHJvbGUgLT4gJyArIHBlcm1pc3Npb24ubmFtZSkuam9pbignLCAnKTtcbiAgICAgICAgICAgIGNvbnN0IGR1cGxpY2F0ZVBlcm1pc3Npb25NZXNzYWdlOiBzdHJpbmcgPSB0aGlzLnRyYW5zbGF0aW9uLmluc3RhbnQoJ1BFUk1JU1NJT05fTUFOQUdFUi5FUlJPUi5EVVBMSUNBVEUtUEVSTUlTU0lPTicsICB7bGlzdH0pO1xuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoZHVwbGljYXRlUGVybWlzc2lvbk1lc3NhZ2UpO1xuICAgICAgICB9XG4gICAgICAgIHBlcm1pc3Npb25Cb2R5LnBlcm1pc3Npb25zLmxvY2FsbHlTZXQgPSBub2RlLnBlcm1pc3Npb25zLmxvY2FsbHlTZXQgPyBub2RlLnBlcm1pc3Npb25zLmxvY2FsbHlTZXQuY29uY2F0KHBlcm1pc3Npb25MaXN0KSA6IHBlcm1pc3Npb25MaXN0O1xuICAgICAgICByZXR1cm4gdGhpcy5ub2RlU2VydmljZS51cGRhdGVOb2RlKG5vZGUuaWQsIHBlcm1pc3Npb25Cb2R5KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldER1cGxpY2F0ZWRQZXJtaXNzaW9ucyhub2RlTG9jYWxseVNldDogUGVybWlzc2lvbkVsZW1lbnRbXSwgcGVybWlzc2lvbkxpc3RBZGRlZDogUGVybWlzc2lvbkVsZW1lbnRbXSk6IFBlcm1pc3Npb25FbGVtZW50W10ge1xuICAgICAgICBsZXQgZHVwbGljYXRlUGVybWlzc2lvbnM6IFBlcm1pc3Npb25FbGVtZW50W10gPSBbXTtcbiAgICAgICAgaWYgKG5vZGVMb2NhbGx5U2V0KSB7XG4gICAgICAgICAgICBwZXJtaXNzaW9uTGlzdEFkZGVkLmZvckVhY2goKHBlcm1pc3Npb246IFBlcm1pc3Npb25FbGVtZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgZHVwbGljYXRlID0gbm9kZUxvY2FsbHlTZXQuZmluZCgobG9jYWxQZXJtaXNzaW9uKSA9PiB0aGlzLmlzRXF1YWxQZXJtaXNzaW9uKGxvY2FsUGVybWlzc2lvbiwgcGVybWlzc2lvbikpO1xuICAgICAgICAgICAgICAgIGlmIChkdXBsaWNhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgZHVwbGljYXRlUGVybWlzc2lvbnMucHVzaChkdXBsaWNhdGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBkdXBsaWNhdGVQZXJtaXNzaW9ucztcbiAgICB9XG5cbiAgICBwcml2YXRlIGlzRXF1YWxQZXJtaXNzaW9uKG9sZFBlcm1pc3Npb246IFBlcm1pc3Npb25FbGVtZW50LCBuZXdQZXJtaXNzaW9uOiBQZXJtaXNzaW9uRWxlbWVudCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gb2xkUGVybWlzc2lvbi5hY2Nlc3NTdGF0dXMgPT09IG5ld1Blcm1pc3Npb24uYWNjZXNzU3RhdHVzICYmXG4gICAgICAgICAgICAgICBvbGRQZXJtaXNzaW9uLmF1dGhvcml0eUlkID09PSBuZXdQZXJtaXNzaW9uLmF1dGhvcml0eUlkICYmXG4gICAgICAgICAgICAgICBvbGRQZXJtaXNzaW9uLm5hbWUgPT09IG5ld1Blcm1pc3Npb24ubmFtZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHRyYW5zZm9ybU5vZGVUb1Blcm1pc3Npb25FbGVtZW50KG5vZGVzOiBNaW5pbWFsTm9kZUVudGl0eVtdLCBub2RlUm9sZTogYW55KTogUGVybWlzc2lvbkVsZW1lbnRbXSB7XG4gICAgICAgIHJldHVybiBub2Rlcy5tYXAoKG5vZGUpID0+IHtcbiAgICAgICAgICAgIGxldCBuZXdQZXJtaXNzaW9uRWxlbWVudDogUGVybWlzc2lvbkVsZW1lbnQgPSA8UGVybWlzc2lvbkVsZW1lbnQ+IHtcbiAgICAgICAgICAgICAgICAnYXV0aG9yaXR5SWQnOiBub2RlLmVudHJ5LnByb3BlcnRpZXNbJ2NtOmF1dGhvcml0eU5hbWUnXSA/XG4gICAgICAgICAgICAgICAgICAgIG5vZGUuZW50cnkucHJvcGVydGllc1snY206YXV0aG9yaXR5TmFtZSddIDpcbiAgICAgICAgICAgICAgICAgICAgbm9kZS5lbnRyeS5wcm9wZXJ0aWVzWydjbTp1c2VyTmFtZSddLFxuICAgICAgICAgICAgICAgICduYW1lJzogbm9kZVJvbGUsXG4gICAgICAgICAgICAgICAgJ2FjY2Vzc1N0YXR1cyc6ICdBTExPV0VEJ1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHJldHVybiBuZXdQZXJtaXNzaW9uRWxlbWVudDtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVtb3ZlcyBhIHBlcm1pc3Npb24gc2V0dGluZyBmcm9tIGEgbm9kZS5cbiAgICAgKiBAcGFyYW0gbm9kZSBJRCBvZiB0aGUgdGFyZ2V0IG5vZGVcbiAgICAgKiBAcGFyYW0gcGVybWlzc2lvblRvUmVtb3ZlIFBlcm1pc3Npb24gc2V0dGluZyB0byByZW1vdmVcbiAgICAgKiBAcmV0dXJucyBOb2RlIHdpdGggbW9kaWZpZWQgcGVybWlzc2lvbnNcbiAgICAgKi9cbiAgICByZW1vdmVQZXJtaXNzaW9uKG5vZGU6IE1pbmltYWxOb2RlRW50cnlFbnRpdHksIHBlcm1pc3Npb25Ub1JlbW92ZTogUGVybWlzc2lvbkVsZW1lbnQpOiBPYnNlcnZhYmxlPE1pbmltYWxOb2RlRW50cnlFbnRpdHk+IHtcbiAgICAgICAgbGV0IHBlcm1pc3Npb25Cb2R5ID0geyBwZXJtaXNzaW9uczogeyBsb2NhbGx5U2V0OiBbXSB9IH07XG4gICAgICAgIGNvbnN0IGluZGV4ID0gbm9kZS5wZXJtaXNzaW9ucy5sb2NhbGx5U2V0Lm1hcCgocGVybWlzc2lvbikgPT4gcGVybWlzc2lvbi5hdXRob3JpdHlJZCkuaW5kZXhPZihwZXJtaXNzaW9uVG9SZW1vdmUuYXV0aG9yaXR5SWQpO1xuICAgICAgICBpZiAoaW5kZXggIT09IC0xKSB7XG4gICAgICAgICAgICBub2RlLnBlcm1pc3Npb25zLmxvY2FsbHlTZXQuc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgICAgICAgIHBlcm1pc3Npb25Cb2R5LnBlcm1pc3Npb25zLmxvY2FsbHlTZXQgPSBub2RlLnBlcm1pc3Npb25zLmxvY2FsbHlTZXQ7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5ub2RlU2VydmljZS51cGRhdGVOb2RlKG5vZGUuaWQsIHBlcm1pc3Npb25Cb2R5KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0R3JvdXBNZW1iZXJzQnlTaXRlTmFtZShzaXRlTmFtZTogc3RyaW5nKTogT2JzZXJ2YWJsZTxzdHJpbmdbXT4ge1xuICAgICAgICBjb25zdCBncm91cE5hbWUgPSAnR1JPVVBfc2l0ZV8nICsgc2l0ZU5hbWU7XG4gICAgICAgIHJldHVybiB0aGlzLmdldEdyb3VwTWVtZWJlckJ5R3JvdXBOYW1lKGdyb3VwTmFtZSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1hcCgocmVzOiBHcm91cHNQYWdpbmcpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGRpc3BsYXlSZXN1bHQ6IHN0cmluZ1tdID0gW107XG4gICAgICAgICAgICAgICAgICAgIHJlcy5saXN0LmVudHJpZXMuZm9yRWFjaCgobWVtYmVyOiBHcm91cE1lbWJlckVudHJ5KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5UmVzdWx0LnB1c2godGhpcy5mb3JtYXR0ZWRSb2xlTmFtZShtZW1iZXIuZW50cnkuZGlzcGxheU5hbWUsICdzaXRlXycgKyBzaXRlTmFtZSkpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRpc3BsYXlSZXN1bHQ7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBhbGwgbWVtYmVycyByZWxhdGVkIHRvIGEgZ3JvdXAgbmFtZS5cbiAgICAgKiBAcGFyYW0gZ3JvdXBOYW1lIE5hbWUgb2YgZ3JvdXAgdG8gbG9vayBmb3IgbWVtYmVyc1xuICAgICAqIEBwYXJhbSBvcHRzIEV4dHJhIG9wdGlvbnMgc3VwcG9ydGVkIGJ5IEpTQVBJXG4gICAgICogQHJldHVybnMgTGlzdCBvZiBtZW1iZXJzXG4gICAgICovXG4gICAgZ2V0R3JvdXBNZW1lYmVyQnlHcm91cE5hbWUoZ3JvdXBOYW1lOiBzdHJpbmcsIG9wdHM/OiBhbnkpOiBPYnNlcnZhYmxlPEdyb3VwTWVtYmVyUGFnaW5nPiB7XG4gICAgICAgIHJldHVybiBmcm9tPEdyb3VwTWVtYmVyUGFnaW5nPih0aGlzLmFwaVNlcnZpY2UuZ3JvdXBzQXBpLmdldEdyb3VwTWVtYmVycyhncm91cE5hbWUsIG9wdHMpKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGZvcm1hdHRlZFJvbGVOYW1lKGRpc3BsYXlOYW1lLCBzaXRlTmFtZSk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBkaXNwbGF5TmFtZS5yZXBsYWNlKHNpdGVOYW1lICsgJ18nLCAnJyk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBidWlsZFJldHJpZXZlU2l0ZVF1ZXJ5Qm9keShub2RlUGF0aDogUGF0aEVsZW1lbnRbXSk6IFF1ZXJ5Qm9keSB7XG4gICAgICAgIGNvbnN0IHBhdGhOYW1lcyA9IG5vZGVQYXRoLm1hcCgobm9kZTogUGF0aEVsZW1lbnQpID0+ICduYW1lOiBcIicgKyBub2RlLm5hbWUgKyAnXCInKTtcbiAgICAgICAgY29uc3QgYnVpbGRlZFBhdGhOYW1lcyA9IHBhdGhOYW1lcy5qb2luKCcgT1IgJyk7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAncXVlcnknOiB7XG4gICAgICAgICAgICAgICAgJ3F1ZXJ5JzogYnVpbGRlZFBhdGhOYW1lc1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICdwYWdpbmcnOiB7XG4gICAgICAgICAgICAgICAgJ21heEl0ZW1zJzogMTAwLFxuICAgICAgICAgICAgICAgICdza2lwQ291bnQnOiAwXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgJ2luY2x1ZGUnOiBbJ2FzcGVjdE5hbWVzJywgJ3Byb3BlcnRpZXMnXSxcbiAgICAgICAgICAgICdmaWx0ZXJRdWVyaWVzJzogW1xuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgJ3F1ZXJ5JzpcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiVFlQRTonc3Q6c2l0ZSdcIlxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIF1cbiAgICAgICAgfTtcbiAgICB9XG5cbn1cbiJdfQ==