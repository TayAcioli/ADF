/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
/*!
 * @license
 * Copyright 2016 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import * as tslib_1 from "tslib";
import { Component, ViewEncapsulation } from '@angular/core';
import { SearchService, TranslationService } from '@alfresco/adf-core';
import { SearchQueryBuilderService } from '../../search-query-builder.service';
import { ResponseFacetQueryList } from './models/response-facet-query-list.model';
import { SearchFilterList } from './models/search-filter-list.model';
import { takeWhile } from 'rxjs/operators';
var SearchFilterComponent = /** @class */ (function () {
    function SearchFilterComponent(queryBuilder, searchService, translationService) {
        var _this = this;
        this.queryBuilder = queryBuilder;
        this.searchService = searchService;
        this.translationService = translationService;
        this.DEFAULT_PAGE_SIZE = 5;
        this.isAlive = true;
        this.responseFacetQueries = null;
        this.responseFacetFields = null;
        this.facetQueriesPageSize = this.DEFAULT_PAGE_SIZE;
        this.facetQueriesLabel = 'Facet Queries';
        this.facetQueriesExpanded = false;
        this.facetFieldsExpanded = false;
        this.canResetSelectedQueries = false;
        this.selectedFacetQueries = [];
        this.selectedBuckets = [];
        if (queryBuilder.config && queryBuilder.config.facetQueries) {
            this.facetQueriesLabel = queryBuilder.config.facetQueries.label || 'Facet Queries';
            this.facetQueriesPageSize = queryBuilder.config.facetQueries.pageSize || this.DEFAULT_PAGE_SIZE;
            this.facetQueriesExpanded = queryBuilder.config.facetQueries.expanded;
        }
        if (queryBuilder.config && queryBuilder.config.facetFields) {
            this.facetFieldsExpanded = queryBuilder.config.facetFields.expanded;
        }
        this.queryBuilder.updated.pipe(takeWhile(function () { return _this.isAlive; })).subscribe(function () {
            _this.queryBuilder.execute();
        });
    }
    /**
     * @return {?}
     */
    SearchFilterComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        if (this.queryBuilder) {
            this.queryBuilder.executed.pipe(takeWhile(function () { return _this.isAlive; })).subscribe(function (data) {
                _this.onDataLoaded(data);
                _this.searchService.dataLoaded.next(data);
            });
        }
    };
    /**
     * @return {?}
     */
    SearchFilterComponent.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        this.isAlive = false;
    };
    /**
     * @param {?} event
     * @param {?} facetQuery
     * @return {?}
     */
    SearchFilterComponent.prototype.onToggleFacetQuery = /**
     * @param {?} event
     * @param {?} facetQuery
     * @return {?}
     */
    function (event, facetQuery) {
        if (event && facetQuery) {
            if (event.checked) {
                this.selectFacetQuery(facetQuery);
            }
            else {
                this.unselectFacetQuery(facetQuery);
            }
        }
    };
    /**
     * @param {?} query
     * @return {?}
     */
    SearchFilterComponent.prototype.selectFacetQuery = /**
     * @param {?} query
     * @return {?}
     */
    function (query) {
        if (query) {
            query.checked = true;
            this.queryBuilder.addUserFacetQuery(query);
            this.updateSelectedFields();
            this.queryBuilder.update();
        }
    };
    /**
     * @param {?} query
     * @return {?}
     */
    SearchFilterComponent.prototype.unselectFacetQuery = /**
     * @param {?} query
     * @return {?}
     */
    function (query) {
        if (query) {
            query.checked = false;
            this.queryBuilder.removeUserFacetQuery(query);
            this.updateSelectedFields();
            this.queryBuilder.update();
        }
    };
    /**
     * @return {?}
     */
    SearchFilterComponent.prototype.updateSelectedBuckets = /**
     * @return {?}
     */
    function () {
        var e_1, _a;
        if (this.responseFacetFields) {
            this.selectedBuckets = [];
            var _loop_1 = function (field) {
                var _a;
                if (field.buckets) {
                    (_a = this_1.selectedBuckets).push.apply(_a, tslib_1.__spread(this_1.queryBuilder.getUserFacetBuckets(field.field)
                        .filter(function (bucket) { return bucket.checked; })
                        .map(function (bucket) {
                        return { field: field, bucket: bucket };
                    })));
                }
            };
            var this_1 = this;
            try {
                for (var _b = tslib_1.__values(this.responseFacetFields), _c = _b.next(); !_c.done; _c = _b.next()) {
                    var field = _c.value;
                    _loop_1(field);
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
                }
                finally { if (e_1) throw e_1.error; }
            }
        }
        else {
            this.selectedBuckets = [];
        }
    };
    /**
     * @return {?}
     */
    SearchFilterComponent.prototype.updateSelectedFields = /**
     * @return {?}
     */
    function () {
        if (this.responseFacetQueries) {
            this.selectedFacetQueries = this.responseFacetQueries.items.filter(function (item) { return item.checked; });
            this.canResetSelectedQueries = this.selectedFacetQueries.length > 0;
        }
        else {
            this.selectedFacetQueries = [];
            this.canResetSelectedQueries = false;
        }
    };
    /**
     * @param {?} event
     * @param {?} field
     * @param {?} bucket
     * @return {?}
     */
    SearchFilterComponent.prototype.onToggleBucket = /**
     * @param {?} event
     * @param {?} field
     * @param {?} bucket
     * @return {?}
     */
    function (event, field, bucket) {
        if (event && bucket) {
            if (event.checked) {
                this.selectFacetBucket(field, bucket);
            }
            else {
                this.unselectFacetBucket(field, bucket);
            }
        }
    };
    /**
     * @param {?} field
     * @param {?} bucket
     * @return {?}
     */
    SearchFilterComponent.prototype.selectFacetBucket = /**
     * @param {?} field
     * @param {?} bucket
     * @return {?}
     */
    function (field, bucket) {
        if (bucket) {
            bucket.checked = true;
            this.queryBuilder.addUserFacetBucket(field, bucket);
            this.updateSelectedBuckets();
            this.queryBuilder.update();
        }
    };
    /**
     * @param {?} field
     * @param {?} bucket
     * @return {?}
     */
    SearchFilterComponent.prototype.unselectFacetBucket = /**
     * @param {?} field
     * @param {?} bucket
     * @return {?}
     */
    function (field, bucket) {
        if (bucket) {
            bucket.checked = false;
            this.queryBuilder.removeUserFacetBucket(field, bucket);
            this.updateSelectedBuckets();
            this.queryBuilder.update();
        }
    };
    /**
     * @return {?}
     */
    SearchFilterComponent.prototype.resetSelectedQueries = /**
     * @return {?}
     */
    function () {
        var e_2, _a;
        if (this.canResetSelectedQueries) {
            try {
                for (var _b = tslib_1.__values(this.responseFacetQueries.items), _c = _b.next(); !_c.done; _c = _b.next()) {
                    var query = _c.value;
                    query.checked = false;
                    this.queryBuilder.removeUserFacetQuery(query);
                }
            }
            catch (e_2_1) { e_2 = { error: e_2_1 }; }
            finally {
                try {
                    if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
                }
                finally { if (e_2) throw e_2.error; }
            }
            this.selectedFacetQueries = [];
            this.canResetSelectedQueries = false;
            this.queryBuilder.update();
        }
    };
    /**
     * @param {?} field
     * @return {?}
     */
    SearchFilterComponent.prototype.canResetSelectedBuckets = /**
     * @param {?} field
     * @return {?}
     */
    function (field) {
        if (field && field.buckets) {
            return field.buckets.items.some(function (bucket) { return bucket.checked; });
        }
        return false;
    };
    /**
     * @param {?} field
     * @return {?}
     */
    SearchFilterComponent.prototype.resetSelectedBuckets = /**
     * @param {?} field
     * @return {?}
     */
    function (field) {
        var e_3, _a;
        if (field && field.buckets) {
            try {
                for (var _b = tslib_1.__values(field.buckets.items), _c = _b.next(); !_c.done; _c = _b.next()) {
                    var bucket = _c.value;
                    bucket.checked = false;
                    this.queryBuilder.removeUserFacetBucket(field, bucket);
                }
            }
            catch (e_3_1) { e_3 = { error: e_3_1 }; }
            finally {
                try {
                    if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
                }
                finally { if (e_3) throw e_3.error; }
            }
            this.updateSelectedBuckets();
            this.queryBuilder.update();
        }
    };
    /**
     * @param {?} data
     * @return {?}
     */
    SearchFilterComponent.prototype.onDataLoaded = /**
     * @param {?} data
     * @return {?}
     */
    function (data) {
        /** @type {?} */
        var context = data.list.context;
        if (context) {
            this.parseFacetFields(context);
            this.parseFacetQueries(context);
        }
        else {
            this.responseFacetQueries = null;
            this.responseFacetFields = null;
        }
    };
    /**
     * @param {?} context
     * @return {?}
     */
    SearchFilterComponent.prototype.parseFacetFields = /**
     * @param {?} context
     * @return {?}
     */
    function (context) {
        var _this = this;
        if (!this.responseFacetFields) {
            /** @type {?} */
            var configFacetFields = this.queryBuilder.config.facetFields && this.queryBuilder.config.facetFields.fields || [];
            this.responseFacetFields = configFacetFields.map(function (field) {
                /** @type {?} */
                var responseField = (context.facetsFields || []).find(function (response) { return response.label === field.label; });
                /** @type {?} */
                var buckets = ((responseField && responseField.buckets) || []).map(function (bucket) {
                    /** @type {?} */
                    var selectedBucket = _this.selectedBuckets.find(function (facetBucket) {
                        return facetBucket.bucket.label === bucket.label && facetBucket.field.field === field.field;
                    });
                    return /** @type {?} */ (tslib_1.__assign({}, bucket, { checked: !!selectedBucket, display: _this.translationService.instant(bucket.display), label: _this.translationService.instant(bucket.label) }));
                });
                /** @type {?} */
                var bucketList = new SearchFilterList(buckets, field.pageSize);
                bucketList.filter = function (bucket) {
                    if (bucket && bucketList.filterText) {
                        /** @type {?} */
                        var pattern = (bucketList.filterText || '').toLowerCase();
                        /** @type {?} */
                        var label = (bucket.display || bucket.label || '').toLowerCase();
                        return label.startsWith(pattern);
                    }
                    return true;
                };
                return tslib_1.__assign({}, field, { label: _this.translationService.instant(field.label), pageSize: field.pageSize | _this.DEFAULT_PAGE_SIZE, currentPageSize: field.pageSize | _this.DEFAULT_PAGE_SIZE, buckets: bucketList });
            });
        }
        else {
            this.responseFacetFields = this.responseFacetFields
                .map(function (field) {
                /** @type {?} */
                var responseField = (context.facetsFields || []).find(function (response) { return response.label === field.label; });
                (field && field.buckets && field.buckets.items || [])
                    .map(function (bucket) {
                    /** @type {?} */
                    var responseBucket = ((responseField && responseField.buckets) || []).find(function (respBucket) { return respBucket.label === bucket.label; });
                    bucket.count = responseBucket ? responseBucket.count : 0;
                    return bucket;
                });
                return field;
            });
        }
    };
    /**
     * @param {?} context
     * @return {?}
     */
    SearchFilterComponent.prototype.parseFacetQueries = /**
     * @param {?} context
     * @return {?}
     */
    function (context) {
        var _this = this;
        /** @type {?} */
        var responseQueries = this.getFacetQueryMap(context);
        if (this.queryBuilder.config.facetQueries) {
            /** @type {?} */
            var bkpResponseFacetQueries_1 = Object.assign({}, this.responseFacetQueries);
            /** @type {?} */
            var facetQueries = (this.queryBuilder.config.facetQueries.queries || [])
                .map(function (query) {
                /** @type {?} */
                var queryResult = responseQueries[query.label];
                /** @type {?} */
                var bkpQuery = (bkpResponseFacetQueries_1.items || []).find(function (item) { return item.label === query.label; });
                if (bkpQuery) {
                    bkpQuery.count = queryResult.count;
                    return bkpQuery;
                }
                return /** @type {?} */ (tslib_1.__assign({}, query, { label: _this.translationService.instant(query.label), count: queryResult.count }));
            });
            if (facetQueries.length > 0) {
                if (this.responseFacetQueries) {
                    this.responseFacetQueries.items = facetQueries;
                }
                else {
                    this.responseFacetQueries = new ResponseFacetQueryList(facetQueries, this.facetQueriesPageSize);
                }
            }
            else {
                this.responseFacetQueries = null;
            }
        }
    };
    /**
     * @param {?} context
     * @return {?}
     */
    SearchFilterComponent.prototype.getFacetQueryMap = /**
     * @param {?} context
     * @return {?}
     */
    function (context) {
        /** @type {?} */
        var result = {};
        (context.facetQueries || []).forEach(function (query) {
            result[query.label] = query;
        });
        return result;
    };
    SearchFilterComponent.decorators = [
        { type: Component, args: [{
                    selector: 'adf-search-filter',
                    template: "<mat-accordion multi=\"true\" displayMode=\"flat\">\n\n    <mat-expansion-panel\n        *ngFor=\"let category of queryBuilder.categories\"\n        [attr.data-automation-id]=\"'expansion-panel-'+category.name\"\n        [(expanded)]=\"category.expanded\">\n        <mat-expansion-panel-header>\n            <mat-panel-title>\n                {{ category.name | translate }}\n            </mat-panel-title>\n        </mat-expansion-panel-header>\n        <adf-search-widget-container\n            [id]=\"category.id\"\n            [selector]=\"category.component.selector\"\n            [settings]=\"category.component.settings\">\n        </adf-search-widget-container>\n    </mat-expansion-panel>\n\n    <ng-container *ngIf=\"responseFacetQueries\">\n        <mat-expansion-panel [expanded]=\"facetQueriesExpanded\" [attr.data-automation-id]=\"'expansion-panel-'+facetQueriesLabel\">\n            <mat-expansion-panel-header>\n                <mat-panel-title>{{ facetQueriesLabel | translate }}</mat-panel-title>\n            </mat-expansion-panel-header>\n            <div class=\"facet-result-filter\">\n                <mat-form-field>\n                    <input\n                        matInput\n                        placeholder=\"{{ 'SEARCH.FILTER.ACTIONS.FILTER-CATEGORY' | translate }}\"\n                        [attr.data-automation-id]=\"'facet-result-filter-'+facetQueriesLabel\"\n                        [(ngModel)]=\"responseFacetQueries.filterText\">\n                    <button *ngIf=\"responseFacetQueries.filterText\"\n                        mat-button matSuffix mat-icon-button\n                        (click)=\"responseFacetQueries.filterText = ''\">\n                        <mat-icon>close</mat-icon>\n                    </button>\n                </mat-form-field>\n            </div>\n            <div class=\"checklist\">\n                <ng-container *ngFor=\"let query of responseFacetQueries\">\n                    <mat-checkbox\n                        [checked]=\"query.checked\"\n                        [attr.data-automation-id]=\"'checkbox-'+facetQueriesLabel+'-'+query.label\"\n                        (change)=\"onToggleFacetQuery($event, query)\">\n                        {{ query.label }} ({{ query.count }})\n                    </mat-checkbox>\n                </ng-container>\n            </div>\n            <div class=\"facet-buttons\">\n                <button mat-icon-button\n                    *ngIf=\"canResetSelectedQueries\"\n                    title=\"{{ 'SEARCH.FILTER.ACTIONS.CLEAR-ALL' | translate }}\"\n                    (click)=\"resetSelectedQueries()\">\n                    <mat-icon>clear</mat-icon>\n                </button>\n                <button mat-icon-button\n                    *ngIf=\"responseFacetQueries.canShowLessItems\"\n                    title=\"{{ 'SEARCH.FILTER.ACTIONS.SHOW-LESS' | translate }}\"\n                    (click)=\"responseFacetQueries.showLessItems()\">\n                    <mat-icon>keyboard_arrow_up</mat-icon>\n                </button>\n                <button mat-icon-button\n                    *ngIf=\"responseFacetQueries.canShowMoreItems\"\n                    title=\"{{ 'SEARCH.FILTER.ACTIONS.SHOW-MORE' | translate }}\"\n                    (click)=\"responseFacetQueries.showMoreItems()\">\n                    <mat-icon>keyboard_arrow_down</mat-icon>\n                </button>\n            </div>\n        </mat-expansion-panel>\n    </ng-container>\n\n    <ng-container *ngIf=\"responseFacetFields\">\n        <mat-expansion-panel [attr.data-automation-id]=\"'expansion-panel-'+field.label\" *ngFor=\"let field of responseFacetFields\"\n                             [expanded]=\"facetFieldsExpanded\">\n            <mat-expansion-panel-header>\n                <mat-panel-title>{{ field.label }}</mat-panel-title>\n            </mat-expansion-panel-header>\n\n            <div class=\"facet-result-filter\">\n                <mat-form-field>\n                    <input\n                        matInput\n                        placeholder=\"{{ 'SEARCH.FILTER.ACTIONS.FILTER-CATEGORY' | translate }}\"\n                        [attr.data-automation-id]=\"'facet-result-filter-'+field.label\"\n                        [(ngModel)]=\"field.buckets.filterText\">\n                    <button *ngIf=\"field.buckets.filterText\"\n                        mat-button matSuffix mat-icon-button\n                        (click)=\"field.buckets.filterText = ''\">\n                        <mat-icon>close</mat-icon>\n                    </button>\n                </mat-form-field>\n            </div>\n\n            <div class=\"checklist\">\n                <mat-checkbox\n                    *ngFor=\"let bucket of field.buckets\"\n                    [checked]=\"bucket.checked\"\n                    [attr.data-automation-id]=\"'checkbox-'+field.label+'-'+(bucket.display || bucket.label)\"\n                    (change)=\"onToggleBucket($event, field, bucket)\">\n                    {{ bucket.display || bucket.label }} <span *ngIf=\"bucket.count!==null\">(</span>{{ bucket.count }}<span *ngIf=\"bucket.count!==null\">)</span>\n                </mat-checkbox>\n            </div>\n\n            <div class=\"facet-buttons\" *ngIf=\"field.buckets.fitsPage\">\n                <button *ngIf=\"canResetSelectedBuckets(field)\"\n                    mat-button\n                    color=\"primary\"\n                    (click)=\"resetSelectedBuckets(field)\">\n                    {{ 'SEARCH.FILTER.ACTIONS.CLEAR-ALL' | translate }}\n                </button>\n            </div>\n\n            <div class=\"facet-buttons\" *ngIf=\"!field.buckets.fitsPage\">\n                <button mat-icon-button\n                    *ngIf=\"canResetSelectedBuckets(field)\"\n                    title=\"{{ 'SEARCH.FILTER.ACTIONS.CLEAR-ALL' | translate }}\"\n                    (click)=\"resetSelectedBuckets(field)\">\n                    <mat-icon>clear</mat-icon>\n                </button>\n                <button mat-icon-button\n                    *ngIf=\"field.buckets.canShowLessItems\"\n                    (click)=\"field.buckets.showLessItems()\"\n                    title=\"{{ 'SEARCH.FILTER.ACTIONS.SHOW-LESS' | translate }}\">\n                    <mat-icon>keyboard_arrow_up</mat-icon>\n                </button>\n                <button mat-icon-button\n                    *ngIf=\"field.buckets.canShowMoreItems\"\n                    (click)=\"field.buckets.showMoreItems()\"\n                    title=\"{{ 'SEARCH.FILTER.ACTIONS.SHOW-MORE' | translate }}\">\n                    <mat-icon>keyboard_arrow_down</mat-icon>\n                </button>\n            </div>\n        </mat-expansion-panel>\n    </ng-container>\n</mat-accordion>\n",
                    encapsulation: ViewEncapsulation.None,
                    host: { class: 'adf-search-filter' },
                    styles: [".adf-search-filter .checklist{display:flex;flex-direction:column}.adf-search-filter .checklist .mat-checkbox{margin:5px}.adf-search-filter .checklist .mat-checkbox.mat-checkbox-checked .mat-checkbox-label{font-weight:700}.adf-search-filter .facet-result-filter{display:flex;flex-direction:column}.adf-search-filter .facet-result-filter>*{width:100%}.adf-search-filter .facet-buttons{text-align:right}.adf-search-filter .facet-buttons .mat-button{text-transform:uppercase}.adf-search-filter .facet-buttons--topSpace{padding-top:15px}"]
                }] }
    ];
    /** @nocollapse */
    SearchFilterComponent.ctorParameters = function () { return [
        { type: SearchQueryBuilderService },
        { type: SearchService },
        { type: TranslationService }
    ]; };
    return SearchFilterComponent;
}());
export { SearchFilterComponent };
if (false) {
    /** @type {?} */
    SearchFilterComponent.prototype.DEFAULT_PAGE_SIZE;
    /** @type {?} */
    SearchFilterComponent.prototype.isAlive;
    /** @type {?} */
    SearchFilterComponent.prototype.responseFacetQueries;
    /** @type {?} */
    SearchFilterComponent.prototype.responseFacetFields;
    /** @type {?} */
    SearchFilterComponent.prototype.facetQueriesPageSize;
    /** @type {?} */
    SearchFilterComponent.prototype.facetQueriesLabel;
    /** @type {?} */
    SearchFilterComponent.prototype.facetQueriesExpanded;
    /** @type {?} */
    SearchFilterComponent.prototype.facetFieldsExpanded;
    /** @type {?} */
    SearchFilterComponent.prototype.canResetSelectedQueries;
    /** @type {?} */
    SearchFilterComponent.prototype.selectedFacetQueries;
    /** @type {?} */
    SearchFilterComponent.prototype.selectedBuckets;
    /** @type {?} */
    SearchFilterComponent.prototype.queryBuilder;
    /** @type {?} */
    SearchFilterComponent.prototype.searchService;
    /** @type {?} */
    SearchFilterComponent.prototype.translationService;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoLWZpbHRlci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYWxmcmVzY28vYWRmLWNvbnRlbnQtc2VydmljZXMvIiwic291cmNlcyI6WyJzZWFyY2gvY29tcG9uZW50cy9zZWFyY2gtZmlsdGVyL3NlYXJjaC1maWx0ZXIuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQWlCQSxPQUFPLEVBQUUsU0FBUyxFQUFFLGlCQUFpQixFQUFxQixNQUFNLGVBQWUsQ0FBQztBQUVoRixPQUFPLEVBQUUsYUFBYSxFQUFFLGtCQUFrQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDdkUsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFFL0UsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sMENBQTBDLENBQUM7QUFHbEYsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFDckUsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDOztJQTBCdkMsK0JBQW1CLFlBQXVDLEVBQ3RDLGVBQ0E7UUFGcEIsaUJBaUJDO1FBakJrQixpQkFBWSxHQUFaLFlBQVksQ0FBMkI7UUFDdEMsa0JBQWEsR0FBYixhQUFhO1FBQ2IsdUJBQWtCLEdBQWxCLGtCQUFrQjtpQ0FqQlYsQ0FBQzt1QkFFbkIsSUFBSTtvQ0FDaUMsSUFBSTttQ0FDZixJQUFJO29DQUVULElBQUksQ0FBQyxpQkFBaUI7aUNBQ3pCLGVBQWU7b0NBQ3BCLEtBQUs7bUNBQ04sS0FBSzt1Q0FDRCxLQUFLO29DQUVXLEVBQUU7K0JBQzhCLEVBQUU7UUFLeEUsSUFBSSxZQUFZLENBQUMsTUFBTSxJQUFJLFlBQVksQ0FBQyxNQUFNLENBQUMsWUFBWSxFQUFFO1lBQ3pELElBQUksQ0FBQyxpQkFBaUIsR0FBRyxZQUFZLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxLQUFLLElBQUksZUFBZSxD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QUFFLEVBQUUsS0FBSyxFQUFFLG1CQUFtQixFQUFFOztpQkFDdkM7Ozs7Z0JBZFEseUJBQXlCO2dCQUR6QixhQUFhO2dCQUFFLGtCQUFrQjs7Z0NBbkIxQzs7U0FtQ2EscUJBQXFCIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTYgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgQ29tcG9uZW50LCBWaWV3RW5jYXBzdWxhdGlvbiwgT25Jbml0LCBPbkRlc3Ryb3kgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE1hdENoZWNrYm94Q2hhbmdlIH0gZnJvbSAnQGFuZ3VsYXIvbWF0ZXJpYWwnO1xuaW1wb3J0IHsgU2VhcmNoU2VydmljZSwgVHJhbnNsYXRpb25TZXJ2aWNlIH0gZnJvbSAnQGFsZnJlc2NvL2FkZi1jb3JlJztcbmltcG9ydCB7IFNlYXJjaFF1ZXJ5QnVpbGRlclNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZWFyY2gtcXVlcnktYnVpbGRlci5zZXJ2aWNlJztcbmltcG9ydCB7IEZhY2V0RmllbGRCdWNrZXQgfSBmcm9tICcuLi8uLi9mYWNldC1maWVsZC1idWNrZXQuaW50ZXJmYWNlJztcbmltcG9ydCB7IFJlc3BvbnNlRmFjZXRRdWVyeUxpc3QgfSBmcm9tICcuL21vZGVscy9yZXNwb25zZS1mYWNldC1xdWVyeS1saXN0Lm1vZGVsJztcbmltcG9ydCB7IEZhY2V0UXVlcnkgfSBmcm9tICcuLi8uLi9mYWNldC1xdWVyeS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgRmFjZXRGaWVsZCB9IGZyb20gJy4uLy4uL2ZhY2V0LWZpZWxkLmludGVyZmFjZSc7XG5pbXBvcnQgeyBTZWFyY2hGaWx0ZXJMaXN0IH0gZnJvbSAnLi9tb2RlbHMvc2VhcmNoLWZpbHRlci1saXN0Lm1vZGVsJztcbmltcG9ydCB7IHRha2VXaGlsZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6ICdhZGYtc2VhcmNoLWZpbHRlcicsXG4gICAgdGVtcGxhdGVVcmw6ICcuL3NlYXJjaC1maWx0ZXIuY29tcG9uZW50Lmh0bWwnLFxuICAgIHN0eWxlVXJsczogWycuL3NlYXJjaC1maWx0ZXIuY29tcG9uZW50LnNjc3MnXSxcbiAgICBlbmNhcHN1bGF0aW9uOiBWaWV3RW5jYXBzdWxhdGlvbi5Ob25lLFxuICAgIGhvc3Q6IHsgY2xhc3M6ICdhZGYtc2VhcmNoLWZpbHRlcicgfVxufSlcbmV4cG9ydCBjbGFzcyBTZWFyY2hGaWx0ZXJDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSB7XG5cbiAgICBwcml2YXRlIERFRkFVTFRfUEFHRV9TSVpFID0gNTtcblxuICAgIGlzQWxpdmUgPSB0cnVlO1xuICAgIHJlc3BvbnNlRmFjZXRRdWVyaWVzOiBSZXNwb25zZUZhY2V0UXVlcnlMaXN0ID0gbnVsbDtcbiAgICByZXNwb25zZUZhY2V0RmllbGRzOiBGYWNldEZpZWxkW10gPSBudWxsO1xuXG4gICAgcHJpdmF0ZSBmYWNldFF1ZXJpZXNQYWdlU2l6ZSA9IHRoaXMuREVGQVVMVF9QQUdFX1NJWkU7XG4gICAgZmFjZXRRdWVyaWVzTGFiZWw6IHN0cmluZyA9ICdGYWNldCBRdWVyaWVzJztcbiAgICBmYWNldFF1ZXJpZXNFeHBhbmRlZCA9IGZhbHNlO1xuICAgIGZhY2V0RmllbGRzRXhwYW5kZWQgPSBmYWxzZTtcbiAgICBjYW5SZXNldFNlbGVjdGVkUXVlcmllcyA9IGZhbHNlO1xuXG4gICAgc2VsZWN0ZWRGYWNldFF1ZXJpZXM6IEFycmF5PEZhY2V0UXVlcnk+ID0gW107XG4gICAgc2VsZWN0ZWRCdWNrZXRzOiBBcnJheTx7IGZpZWxkOiBGYWNldEZpZWxkLCBidWNrZXQ6IEZhY2V0RmllbGRCdWNrZXQgfT4gPSBbXTtcblxuICAgIGNvbnN0cnVjdG9yKHB1YmxpYyBxdWVyeUJ1aWxkZXI6IFNlYXJjaFF1ZXJ5QnVpbGRlclNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBzZWFyY2hTZXJ2aWNlOiBTZWFyY2hTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgdHJhbnNsYXRpb25TZXJ2aWNlOiBUcmFuc2xhdGlvblNlcnZpY2UpIHtcbiAgICAgICAgaWYgKHF1ZXJ5QnVpbGRlci5jb25maWcgJiYgcXVlcnlCdWlsZGVyLmNvbmZpZy5mYWNldFF1ZXJpZXMpIHtcbiAgICAgICAgICAgIHRoaXMuZmFjZXRRdWVyaWVzTGFiZWwgPSBxdWVyeUJ1aWxkZXIuY29uZmlnLmZhY2V0UXVlcmllcy5sYWJlbCB8fCAnRmFjZXQgUXVlcmllcyc7XG4gICAgICAgICAgICB0aGlzLmZhY2V0UXVlcmllc1BhZ2VTaXplID0gcXVlcnlCdWlsZGVyLmNvbmZpZy5mYWNldFF1ZXJpZXMucGFnZVNpemUgfHwgdGhpcy5ERUZBVUxUX1BBR0VfU0laRTtcbiAgICAgICAgICAgIHRoaXMuZmFjZXRRdWVyaWVzRXhwYW5kZWQgPSBxdWVyeUJ1aWxkZXIuY29uZmlnLmZhY2V0UXVlcmllcy5leHBhbmRlZDtcbiAgICAgICAgfVxuICAgICAgICBpZiAocXVlcnlCdWlsZGVyLmNvbmZpZyAmJiBxdWVyeUJ1aWxkZXIuY29uZmlnLmZhY2V0RmllbGRzKSB7XG4gICAgICAgICAgICB0aGlzLmZhY2V0RmllbGRzRXhwYW5kZWQgPSBxdWVyeUJ1aWxkZXIuY29uZmlnLmZhY2V0RmllbGRzLmV4cGFuZGVkO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5xdWVyeUJ1aWxkZXIudXBkYXRlZC5waXBlKFxuICAgICAgICAgICAgdGFrZVdoaWxlKCgpID0+IHRoaXMuaXNBbGl2ZSlcbiAgICAgICAgKS5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5xdWVyeUJ1aWxkZXIuZXhlY3V0ZSgpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBuZ09uSW5pdCgpIHtcbiAgICAgICAgaWYgKHRoaXMucXVlcnlCdWlsZGVyKSB7XG4gICAgICAgICAgICB0aGlzLnF1ZXJ5QnVpbGRlci5leGVjdXRlZC5waXBlKFxuICAgICAgICAgICAgICAgIHRha2VXaGlsZSgoKSA9PiB0aGlzLmlzQWxpdmUpXG4gICAgICAgICAgICApLnN1YnNjcmliZSgoZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMub25EYXRhTG9hZGVkKGRhdGEpO1xuICAgICAgICAgICAgICAgIHRoaXMuc2VhcmNoU2VydmljZS5kYXRhTG9hZGVkLm5leHQoZGF0YSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG5nT25EZXN0cm95KCkge1xuICAgICAgICB0aGlzLmlzQWxpdmUgPSBmYWxzZTtcbiAgICB9XG5cbiAgICBvblRvZ2dsZUZhY2V0UXVlcnkoZXZlbnQ6IE1hdENoZWNrYm94Q2hhbmdlLCBmYWNldFF1ZXJ5OiBGYWNldFF1ZXJ5KSB7XG4gICAgICAgIGlmIChldmVudCAmJiBmYWNldFF1ZXJ5KSB7XG4gICAgICAgICAgICBpZiAoZXZlbnQuY2hlY2tlZCkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0RmFjZXRRdWVyeShmYWNldFF1ZXJ5KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy51bnNlbGVjdEZhY2V0UXVlcnkoZmFjZXRRdWVyeSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzZWxlY3RGYWNldFF1ZXJ5KHF1ZXJ5OiBGYWNldFF1ZXJ5KSB7XG4gICAgICAgIGlmIChxdWVyeSkge1xuICAgICAgICAgICAgcXVlcnkuY2hlY2tlZCA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLnF1ZXJ5QnVpbGRlci5hZGRVc2VyRmFjZXRRdWVyeShxdWVyeSk7XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZVNlbGVjdGVkRmllbGRzKCk7XG4gICAgICAgICAgICB0aGlzLnF1ZXJ5QnVpbGRlci51cGRhdGUoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHVuc2VsZWN0RmFjZXRRdWVyeShxdWVyeTogRmFjZXRRdWVyeSkge1xuICAgICAgICBpZiAocXVlcnkpIHtcbiAgICAgICAgICAgIHF1ZXJ5LmNoZWNrZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIHRoaXMucXVlcnlCdWlsZGVyLnJlbW92ZVVzZXJGYWNldFF1ZXJ5KHF1ZXJ5KTtcbiAgICAgICAgICAgIHRoaXMudXBkYXRlU2VsZWN0ZWRGaWVsZHMoKTtcbiAgICAgICAgICAgIHRoaXMucXVlcnlCdWlsZGVyLnVwZGF0ZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB1cGRhdGVTZWxlY3RlZEJ1Y2tldHMoKSB7XG4gICAgICAgIGlmICh0aGlzLnJlc3BvbnNlRmFjZXRGaWVsZHMpIHtcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRCdWNrZXRzID0gW107XG4gICAgICAgICAgICBmb3IgKGxldCBmaWVsZCBvZiB0aGlzLnJlc3BvbnNlRmFjZXRGaWVsZHMpIHtcbiAgICAgICAgICAgICAgICBpZiAoZmllbGQuYnVja2V0cykge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkQnVja2V0cy5wdXNoKFxuICAgICAgICAgICAgICAgICAgICAgICAgLi4udGhpcy5xdWVyeUJ1aWxkZXIuZ2V0VXNlckZhY2V0QnVja2V0cyhmaWVsZC5maWVsZClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZmlsdGVyKGJ1Y2tldCA9PiBidWNrZXQuY2hlY2tlZClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAubWFwKGJ1Y2tldCA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7IGZpZWxkLCBidWNrZXQgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRCdWNrZXRzID0gW107XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHVwZGF0ZVNlbGVjdGVkRmllbGRzKCkge1xuICAgICAgICBpZiAodGhpcy5yZXNwb25zZUZhY2V0UXVlcmllcykge1xuICAgICAgICAgICAgdGhpcy5zZWxlY3RlZEZhY2V0UXVlcmllcyA9IHRoaXMucmVzcG9uc2VGYWNldFF1ZXJpZXMuaXRlbXMuZmlsdGVyKGl0ZW0gPT4gaXRlbS5jaGVja2VkKTtcbiAgICAgICAgICAgIHRoaXMuY2FuUmVzZXRTZWxlY3RlZFF1ZXJpZXMgPSB0aGlzLnNlbGVjdGVkRmFjZXRRdWVyaWVzLmxlbmd0aCA+IDA7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnNlbGVjdGVkRmFjZXRRdWVyaWVzID0gW107XG4gICAgICAgICAgICB0aGlzLmNhblJlc2V0U2VsZWN0ZWRRdWVyaWVzID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBvblRvZ2dsZUJ1Y2tldChldmVudDogTWF0Q2hlY2tib3hDaGFuZ2UsIGZpZWxkOiBGYWNldEZpZWxkLCBidWNrZXQ6IEZhY2V0RmllbGRCdWNrZXQpIHtcbiAgICAgICAgaWYgKGV2ZW50ICYmIGJ1Y2tldCkge1xuICAgICAgICAgICAgaWYgKGV2ZW50LmNoZWNrZWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdEZhY2V0QnVja2V0KGZpZWxkLCBidWNrZXQpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnVuc2VsZWN0RmFjZXRCdWNrZXQoZmllbGQsIGJ1Y2tldCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzZWxlY3RGYWNldEJ1Y2tldChmaWVsZDogRmFjZXRGaWVsZCwgYnVja2V0OiBGYWNldEZpZWxkQnVja2V0KSB7XG4gICAgICAgIGlmIChidWNrZXQpIHtcbiAgICAgICAgICAgIGJ1Y2tldC5jaGVja2VkID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMucXVlcnlCdWlsZGVyLmFkZFVzZXJGYWNldEJ1Y2tldChmaWVsZCwgYnVja2V0KTtcbiAgICAgICAgICAgIHRoaXMudXBkYXRlU2VsZWN0ZWRCdWNrZXRzKCk7XG4gICAgICAgICAgICB0aGlzLnF1ZXJ5QnVpbGRlci51cGRhdGUoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHVuc2VsZWN0RmFjZXRCdWNrZXQoZmllbGQ6IEZhY2V0RmllbGQsIGJ1Y2tldDogRmFjZXRGaWVsZEJ1Y2tldCkge1xuICAgICAgICBpZiAoYnVja2V0KSB7XG4gICAgICAgICAgICBidWNrZXQuY2hlY2tlZCA9IGZhbHNlO1xuICAgICAgICAgICAgdGhpcy5xdWVyeUJ1aWxkZXIucmVtb3ZlVXNlckZhY2V0QnVja2V0KGZpZWxkLCBidWNrZXQpO1xuICAgICAgICAgICAgdGhpcy51cGRhdGVTZWxlY3RlZEJ1Y2tldHMoKTtcbiAgICAgICAgICAgIHRoaXMucXVlcnlCdWlsZGVyLnVwZGF0ZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmVzZXRTZWxlY3RlZFF1ZXJpZXMoKSB7XG4gICAgICAgIGlmICh0aGlzLmNhblJlc2V0U2VsZWN0ZWRRdWVyaWVzKSB7XG4gICAgICAgICAgICBmb3IgKGxldCBxdWVyeSBvZiB0aGlzLnJlc3BvbnNlRmFjZXRRdWVyaWVzLml0ZW1zKSB7XG4gICAgICAgICAgICAgICAgcXVlcnkuY2hlY2tlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHRoaXMucXVlcnlCdWlsZGVyLnJlbW92ZVVzZXJGYWNldFF1ZXJ5KHF1ZXJ5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRGYWNldFF1ZXJpZXMgPSBbXTtcbiAgICAgICAgICAgIHRoaXMuY2FuUmVzZXRTZWxlY3RlZFF1ZXJpZXMgPSBmYWxzZTtcbiAgICAgICAgICAgIHRoaXMucXVlcnlCdWlsZGVyLnVwZGF0ZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgY2FuUmVzZXRTZWxlY3RlZEJ1Y2tldHMoZmllbGQ6IEZhY2V0RmllbGQpOiBib29sZWFuIHtcbiAgICAgICAgaWYgKGZpZWxkICYmIGZpZWxkLmJ1Y2tldHMpIHtcbiAgICAgICAgICAgIHJldHVybiBmaWVsZC5idWNrZXRzLml0ZW1zLnNvbWUoYnVja2V0ID0+IGJ1Y2tldC5jaGVja2VkKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgcmVzZXRTZWxlY3RlZEJ1Y2tldHMoZmllbGQ6IEZhY2V0RmllbGQpIHtcbiAgICAgICAgaWYgKGZpZWxkICYmIGZpZWxkLmJ1Y2tldHMpIHtcbiAgICAgICAgICAgIGZvciAobGV0IGJ1Y2tldCBvZiBmaWVsZC5idWNrZXRzLml0ZW1zKSB7XG4gICAgICAgICAgICAgICAgYnVja2V0LmNoZWNrZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB0aGlzLnF1ZXJ5QnVpbGRlci5yZW1vdmVVc2VyRmFjZXRCdWNrZXQoZmllbGQsIGJ1Y2tldCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZVNlbGVjdGVkQnVja2V0cygpO1xuICAgICAgICAgICAgdGhpcy5xdWVyeUJ1aWxkZXIudXBkYXRlKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBvbkRhdGFMb2FkZWQoZGF0YTogYW55KSB7XG4gICAgICAgIGNvbnN0IGNvbnRleHQgPSBkYXRhLmxpc3QuY29udGV4dDtcblxuICAgICAgICBpZiAoY29udGV4dCkge1xuICAgICAgICAgICAgdGhpcy5wYXJzZUZhY2V0RmllbGRzKGNvbnRleHQpO1xuICAgICAgICAgICAgdGhpcy5wYXJzZUZhY2V0UXVlcmllcyhjb250ZXh0KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMucmVzcG9uc2VGYWNldFF1ZXJpZXMgPSBudWxsO1xuICAgICAgICAgICAgdGhpcy5yZXNwb25zZUZhY2V0RmllbGRzID0gbnVsbDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgcGFyc2VGYWNldEZpZWxkcyhjb250ZXh0OiBhbnkpIHtcbiAgICAgICAgaWYgKCF0aGlzLnJlc3BvbnNlRmFjZXRGaWVsZHMpIHtcbiAgICAgICAgICAgIGNvbnN0IGNvbmZpZ0ZhY2V0RmllbGRzID0gdGhpcy5xdWVyeUJ1aWxkZXIuY29uZmlnLmZhY2V0RmllbGRzICYmIHRoaXMucXVlcnlCdWlsZGVyLmNvbmZpZy5mYWNldEZpZWxkcy5maWVsZHMgfHwgW107XG5cbiAgICAgICAgICAgIHRoaXMucmVzcG9uc2VGYWNldEZpZWxkcyA9IGNvbmZpZ0ZhY2V0RmllbGRzLm1hcChmaWVsZCA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVzcG9uc2VGaWVsZCA9IChjb250ZXh0LmZhY2V0c0ZpZWxkcyB8fCBbXSkuZmluZChyZXNwb25zZSA9PiByZXNwb25zZS5sYWJlbCA9PT0gZmllbGQubGFiZWwpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGJ1Y2tldHM6IEZhY2V0RmllbGRCdWNrZXRbXSA9ICgocmVzcG9uc2VGaWVsZCAmJiByZXNwb25zZUZpZWxkLmJ1Y2tldHMpIHx8IFtdKS5tYXAoYnVja2V0ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWRCdWNrZXQgPSB0aGlzLnNlbGVjdGVkQnVja2V0cy5maW5kKGZhY2V0QnVja2V0ID0+XG4gICAgICAgICAgICAgICAgICAgICAgICBmYWNldEJ1Y2tldC5idWNrZXQubGFiZWwgPT09IGJ1Y2tldC5sYWJlbCAmJiBmYWNldEJ1Y2tldC5maWVsZC5maWVsZCA9PT0gZmllbGQuZmllbGQpO1xuXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiA8RmFjZXRGaWVsZEJ1Y2tldD4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgLi4uYnVja2V0LFxuICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tlZDogISFzZWxlY3RlZEJ1Y2tldCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGRpc3BsYXk6IHRoaXMudHJhbnNsYXRpb25TZXJ2aWNlLmluc3RhbnQoYnVja2V0LmRpc3BsYXkpLFxuICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6IHRoaXMudHJhbnNsYXRpb25TZXJ2aWNlLmluc3RhbnQoYnVja2V0LmxhYmVsKVxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGNvbnN0IGJ1Y2tldExpc3QgPSBuZXcgU2VhcmNoRmlsdGVyTGlzdDxGYWNldEZpZWxkQnVja2V0PihidWNrZXRzLCBmaWVsZC5wYWdlU2l6ZSk7XG4gICAgICAgICAgICAgICAgYnVja2V0TGlzdC5maWx0ZXIgPSAoYnVja2V0OiBGYWNldEZpZWxkQnVja2V0KTogYm9vbGVhbiA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChidWNrZXQgJiYgYnVja2V0TGlzdC5maWx0ZXJUZXh0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwYXR0ZXJuID0gKGJ1Y2tldExpc3QuZmlsdGVyVGV4dCB8fCAnJykudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxhYmVsID0gKGJ1Y2tldC5kaXNwbGF5IHx8IGJ1Y2tldC5sYWJlbCB8fCAnJykudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBsYWJlbC5zdGFydHNXaXRoKHBhdHRlcm4pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgLi4uZmllbGQsXG4gICAgICAgICAgICAgICAgICAgIGxhYmVsOiB0aGlzLnRyYW5zbGF0aW9uU2VydmljZS5pbnN0YW50KGZpZWxkLmxhYmVsKSxcbiAgICAgICAgICAgICAgICAgICAgcGFnZVNpemU6IGZpZWxkLnBhZ2VTaXplIHwgdGhpcy5ERUZBVUxUX1BBR0VfU0laRSxcbiAgICAgICAgICAgICAgICAgICAgY3VycmVudFBhZ2VTaXplOiBmaWVsZC5wYWdlU2l6ZSB8IHRoaXMuREVGQVVMVF9QQUdFX1NJWkUsXG4gICAgICAgICAgICAgICAgICAgIGJ1Y2tldHM6IGJ1Y2tldExpc3RcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgdGhpcy5yZXNwb25zZUZhY2V0RmllbGRzID0gdGhpcy5yZXNwb25zZUZhY2V0RmllbGRzXG4gICAgICAgICAgICAgICAgLm1hcChmaWVsZCA9PiB7XG5cbiAgICAgICAgICAgICAgICAgICAgbGV0IHJlc3BvbnNlRmllbGQgPSAoY29udGV4dC5mYWNldHNGaWVsZHMgfHwgW10pLmZpbmQocmVzcG9uc2UgPT4gcmVzcG9uc2UubGFiZWwgPT09IGZpZWxkLmxhYmVsKTtcblxuICAgICAgICAgICAgICAgICAgICAoZmllbGQgJiYgZmllbGQuYnVja2V0cyAmJiBmaWVsZC5idWNrZXRzLml0ZW1zIHx8IFtdKVxuICAgICAgICAgICAgICAgICAgICAgICAgLm1hcChidWNrZXQgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlQnVja2V0ID0gKChyZXNwb25zZUZpZWxkICYmIHJlc3BvbnNlRmllbGQuYnVja2V0cykgfHwgW10pLmZpbmQocmVzcEJ1Y2tldCA9PiByZXNwQnVja2V0LmxhYmVsID09PSBidWNrZXQubGFiZWwpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnVja2V0LmNvdW50ID0gcmVzcG9uc2VCdWNrZXQgPyByZXNwb25zZUJ1Y2tldC5jb3VudCA6IDA7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGJ1Y2tldDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmaWVsZDtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgcGFyc2VGYWNldFF1ZXJpZXMoY29udGV4dDogYW55KSB7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlUXVlcmllcyA9IHRoaXMuZ2V0RmFjZXRRdWVyeU1hcChjb250ZXh0KTtcbiAgICAgICAgaWYgKHRoaXMucXVlcnlCdWlsZGVyLmNvbmZpZy5mYWNldFF1ZXJpZXMpIHtcbiAgICAgICAgICAgIGNvbnN0IGJrcFJlc3BvbnNlRmFjZXRRdWVyaWVzID0gIE9iamVjdC5hc3NpZ24oe30sIHRoaXMucmVzcG9uc2VGYWNldFF1ZXJpZXMpO1xuICAgICAgICAgICAgY29uc3QgZmFjZXRRdWVyaWVzID0gKHRoaXMucXVlcnlCdWlsZGVyLmNvbmZpZy5mYWNldFF1ZXJpZXMucXVlcmllcyB8fCBbXSlcbiAgICAgICAgICAgICAgICAubWFwKHF1ZXJ5ID0+IHtcblxuICAgICAgICAgICAgICAgICAgICBjb25zdCBxdWVyeVJlc3VsdCA9IHJlc3BvbnNlUXVlcmllc1txdWVyeS5sYWJlbF07XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGJrcFF1ZXJ5ID0gKGJrcFJlc3BvbnNlRmFjZXRRdWVyaWVzLml0ZW1zIHx8IFtdKS5maW5kKGl0ZW0gPT4gaXRlbS5sYWJlbCA9PT0gcXVlcnkubGFiZWwpO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChia3BRdWVyeSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYmtwUXVlcnkuY291bnQgPSBxdWVyeVJlc3VsdC5jb3VudDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBia3BRdWVyeTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gPEZhY2V0UXVlcnk+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC4uLnF1ZXJ5LFxuICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6IHRoaXMudHJhbnNsYXRpb25TZXJ2aWNlLmluc3RhbnQocXVlcnkubGFiZWwpLFxuICAgICAgICAgICAgICAgICAgICAgICAgY291bnQ6IHF1ZXJ5UmVzdWx0LmNvdW50XG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGlmIChmYWNldFF1ZXJpZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLnJlc3BvbnNlRmFjZXRRdWVyaWVzKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVzcG9uc2VGYWNldFF1ZXJpZXMuaXRlbXMgPSBmYWNldFF1ZXJpZXM7XG5cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlc3BvbnNlRmFjZXRRdWVyaWVzID0gbmV3IFJlc3BvbnNlRmFjZXRRdWVyeUxpc3QoZmFjZXRRdWVyaWVzLCB0aGlzLmZhY2V0UXVlcmllc1BhZ2VTaXplKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5yZXNwb25zZUZhY2V0UXVlcmllcyA9IG51bGw7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGdldEZhY2V0UXVlcnlNYXAoY29udGV4dDogYW55KTogeyBba2V5OiBzdHJpbmddOiBhbnkgfSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IHt9O1xuXG4gICAgICAgIChjb250ZXh0LmZhY2V0UXVlcmllcyB8fCBbXSkuZm9yRWFjaChxdWVyeSA9PiB7XG4gICAgICAgICAgICByZXN1bHRbcXVlcnkubGFiZWxdID0gcXVlcnk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxufVxuIl19