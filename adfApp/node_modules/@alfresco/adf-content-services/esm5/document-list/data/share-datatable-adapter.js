/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
/*!
 * @license
 * Copyright 2016 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { DataSorting } from '@alfresco/adf-core';
import { ShareDataRow } from './share-data-row.model';
var ShareDataTableAdapter = /** @class */ (function () {
    function ShareDataTableAdapter(documentListService, thumbnailService, schema, sorting, sortingMode) {
        if (schema === void 0) { schema = []; }
        if (sortingMode === void 0) { sortingMode = 'client'; }
        this.documentListService = documentListService;
        this.thumbnailService = thumbnailService;
        this.ERR_ROW_NOT_FOUND = 'Row not found';
        this.ERR_COL_NOT_FOUND = 'Column not found';
        this.thumbnails = false;
        this.rows = [];
        this.columns = schema || [];
        this.sorting = sorting;
        this.sortingMode = sortingMode;
    }
    Object.defineProperty(ShareDataTableAdapter.prototype, "sortingMode", {
        get: /**
         * @return {?}
         */
        function () {
            return this._sortingMode;
        },
        set: /**
         * @param {?} value
         * @return {?}
         */
        function (value) {
            /** @type {?} */
            var newValue = (value || 'client').toLowerCase();
            if (newValue !== 'client' && newValue !== 'server') {
                newValue = 'client';
            }
            this._sortingMode = newValue;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @return {?}
     */
    ShareDataTableAdapter.prototype.getRows = /**
     * @return {?}
     */
    function () {
        return this.rows;
    };
    // TODO: disable this api
    /**
     * @param {?} rows
     * @return {?}
     */
    ShareDataTableAdapter.prototype.setRows = /**
     * @param {?} rows
     * @return {?}
     */
    function (rows) {
        this.rows = rows || [];
        this.sort();
    };
    /**
     * @return {?}
     */
    ShareDataTableAdapter.prototype.getColumns = /**
     * @return {?}
     */
    function () {
        return this.columns;
    };
    /**
     * @param {?} columns
     * @return {?}
     */
    ShareDataTableAdapter.prototype.setColumns = /**
     * @param {?} columns
     * @return {?}
     */
    function (columns) {
        this.columns = columns || [];
    };
    /**
     * @param {?} row
     * @param {?} col
     * @return {?}
     */
    ShareDataTableAdapter.prototype.getValue = /**
     * @param {?} row
     * @param {?} col
     * @return {?}
     */
    function (row, col) {
        if (!row) {
            throw new Error(this.ERR_ROW_NOT_FOUND);
        }
        if (!col) {
            throw new Error(this.ERR_COL_NOT_FOUND);
        }
        /** @type {?} */
        var dataRow = /** @type {?} */ (row);
        /** @type {?} */
        var value = row.getValue(col.key);
        if (dataRow.cache[col.key] !== undefined) {
            return dataRow.cache[col.key];
        }
        if (col.key === '$thumbnail') {
            if (this.imageResolver) {
                /** @type {?} */
                var resolved = this.imageResolver(row, col);
                if (resolved) {
                    return resolved;
                }
            }
            /** @type {?} */
            var node = (/** @type {?} */ (row)).node;
            if (node.entry.isFolder) {
                if (this.isSmartFolder(node)) {
                    return this.documentListService.getMimeTypeIcon('smartFolder');
                }
                else {
                    return this.documentListService.getMimeTypeIcon('folder');
                }
            }
            if (node.entry.isFile) {
                if (this.thumbnails) {
                    return this.documentListService.getDocumentThumbnailUrl(node);
                }
            }
            if (node.entry.content) {
                /** @type {?} */
                var mimeType = node.entry.content.mimeType;
                if (mimeType) {
                    return this.documentListService.getMimeTypeIcon(mimeType);
                }
            }
            return this.documentListService.getDefaultMimeTypeIcon();
        }
        if (col.type === 'image') {
            if (this.imageResolver) {
                /** @type {?} */
                var resolved = this.imageResolver(row, col);
                if (resolved) {
                    return resolved;
                }
            }
        }
        return dataRow.cacheValue(col.key, value);
    };
    /**
     * @return {?}
     */
    ShareDataTableAdapter.prototype.getSorting = /**
     * @return {?}
     */
    function () {
        return this.sorting;
    };
    /**
     * @param {?} sorting
     * @return {?}
     */
    ShareDataTableAdapter.prototype.setSorting = /**
     * @param {?} sorting
     * @return {?}
     */
    function (sorting) {
        this.sorting = sorting;
        this.sortRows(this.rows, this.sorting);
    };
    /**
     * @param {?=} key
     * @param {?=} direction
     * @return {?}
     */
    ShareDataTableAdapter.prototype.sort = /**
     * @param {?=} key
     * @param {?=} direction
     * @return {?}
     */
    function (key, direction) {
        /** @type {?} */
        var sorting = this.sorting || new DataSorting();
        if (key) {
            sorting.key = key;
            sorting.direction = direction || 'asc';
        }
        this.setSorting(sorting);
    };
    /**
     * @param {?} filter
     * @return {?}
     */
    ShareDataTableAdapter.prototype.setFilter = /**
     * @param {?} filter
     * @return {?}
     */
    function (filter) {
        this.filter = filter;
    };
    /**
     * @param {?} resolver
     * @return {?}
     */
    ShareDataTableAdapter.prototype.setImageResolver = /**
     * @param {?} resolver
     * @return {?}
     */
    function (resolver) {
        this.imageResolver = resolver;
    };
    /**
     * @param {?} node
     * @return {?}
     */
    ShareDataTableAdapter.prototype.isSmartFolder = /**
     * @param {?} node
     * @return {?}
     */
    function (node) {
        /** @type {?} */
        var nodeAspects = this.getNodeAspectNames(node);
        return nodeAspects.indexOf('smf:customConfigSmartFolder') > -1 ||
            (nodeAspects.indexOf('smf:systemConfigSmartFolder') > -1);
    };
    /**
     * @param {?} node
     * @return {?}
     */
    ShareDataTableAdapter.prototype.getNodeAspectNames = /**
     * @param {?} node
     * @return {?}
     */
    function (node) {
        return node.entry && node.entry.aspectNames ? node.entry.aspectNames : node.aspectNames ? node.aspectNames : [];
    };
    /**
     * @param {?} rows
     * @param {?} sorting
     * @return {?}
     */
    ShareDataTableAdapter.prototype.sortRows = /**
     * @param {?} rows
     * @param {?} sorting
     * @return {?}
     */
    function (rows, sorting) {
        if (this.sortingMode === 'server') {
            return;
        }
        /** @type {?} */
        var options = {};
        if (sorting && sorting.key && rows && rows.length > 0) {
            if (sorting.key.includes('sizeInBytes') || sorting.key === 'name') {
                options.numeric = true;
            }
            rows.sort(function (a, b) {
                if (a.node.entry.isFolder !== b.node.entry.isFolder) {
                    return a.node.entry.isFolder ? -1 : 1;
                }
                /** @type {?} */
                var left = a.getValue(sorting.key);
                if (left) {
                    left = (left instanceof Date) ? left.valueOf().toString() : left.toString();
                }
                else {
                    left = '';
                }
                /** @type {?} */
                var right = b.getValue(sorting.key);
                if (right) {
                    right = (right instanceof Date) ? right.valueOf().toString() : right.toString();
                }
                else {
                    right = '';
                }
                return sorting.direction === 'asc'
                    ? left.localeCompare(right, undefined, options)
                    : right.localeCompare(left, undefined, options);
            });
        }
    };
    /**
     * @param {?} page
     * @param {?=} merge
     * @return {?}
     */
    ShareDataTableAdapter.prototype.loadPage = /**
     * @param {?} page
     * @param {?=} merge
     * @return {?}
     */
    function (page, merge) {
        var _this = this;
        if (merge === void 0) { merge = false; }
        /** @type {?} */
        var rows = [];
        if (page && page.list) {
            /** @type {?} */
            var data = page.list.entries;
            if (data && data.length > 0) {
                rows = data.map(function (item) { return new ShareDataRow(item, _this.documentListService, _this.permissionsStyle, _this.thumbnailService); });
                if (this.filter) {
                    rows = rows.filter(this.filter);
                }
                if (this.sortingMode !== 'server') {
                    // Sort by first sortable or just first column
                    if (this.columns && this.columns.length > 0) {
                        /** @type {?} */
                        var sorting = this.getSorting();
                        if (sorting) {
                            this.sortRows(rows, sorting);
                        }
                        else {
                            /** @type {?} */
                            var sortable = this.columns.filter(function (c) { return c.sortable; });
                            if (sortable.length > 0) {
                                this.sort(sortable[0].key, 'asc');
                            }
                            else {
                                this.sort(this.columns[0].key, 'asc');
                            }
                        }
                    }
                }
            }
        }
        if (merge) {
            /** @type {?} */
            var listPrunedDuplicate = rows.filter(function (elemntToFilter) {
                /** @type {?} */
                var isPresent = _this.rows.find(function (currenRow) {
                    return currenRow.obj.entry.id === elemntToFilter.obj.entry.id;
                });
                return !isPresent;
            });
            this.rows = this.rows.concat(listPrunedDuplicate);
        }
        else {
            this.rows = rows;
        }
    };
    return ShareDataTableAdapter;
}());
export { ShareDataTableAdapter };
if (false) {
    /** @type {?} */
    ShareDataTableAdapter.prototype.ERR_ROW_NOT_FOUND;
    /** @type {?} */
    ShareDataTableAdapter.prototype.ERR_COL_NOT_FOUND;
    /** @type {?} */
    ShareDataTableAdapter.prototype._sortingMode;
    /** @type {?} */
    ShareDataTableAdapter.prototype.sorting;
    /** @type {?} */
    ShareDataTableAdapter.prototype.rows;
    /** @type {?} */
    ShareDataTableAdapter.prototype.columns;
    /** @type {?} */
    ShareDataTableAdapter.prototype.filter;
    /** @type {?} */
    ShareDataTableAdapter.prototype.imageResolver;
    /** @type {?} */
    ShareDataTableAdapter.prototype.thumbnails;
    /** @type {?} */
    ShareDataTableAdapter.prototype.permissionsStyle;
    /** @type {?} */
    ShareDataTableAdapter.prototype.selectedRow;
    /** @type {?} */
    ShareDataTableAdapter.prototype.documentListService;
    /** @type {?} */
    ShareDataTableAdapter.prototype.thumbnailService;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hhcmUtZGF0YXRhYmxlLWFkYXB0ZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYWxmcmVzY28vYWRmLWNvbnRlbnQtc2VydmljZXMvIiwic291cmNlcyI6WyJkb2N1bWVudC1saXN0L2RhdGEvc2hhcmUtZGF0YXRhYmxlLWFkYXB0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFpQkEsT0FBTyxFQUF1QixXQUFXLEVBQXNDLE1BQU0sb0JBQW9CLENBQUM7QUFJMUcsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBRXRELElBQUE7SUE2QkksK0JBQW9CLG1CQUF3QyxFQUN4QyxrQkFDUixNQUF5QixFQUN6QixPQUFxQixFQUNyQixXQUE4QjtRQUY5Qix1QkFBQSxFQUFBLFdBQXlCO1FBRXpCLDRCQUFBLEVBQUEsc0JBQThCO1FBSnRCLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBcUI7UUFDeEMscUJBQWdCLEdBQWhCLGdCQUFnQjtpQ0E1QlIsZUFBZTtpQ0FDZixrQkFBa0I7MEJBVXhCLEtBQUs7UUFxQnZCLElBQUksQ0FBQyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ2YsSUFBSSxDQUFDLE9BQU8sR0FBRyxNQUFNLElBQUksRUFBRSxDQUFDO1FBQzVCLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDO0tBQ2xDO0lBckJELHNCQUFJLDhDQUFXOzs7O1FBUWY7WUFDSSxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUM7U0FDNUI7Ozs7O1FBVkQsVUFBZ0IsS0FBYTs7WUFDekIsSUFBSSxRQUFRLEdBQUcsQ0FBQyxLQUFLLElBQUksUUFBUSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDakQsSUFBSSxRQUFRLEtBQUssUUFBUSxJQUFJLFFBQVEsS0FBSyxRQUFRLEVBQUU7Z0JBQ2hELFFBQVEsR0FBRyxRQUFRLENBQUM7YUFDdkI7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QyxDQUFDOzZCQUN6Qzt5QkFDSjtxQkFDSjtpQkFDSjthQUNKO1NBQ0o7UUFFRCxJQUFJLEtBQUssRUFBRTs7WUFDUCxJQUFJLG1CQUFtQixHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBQyxjQUFjOztnQkFDakQsSUFBSSxTQUFTLEdBQUcsS0FBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBQyxTQUFjO29CQUMxQyxPQUFPLFNBQVMsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUUsS0FBSyxjQUFjLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUM7aUJBQ2pFLENBQUMsQ0FBQztnQkFFSCxPQUFPLENBQUMsU0FBUyxDQUFDO2FBQ3JCLENBQUMsQ0FBQztZQUVILElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsbUJBQW1CLENBQUMsQ0FBQztTQUNyRDthQUFNO1lBQ0gsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7U0FDcEI7O2dDQXJRVDtJQXVRQyxDQUFBO0FBaFBELGlDQWdQQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE2IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IERhdGFDb2x1bW4sIERhdGFSb3csIERhdGFTb3J0aW5nLCBEYXRhVGFibGVBZGFwdGVyLCBUaHVtYm5haWxTZXJ2aWNlIH0gZnJvbSAnQGFsZnJlc2NvL2FkZi1jb3JlJztcbmltcG9ydCB7IE5vZGVQYWdpbmcgfSBmcm9tICdhbGZyZXNjby1qcy1hcGknO1xuaW1wb3J0IHsgUGVybWlzc2lvblN0eWxlTW9kZWwgfSBmcm9tICcuLy4uL21vZGVscy9wZXJtaXNzaW9ucy1zdHlsZS5tb2RlbCc7XG5pbXBvcnQgeyBEb2N1bWVudExpc3RTZXJ2aWNlIH0gZnJvbSAnLi8uLi9zZXJ2aWNlcy9kb2N1bWVudC1saXN0LnNlcnZpY2UnO1xuaW1wb3J0IHsgU2hhcmVEYXRhUm93IH0gZnJvbSAnLi9zaGFyZS1kYXRhLXJvdy5tb2RlbCc7XG5cbmV4cG9ydCBjbGFzcyBTaGFyZURhdGFUYWJsZUFkYXB0ZXIgaW1wbGVtZW50cyBEYXRhVGFibGVBZGFwdGVyIHtcblxuICAgIEVSUl9ST1dfTk9UX0ZPVU5EOiBzdHJpbmcgPSAnUm93IG5vdCBmb3VuZCc7XG4gICAgRVJSX0NPTF9OT1RfRk9VTkQ6IHN0cmluZyA9ICdDb2x1bW4gbm90IGZvdW5kJztcblxuICAgIHByaXZhdGUgX3NvcnRpbmdNb2RlOiBzdHJpbmc7XG4gICAgcHJpdmF0ZSBzb3J0aW5nOiBEYXRhU29ydGluZztcbiAgICBwcml2YXRlIHJvd3M6IERhdGFSb3dbXTtcbiAgICBwcml2YXRlIGNvbHVtbnM6IERhdGFDb2x1bW5bXTtcblxuICAgIHByaXZhdGUgZmlsdGVyOiBhbnk7XG4gICAgcHJpdmF0ZSBpbWFnZVJlc29sdmVyOiBhbnk7XG5cbiAgICB0aHVtYm5haWxzOiBib29sZWFuID0gZmFsc2U7XG4gICAgcGVybWlzc2lvbnNTdHlsZTogUGVybWlzc2lvblN0eWxlTW9kZWxbXTtcbiAgICBzZWxlY3RlZFJvdzogRGF0YVJvdztcblxuICAgIHNldCBzb3J0aW5nTW9kZSh2YWx1ZTogc3RyaW5nKSB7XG4gICAgICAgIGxldCBuZXdWYWx1ZSA9ICh2YWx1ZSB8fCAnY2xpZW50JykudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgaWYgKG5ld1ZhbHVlICE9PSAnY2xpZW50JyAmJiBuZXdWYWx1ZSAhPT0gJ3NlcnZlcicpIHtcbiAgICAgICAgICAgIG5ld1ZhbHVlID0gJ2NsaWVudCc7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fc29ydGluZ01vZGUgPSBuZXdWYWx1ZTtcbiAgICB9XG5cbiAgICBnZXQgc29ydGluZ01vZGUoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3NvcnRpbmdNb2RlO1xuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgZG9jdW1lbnRMaXN0U2VydmljZTogRG9jdW1lbnRMaXN0U2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIHRodW1ibmFpbFNlcnZpY2U6IFRodW1ibmFpbFNlcnZpY2UsXG4gICAgICAgICAgICAgICAgc2NoZW1hOiBEYXRhQ29sdW1uW10gPSBbXSxcbiAgICAgICAgICAgICAgICBzb3J0aW5nPzogRGF0YVNvcnRpbmcsXG4gICAgICAgICAgICAgICAgc29ydGluZ01vZGU6IHN0cmluZyA9ICdjbGllbnQnKSB7XG4gICAgICAgIHRoaXMucm93cyA9IFtdO1xuICAgICAgICB0aGlzLmNvbHVtbnMgPSBzY2hlbWEgfHwgW107XG4gICAgICAgIHRoaXMuc29ydGluZyA9IHNvcnRpbmc7XG4gICAgICAgIHRoaXMuc29ydGluZ01vZGUgPSBzb3J0aW5nTW9kZTtcbiAgICB9XG5cbiAgICBnZXRSb3dzKCk6IEFycmF5PERhdGFSb3c+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMucm93cztcbiAgICB9XG5cbiAgICAvLyBUT0RPOiBkaXNhYmxlIHRoaXMgYXBpXG4gICAgc2V0Um93cyhyb3dzOiBBcnJheTxEYXRhUm93Pikge1xuICAgICAgICB0aGlzLnJvd3MgPSByb3dzIHx8IFtdO1xuICAgICAgICB0aGlzLnNvcnQoKTtcbiAgICB9XG5cbiAgICBnZXRDb2x1bW5zKCk6IEFycmF5PERhdGFDb2x1bW4+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY29sdW1ucztcbiAgICB9XG5cbiAgICBzZXRDb2x1bW5zKGNvbHVtbnM6IEFycmF5PERhdGFDb2x1bW4+KSB7XG4gICAgICAgIHRoaXMuY29sdW1ucyA9IGNvbHVtbnMgfHwgW107XG4gICAgfVxuXG4gICAgZ2V0VmFsdWUocm93OiBEYXRhUm93LCBjb2w6IERhdGFDb2x1bW4pOiBhbnkge1xuICAgICAgICBpZiAoIXJvdykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKHRoaXMuRVJSX1JPV19OT1RfRk9VTkQpO1xuICAgICAgICB9XG4gICAgICAgIGlmICghY29sKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IodGhpcy5FUlJfQ09MX05PVF9GT1VORCk7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IGRhdGFSb3c6IFNoYXJlRGF0YVJvdyA9IDxTaGFyZURhdGFSb3c+IHJvdztcbiAgICAgICAgbGV0IHZhbHVlOiBhbnkgPSByb3cuZ2V0VmFsdWUoY29sLmtleSk7XG4gICAgICAgIGlmIChkYXRhUm93LmNhY2hlW2NvbC5rZXldICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHJldHVybiBkYXRhUm93LmNhY2hlW2NvbC5rZXldO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGNvbC5rZXkgPT09ICckdGh1bWJuYWlsJykge1xuXG4gICAgICAgICAgICBpZiAodGhpcy5pbWFnZVJlc29sdmVyKSB7XG4gICAgICAgICAgICAgICAgbGV0IHJlc29sdmVkID0gdGhpcy5pbWFnZVJlc29sdmVyKHJvdywgY29sKTtcbiAgICAgICAgICAgICAgICBpZiAocmVzb2x2ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmVkO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3Qgbm9kZSA9ICg8U2hhcmVEYXRhUm93PiByb3cpLm5vZGU7XG5cbiAgICAgICAgICAgIGlmIChub2RlLmVudHJ5LmlzRm9sZGVyKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNTbWFydEZvbGRlcihub2RlKSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kb2N1bWVudExpc3RTZXJ2aWNlLmdldE1pbWVUeXBlSWNvbignc21hcnRGb2xkZXInKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kb2N1bWVudExpc3RTZXJ2aWNlLmdldE1pbWVUeXBlSWNvbignZm9sZGVyJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAobm9kZS5lbnRyeS5pc0ZpbGUpIHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy50aHVtYm5haWxzKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmRvY3VtZW50TGlzdFNlcnZpY2UuZ2V0RG9jdW1lbnRUaHVtYm5haWxVcmwobm9kZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAobm9kZS5lbnRyeS5jb250ZW50KSB7XG4gICAgICAgICAgICAgICAgY29uc3QgbWltZVR5cGUgPSBub2RlLmVudHJ5LmNvbnRlbnQubWltZVR5cGU7XG4gICAgICAgICAgICAgICAgaWYgKG1pbWVUeXBlKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmRvY3VtZW50TGlzdFNlcnZpY2UuZ2V0TWltZVR5cGVJY29uKG1pbWVUeXBlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiB0aGlzLmRvY3VtZW50TGlzdFNlcnZpY2UuZ2V0RGVmYXVsdE1pbWVUeXBlSWNvbigpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGNvbC50eXBlID09PSAnaW1hZ2UnKSB7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLmltYWdlUmVzb2x2ZXIpIHtcbiAgICAgICAgICAgICAgICBsZXQgcmVzb2x2ZWQgPSB0aGlzLmltYWdlUmVzb2x2ZXIocm93LCBjb2wpO1xuICAgICAgICAgICAgICAgIGlmIChyZXNvbHZlZCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGRhdGFSb3cuY2FjaGVWYWx1ZShjb2wua2V5LCB2YWx1ZSk7XG4gICAgfVxuXG4gICAgZ2V0U29ydGluZygpOiBEYXRhU29ydGluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLnNvcnRpbmc7XG4gICAgfVxuXG4gICAgc2V0U29ydGluZyhzb3J0aW5nOiBEYXRhU29ydGluZyk6IHZvaWQge1xuICAgICAgICB0aGlzLnNvcnRpbmcgPSBzb3J0aW5nO1xuXG4gICAgICAgIHRoaXMuc29ydFJvd3ModGhpcy5yb3dzLCB0aGlzLnNvcnRpbmcpO1xuICAgIH1cblxuICAgIHNvcnQoa2V5Pzogc3RyaW5nLCBkaXJlY3Rpb24/OiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgbGV0IHNvcnRpbmcgPSB0aGlzLnNvcnRpbmcgfHwgbmV3IERhdGFTb3J0aW5nKCk7XG4gICAgICAgIGlmIChrZXkpIHtcbiAgICAgICAgICAgIHNvcnRpbmcua2V5ID0ga2V5O1xuICAgICAgICAgICAgc29ydGluZy5kaXJlY3Rpb24gPSBkaXJlY3Rpb24gfHwgJ2FzYyc7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zZXRTb3J0aW5nKHNvcnRpbmcpO1xuICAgIH1cblxuICAgIHNldEZpbHRlcihmaWx0ZXI6IGFueSkge1xuICAgICAgICB0aGlzLmZpbHRlciA9IGZpbHRlcjtcbiAgICB9XG5cbiAgICBzZXRJbWFnZVJlc29sdmVyKHJlc29sdmVyOiBhbnkpIHtcbiAgICAgICAgdGhpcy5pbWFnZVJlc29sdmVyID0gcmVzb2x2ZXI7XG4gICAgfVxuXG4gICAgaXNTbWFydEZvbGRlcihub2RlOiBhbnkpIHtcbiAgICAgICAgbGV0IG5vZGVBc3BlY3RzID0gdGhpcy5nZXROb2RlQXNwZWN0TmFtZXMobm9kZSk7XG4gICAgICAgIHJldHVybiBub2RlQXNwZWN0cy5pbmRleE9mKCdzbWY6Y3VzdG9tQ29uZmlnU21hcnRGb2xkZXInKSA+IC0xIHx8XG4gICAgICAgICAgICAobm9kZUFzcGVjdHMuaW5kZXhPZignc21mOnN5c3RlbUNvbmZpZ1NtYXJ0Rm9sZGVyJykgPiAtMSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXROb2RlQXNwZWN0TmFtZXMobm9kZTogYW55KTogYW55W10ge1xuICAgICAgICByZXR1cm4gbm9kZS5lbnRyeSAmJiBub2RlLmVudHJ5LmFzcGVjdE5hbWVzID8gbm9kZS5lbnRyeS5hc3BlY3ROYW1lcyA6IG5vZGUuYXNwZWN0TmFtZXMgPyBub2RlLmFzcGVjdE5hbWVzIDogW107XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzb3J0Um93cyhyb3dzOiBEYXRhUm93W10sIHNvcnRpbmc6IERhdGFTb3J0aW5nKSB7XG4gICAgICAgIGlmICh0aGlzLnNvcnRpbmdNb2RlID09PSAnc2VydmVyJykge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgb3B0aW9uczogSW50bC5Db2xsYXRvck9wdGlvbnMgPSB7fTtcblxuICAgICAgICBpZiAoc29ydGluZyAmJiBzb3J0aW5nLmtleSAmJiByb3dzICYmIHJvd3MubGVuZ3RoID4gMCkge1xuXG4gICAgICAgICAgICBpZiAoc29ydGluZy5rZXkuaW5jbHVkZXMoJ3NpemVJbkJ5dGVzJykgfHwgc29ydGluZy5rZXkgPT09ICduYW1lJykge1xuICAgICAgICAgICAgICAgIG9wdGlvbnMubnVtZXJpYyA9IHRydWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJvd3Muc29ydCgoYTogU2hhcmVEYXRhUm93LCBiOiBTaGFyZURhdGFSb3cpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoYS5ub2RlLmVudHJ5LmlzRm9sZGVyICE9PSBiLm5vZGUuZW50cnkuaXNGb2xkZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGEubm9kZS5lbnRyeS5pc0ZvbGRlciA/IC0xIDogMTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBsZXQgbGVmdCA9IGEuZ2V0VmFsdWUoc29ydGluZy5rZXkpO1xuICAgICAgICAgICAgICAgIGlmIChsZWZ0KSB7XG4gICAgICAgICAgICAgICAgICAgIGxlZnQgPSAobGVmdCBpbnN0YW5jZW9mIERhdGUpID8gbGVmdC52YWx1ZU9mKCkudG9TdHJpbmcoKSA6IGxlZnQudG9TdHJpbmcoKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBsZWZ0ID0gJyc7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgbGV0IHJpZ2h0ID0gYi5nZXRWYWx1ZShzb3J0aW5nLmtleSk7XG4gICAgICAgICAgICAgICAgaWYgKHJpZ2h0KSB7XG4gICAgICAgICAgICAgICAgICAgIHJpZ2h0ID0gKHJpZ2h0IGluc3RhbmNlb2YgRGF0ZSkgPyByaWdodC52YWx1ZU9mKCkudG9TdHJpbmcoKSA6IHJpZ2h0LnRvU3RyaW5nKCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmlnaHQgPSAnJztcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gc29ydGluZy5kaXJlY3Rpb24gPT09ICdhc2MnXG4gICAgICAgICAgICAgICAgICAgID8gbGVmdC5sb2NhbGVDb21wYXJlKHJpZ2h0LCB1bmRlZmluZWQsIG9wdGlvbnMpXG4gICAgICAgICAgICAgICAgICAgIDogcmlnaHQubG9jYWxlQ29tcGFyZShsZWZ0LCB1bmRlZmluZWQsIG9wdGlvbnMpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgbG9hZFBhZ2UocGFnZTogTm9kZVBhZ2luZywgbWVyZ2U6IGJvb2xlYW4gPSBmYWxzZSkge1xuICAgICAgICBsZXQgcm93cyA9IFtdO1xuXG4gICAgICAgIGlmIChwYWdlICYmIHBhZ2UubGlzdCkge1xuICAgICAgICAgICAgbGV0IGRhdGEgPSBwYWdlLmxpc3QuZW50cmllcztcbiAgICAgICAgICAgIGlmIChkYXRhICYmIGRhdGEubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIHJvd3MgPSBkYXRhLm1hcChpdGVtID0+IG5ldyBTaGFyZURhdGFSb3coaXRlbSwgdGhpcy5kb2N1bWVudExpc3RTZXJ2aWNlLCB0aGlzLnBlcm1pc3Npb25zU3R5bGUsIHRoaXMudGh1bWJuYWlsU2VydmljZSkpO1xuXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuZmlsdGVyKSB7XG4gICAgICAgICAgICAgICAgICAgIHJvd3MgPSByb3dzLmZpbHRlcih0aGlzLmZpbHRlcik7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuc29ydGluZ01vZGUgIT09ICdzZXJ2ZXInKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIFNvcnQgYnkgZmlyc3Qgc29ydGFibGUgb3IganVzdCBmaXJzdCBjb2x1bW5cbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY29sdW1ucyAmJiB0aGlzLmNvbHVtbnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHNvcnRpbmcgPSB0aGlzLmdldFNvcnRpbmcoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzb3J0aW5nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zb3J0Um93cyhyb3dzLCBzb3J0aW5nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHNvcnRhYmxlID0gdGhpcy5jb2x1bW5zLmZpbHRlcihjID0+IGMuc29ydGFibGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzb3J0YWJsZS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc29ydChzb3J0YWJsZVswXS5rZXksICdhc2MnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNvcnQodGhpcy5jb2x1bW5zWzBdLmtleSwgJ2FzYycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChtZXJnZSkge1xuICAgICAgICAgICAgbGV0IGxpc3RQcnVuZWREdXBsaWNhdGUgPSByb3dzLmZpbHRlcigoZWxlbW50VG9GaWx0ZXIpID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgaXNQcmVzZW50ID0gdGhpcy5yb3dzLmZpbmQoKGN1cnJlblJvdzogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBjdXJyZW5Sb3cub2JqLmVudHJ5LmlkID09PSBlbGVtbnRUb0ZpbHRlci5vYmouZW50cnkuaWQ7XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gIWlzUHJlc2VudDtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICB0aGlzLnJvd3MgPSB0aGlzLnJvd3MuY29uY2F0KGxpc3RQcnVuZWREdXBsaWNhdGUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5yb3dzID0gcm93cztcbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==