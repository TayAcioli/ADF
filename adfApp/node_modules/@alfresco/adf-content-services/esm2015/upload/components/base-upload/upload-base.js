/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
/*!
 * @license
 * Copyright 2016 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { FileModel } from '@alfresco/adf-core';
import { EventEmitter, Input, Output } from '@angular/core';
import { UploadFilesEvent } from '../upload-files.event';
/**
 * @abstract
 */
export class UploadBase {
    /**
     * @param {?} uploadService
     * @param {?} translationService
     * @param {?} ngZone
     */
    constructor(uploadService, translationService, ngZone) {
        this.uploadService = uploadService;
        this.translationService = translationService;
        this.ngZone = ngZone;
        /**
         * The ID of the root. Use the nodeId for
         * Content Services or the taskId/processId for Process Services.
         */
        this.rootFolderId = '-root-';
        /**
         * Toggles component disabled state (if there is no node permission checking).
         */
        this.disabled = false;
        /**
         * Filter for accepted file types.
         */
        this.acceptedFilesType = '*';
        /**
         * Toggles versioning.
         */
        this.versioning = false;
        /**
         * majorVersion boolean field to true to indicate a major version should be created.
         */
        this.majorVersion = false;
        /**
         * Custom node type for uploaded file
         */
        this.nodeType = 'cm:content';
        /**
         * Emitted when the file is uploaded successfully.
         */
        this.success = new EventEmitter();
        /**
         * Emitted when a folder is created.
         * @deprecated 2.4.0 No longer used by the framework
         */
        this.createFolder = new EventEmitter();
        /**
         * Emitted when an error occurs.
         */
        this.error = new EventEmitter();
        /**
         * Emitted when the upload begins.
         */
        this.beginUpload = new EventEmitter();
        this.subscriptions = [];
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.subscriptions.push(this.uploadService.fileUploadError.subscribe((error) => {
            this.error.emit(error);
        }));
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.subscriptions.forEach(subscription => subscription.unsubscribe());
        this.subscriptions = [];
    }
    /**
     * Upload a list of file in the specified path
     * @param {?} files
     * @return {?}
     */
    uploadFiles(files) {
        /** @type {?} */
        const filteredFiles = files
            .map((file) => {
            return this.createFileModel(file, this.rootFolderId, (file.webkitRelativePath || '').replace(/\/[^\/]*$/, ''));
        });
        this.uploadQueue(filteredFiles);
    }
    /**
     * @param {?} files
     * @return {?}
     */
    uploadFilesInfo(files) {
        /** @type {?} */
        const filteredFiles = files
            .map((fileInfo) => {
            return this.createFileModel(fileInfo.file, this.rootFolderId, fileInfo.relativeFolder);
        });
        this.uploadQueue(filteredFiles);
    }
    /**
     * @param {?} files
     * @return {?}
     */
    uploadQueue(files) {
        /** @type {?} */
        let filteredFiles = files
            .filter(this.isFileAcceptable.bind(this))
            .filter(this.isFileSizeAcceptable.bind(this));
        this.ngZone.run(() => {
            /** @type {?} */
            const event = new UploadFilesEvent([...filteredFiles], this.uploadService, this.success);
            this.beginUpload.emit(event);
            if (!event.defaultPrevented) {
                if (filteredFiles.length > 0) {
                    this.uploadService.addToQueue(...filteredFiles);
                    this.uploadService.uploadFilesInTheQueue(this.success);
                }
            }
        });
    }
    /**
     * Checks if the given file is allowed by the extension filters
     *
     * @param {?} file FileModel
     * @return {?}
     */
    isFileAcceptable(file) {
        if (this.acceptedFilesType === '*') {
            return true;
        }
        /** @type {?} */
        const allowedExtensions = this.acceptedFilesType
            .split(',')
            .map(ext => ext.replace(/^\./, ''));
        if (allowedExtensions.indexOf(file.extension) !== -1) {
            return true;
        }
        return false;
    }
    /**
     * Creates FileModel from File
     *
     * @param {?} file
     * @param {?} parentId
     * @param {?} path
     * @param {?=} id
     * @return {?}
     */
    createFileModel(file, parentId, path, id) {
        return new FileModel(file, {
            comment: this.comment,
            majorVersion: this.majorVersion,
            newVersion: this.versioning,
            parentId: parentId,
            path: path,
            nodeType: this.nodeType
        }, id);
    }
    /**
     * @param {?} file
     * @return {?}
     */
    isFileSizeAllowed(file) {
        /** @type {?} */
        let isFileSizeAllowed = true;
        if (this.isMaxFileSizeDefined()) {
            isFileSizeAllowed = this.isFileSizeCorrect(file);
        }
        return isFileSizeAllowed;
    }
    /**
     * @return {?}
     */
    isMaxFileSizeDefined() {
        return this.maxFilesSize !== undefined && this.maxFilesSize !== null;
    }
    /**
     * @param {?} file
     * @return {?}
     */
    isFileSizeCorrect(file) {
        return this.maxFilesSize >= 0 && file.size <= this.maxFilesSize;
    }
    /**
     * Checks if the given file is an acceptable size
     *
     * @param {?} file FileModel
     * @return {?}
     */
    isFileSizeAcceptable(file) {
        /** @type {?} */
        let acceptableSize = true;
        if (!this.isFileSizeAllowed(file)) {
            acceptableSize = false;
            /** @type {?} */
            const message = this.translationService.instant('FILE_UPLOAD.MESSAGES.EXCEED_MAX_FILE_SIZE', { fileName: file.name });
            this.error.emit(message);
        }
        return acceptableSize;
    }
}
UploadBase.propDecorators = {
    maxFilesSize: [{ type: Input }],
    rootFolderId: [{ type: Input }],
    disabled: [{ type: Input }],
    acceptedFilesType: [{ type: Input }],
    versioning: [{ type: Input }],
    majorVersion: [{ type: Input }],
    comment: [{ type: Input }],
    nodeType: [{ type: Input }],
    success: [{ type: Output }],
    createFolder: [{ type: Output }],
    error: [{ type: Output }],
    beginUpload: [{ type: Output }]
};
if (false) {
    /**
     * Sets a limit on the maximum size (in bytes) of a file to be uploaded.
     * Has no effect if undefined.
     * @type {?}
     */
    UploadBase.prototype.maxFilesSize;
    /**
     * The ID of the root. Use the nodeId for
     * Content Services or the taskId/processId for Process Services.
     * @type {?}
     */
    UploadBase.prototype.rootFolderId;
    /**
     * Toggles component disabled state (if there is no node permission checking).
     * @type {?}
     */
    UploadBase.prototype.disabled;
    /**
     * Filter for accepted file types.
     * @type {?}
     */
    UploadBase.prototype.acceptedFilesType;
    /**
     * Toggles versioning.
     * @type {?}
     */
    UploadBase.prototype.versioning;
    /**
     * majorVersion boolean field to true to indicate a major version should be created.
     * @type {?}
     */
    UploadBase.prototype.majorVersion;
    /**
     * When you overwrite existing content, you can use the comment field to add a version comment that appears in the version history
     * @type {?}
     */
    UploadBase.prototype.comment;
    /**
     * Custom node type for uploaded file
     * @type {?}
     */
    UploadBase.prototype.nodeType;
    /**
     * Emitted when the file is uploaded successfully.
     * @type {?}
     */
    UploadBase.prototype.success;
    /**
     * Emitted when a folder is created.
     * @deprecated 2.4.0 No longer used by the framework
     * @type {?}
     */
    UploadBase.prototype.createFolder;
    /**
     * Emitted when an error occurs.
     * @type {?}
     */
    UploadBase.prototype.error;
    /**
     * Emitted when the upload begins.
     * @type {?}
     */
    UploadBase.prototype.beginUpload;
    /** @type {?} */
    UploadBase.prototype.subscriptions;
    /** @type {?} */
    UploadBase.prototype.uploadService;
    /** @type {?} */
    UploadBase.prototype.translationService;
    /** @type {?} */
    UploadBase.prototype.ngZone;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBsb2FkLWJhc2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYWxmcmVzY28vYWRmLWNvbnRlbnQtc2VydmljZXMvIiwic291cmNlcyI6WyJ1cGxvYWQvY29tcG9uZW50cy9iYXNlLXVwbG9hZC91cGxvYWQtYmFzZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQWlCQSxPQUFPLEVBQUUsU0FBUyxFQUFZLE1BQU0sb0JBQW9CLENBQUM7QUFDekQsT0FBTyxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUE2QixNQUFNLGVBQWUsQ0FBQztBQUd2RixPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQzs7OztBQUV6RCxNQUFNOzs7Ozs7SUEyREYsWUFBc0IsYUFBNEIsRUFDNUIsa0JBQXNDLEVBQ3RDLE1BQWM7UUFGZCxrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUM1Qix1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBQ3RDLFdBQU0sR0FBTixNQUFNLENBQVE7Ozs7OzRCQWpEYixRQUFROzs7O3dCQUlYLEtBQUs7Ozs7aUNBSUcsR0FBRzs7OzswQkFJVCxLQUFLOzs7OzRCQUlILEtBQUs7Ozs7d0JBUVYsWUFBWTs7Ozt1QkFJckIsSUFBSSxZQUFZLEVBQUU7Ozs7OzRCQU9iLElBQUksWUFBWSxFQUFFOzs7O3FCQUl6QixJQUFJLFlBQVksRUFBRTs7OzsyQkFJWixJQUFJLFlBQVksRUFBb0I7NkJBRVIsRUFBRTtLQUszQzs7OztJQUVELFFBQVE7UUFDSixJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FDbkIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxlQUFlLENBQUMsU0FBUyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUU7WUFDbkQsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDMUIsQ0FBQyxDQUNMLENBQUM7S0FFTDs7OztJQUVELFdBQVc7UUFDUCxJQUFJLENB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O2dDQUlMLEtBQUs7eUJBSUwsS0FBSzsyQkFJTCxLQUFLO3NCQUlMLEtBQUs7dUJBSUwsS0FBSztzQkFJTCxNQUFNOzJCQU9OLE1BQU07b0JBSU4sTUFBTTswQkFJTixNQUFNIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTYgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgRmlsZU1vZGVsLCBGaWxlSW5mbyB9IGZyb20gJ0BhbGZyZXNjby9hZGYtY29yZSc7XG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIsIElucHV0LCBPdXRwdXQsIE9uSW5pdCwgT25EZXN0cm95LCBOZ1pvbmUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFVwbG9hZFNlcnZpY2UsIFRyYW5zbGF0aW9uU2VydmljZSB9IGZyb20gJ0BhbGZyZXNjby9hZGYtY29yZSc7XG5pbXBvcnQgeyBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IFVwbG9hZEZpbGVzRXZlbnQgfSBmcm9tICcuLi91cGxvYWQtZmlsZXMuZXZlbnQnO1xuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgVXBsb2FkQmFzZSBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcblxuICAgIC8qKiBTZXRzIGEgbGltaXQgb24gdGhlIG1heGltdW0gc2l6ZSAoaW4gYnl0ZXMpIG9mIGEgZmlsZSB0byBiZSB1cGxvYWRlZC5cbiAgICAgKiBIYXMgbm8gZWZmZWN0IGlmIHVuZGVmaW5lZC5cbiAgICAgKi9cbiAgICBASW5wdXQoKVxuICAgIG1heEZpbGVzU2l6ZTogbnVtYmVyO1xuXG4gICAgLyoqIFRoZSBJRCBvZiB0aGUgcm9vdC4gVXNlIHRoZSBub2RlSWQgZm9yXG4gICAgICogQ29udGVudCBTZXJ2aWNlcyBvciB0aGUgdGFza0lkL3Byb2Nlc3NJZCBmb3IgUHJvY2VzcyBTZXJ2aWNlcy5cbiAgICAgKi9cbiAgICBASW5wdXQoKVxuICAgIHJvb3RGb2xkZXJJZDogc3RyaW5nID0gJy1yb290LSc7XG5cbiAgICAvKiogVG9nZ2xlcyBjb21wb25lbnQgZGlzYWJsZWQgc3RhdGUgKGlmIHRoZXJlIGlzIG5vIG5vZGUgcGVybWlzc2lvbiBjaGVja2luZykuICovXG4gICAgQElucHV0KClcbiAgICBkaXNhYmxlZDogYm9vbGVhbiA9IGZhbHNlO1xuXG4gICAgLyoqIEZpbHRlciBmb3IgYWNjZXB0ZWQgZmlsZSB0eXBlcy4gKi9cbiAgICBASW5wdXQoKVxuICAgIGFjY2VwdGVkRmlsZXNUeXBlOiBzdHJpbmcgPSAnKic7XG5cbiAgICAvKiogVG9nZ2xlcyB2ZXJzaW9uaW5nLiAqL1xuICAgIEBJbnB1dCgpXG4gICAgdmVyc2lvbmluZzogYm9vbGVhbiA9IGZhbHNlO1xuXG4gICAgLyoqIG1ham9yVmVyc2lvbiBib29sZWFuIGZpZWxkIHRvIHRydWUgdG8gaW5kaWNhdGUgYSBtYWpvciB2ZXJzaW9uIHNob3VsZCBiZSBjcmVhdGVkLiAqL1xuICAgIEBJbnB1dCgpXG4gICAgbWFqb3JWZXJzaW9uOiBib29sZWFuID0gZmFsc2U7XG5cbiAgICAvKiogV2hlbiB5b3Ugb3ZlcndyaXRlIGV4aXN0aW5nIGNvbnRlbnQsIHlvdSBjYW4gdXNlIHRoZSBjb21tZW50IGZpZWxkIHRvIGFkZCBhIHZlcnNpb24gY29tbWVudCB0aGF0IGFwcGVhcnMgaW4gdGhlIHZlcnNpb24gaGlzdG9yeSAqL1xuICAgIEBJbnB1dCgpXG4gICAgY29tbWVudDogc3RyaW5nO1xuXG4gICAgLyoqIEN1c3RvbSBub2RlIHR5cGUgZm9yIHVwbG9hZGVkIGZpbGUgKi9cbiAgICBASW5wdXQoKVxuICAgIG5vZGVUeXBlOiBzdHJpbmcgPSAnY206Y29udGVudCc7XG5cbiAgICAvKiogRW1pdHRlZCB3aGVuIHRoZSBmaWxlIGlzIHVwbG9hZGVkIHN1Y2Nlc3NmdWxseS4gKi9cbiAgICBAT3V0cHV0KClcbiAgICBzdWNjZXNzID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gICAgLyoqXG4gICAgICogRW1pdHRlZCB3aGVuIGEgZm9sZGVyIGlzIGNyZWF0ZWQuXG4gICAgICogQGRlcHJlY2F0ZWQgMi40LjAgTm8gbG9uZ2VyIHVzZWQgYnkgdGhlIGZyYW1ld29ya1xuICAgICAqL1xuICAgIEBPdXRwdXQoKVxuICAgIGNyZWF0ZUZvbGRlciA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICAgIC8qKiBFbWl0dGVkIHdoZW4gYW4gZXJyb3Igb2NjdXJzLiAqL1xuICAgIEBPdXRwdXQoKVxuICAgIGVycm9yID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gICAgLyoqIEVtaXR0ZWQgd2hlbiB0aGUgdXBsb2FkIGJlZ2lucy4gKi9cbiAgICBAT3V0cHV0KClcbiAgICBiZWdpblVwbG9hZCA9IG5ldyBFdmVudEVtaXR0ZXI8VXBsb2FkRmlsZXNFdmVudD4oKTtcblxuICAgIHByb3RlY3RlZCBzdWJzY3JpcHRpb25zOiBTdWJzY3JpcHRpb25bXSA9IFtdO1xuXG4gICAgY29uc3RydWN0b3IocHJvdGVjdGVkIHVwbG9hZFNlcnZpY2U6IFVwbG9hZFNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJvdGVjdGVkIHRyYW5zbGF0aW9uU2VydmljZTogVHJhbnNsYXRpb25TZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByb3RlY3RlZCBuZ1pvbmU6IE5nWm9uZSkge1xuICAgIH1cblxuICAgIG5nT25Jbml0KCkge1xuICAgICAgICB0aGlzLnN1YnNjcmlwdGlvbnMucHVzaChcbiAgICAgICAgICAgIHRoaXMudXBsb2FkU2VydmljZS5maWxlVXBsb2FkRXJyb3Iuc3Vic2NyaWJlKChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuZXJyb3IuZW1pdChlcnJvcik7XG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuXG4gICAgfVxuXG4gICAgbmdPbkRlc3Ryb3koKSB7XG4gICAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5mb3JFYWNoKHN1YnNjcmlwdGlvbiA9PiBzdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKSk7XG4gICAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucyA9IFtdO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwbG9hZCBhIGxpc3Qgb2YgZmlsZSBpbiB0aGUgc3BlY2lmaWVkIHBhdGhcbiAgICAgKiBAcGFyYW0gZmlsZXNcbiAgICAgKiBAcGFyYW0gcGF0aFxuICAgICAqL1xuICAgIHVwbG9hZEZpbGVzKGZpbGVzOiBGaWxlW10pOiB2b2lkIHtcbiAgICAgICAgY29uc3QgZmlsdGVyZWRGaWxlczogRmlsZU1vZGVsW10gPSBmaWxlc1xuICAgICAgICAgICAgLm1hcDxGaWxlTW9kZWw+KChmaWxlOiBGaWxlKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlRmlsZU1vZGVsKGZpbGUsIHRoaXMucm9vdEZvbGRlcklkLCAoZmlsZS53ZWJraXRSZWxhdGl2ZVBhdGggfHwgJycpLnJlcGxhY2UoL1xcL1teXFwvXSokLywgJycpKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMudXBsb2FkUXVldWUoZmlsdGVyZWRGaWxlcyk7XG4gICAgfVxuXG4gICAgdXBsb2FkRmlsZXNJbmZvKGZpbGVzOiBGaWxlSW5mb1tdKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGZpbHRlcmVkRmlsZXM6IEZpbGVNb2RlbFtdID0gZmlsZXNcbiAgICAgICAgICAgIC5tYXA8RmlsZU1vZGVsPigoZmlsZUluZm86IEZpbGVJbmZvKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlRmlsZU1vZGVsKGZpbGVJbmZvLmZpbGUsIHRoaXMucm9vdEZvbGRlcklkLCBmaWxlSW5mby5yZWxhdGl2ZUZvbGRlcik7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnVwbG9hZFF1ZXVlKGZpbHRlcmVkRmlsZXMpO1xuICAgIH1cblxuICAgIHByaXZhdGUgdXBsb2FkUXVldWUoZmlsZXM6IEZpbGVNb2RlbFtdKSB7XG4gICAgICAgIGxldCBmaWx0ZXJlZEZpbGVzID0gZmlsZXNcbiAgICAgICAgICAgIC5maWx0ZXIodGhpcy5pc0ZpbGVBY2NlcHRhYmxlLmJpbmQodGhpcykpXG4gICAgICAgICAgICAuZmlsdGVyKHRoaXMuaXNGaWxlU2l6ZUFjY2VwdGFibGUuYmluZCh0aGlzKSk7XG5cbiAgICAgICAgdGhpcy5uZ1pvbmUucnVuKCgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGV2ZW50ID0gbmV3IFVwbG9hZEZpbGVzRXZlbnQoXG4gICAgICAgICAgICAgICAgWy4uLmZpbHRlcmVkRmlsZXNdLFxuICAgICAgICAgICAgICAgIHRoaXMudXBsb2FkU2VydmljZSxcbiAgICAgICAgICAgICAgICB0aGlzLnN1Y2Nlc3NcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICB0aGlzLmJlZ2luVXBsb2FkLmVtaXQoZXZlbnQpO1xuXG4gICAgICAgICAgICBpZiAoIWV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQpIHtcbiAgICAgICAgICAgICAgICBpZiAoZmlsdGVyZWRGaWxlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudXBsb2FkU2VydmljZS5hZGRUb1F1ZXVlKC4uLmZpbHRlcmVkRmlsZXMpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnVwbG9hZFNlcnZpY2UudXBsb2FkRmlsZXNJblRoZVF1ZXVlKHRoaXMuc3VjY2Vzcyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVja3MgaWYgdGhlIGdpdmVuIGZpbGUgaXMgYWxsb3dlZCBieSB0aGUgZXh0ZW5zaW9uIGZpbHRlcnNcbiAgICAgKlxuICAgICAqIEBwYXJhbSBmaWxlIEZpbGVNb2RlbFxuICAgICAqL1xuICAgIHByb3RlY3RlZCBpc0ZpbGVBY2NlcHRhYmxlKGZpbGU6IEZpbGVNb2RlbCk6IGJvb2xlYW4ge1xuICAgICAgICBpZiAodGhpcy5hY2NlcHRlZEZpbGVzVHlwZSA9PT0gJyonKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGFsbG93ZWRFeHRlbnNpb25zID0gdGhpcy5hY2NlcHRlZEZpbGVzVHlwZVxuICAgICAgICAgICAgLnNwbGl0KCcsJylcbiAgICAgICAgICAgIC5tYXAoZXh0ID0+IGV4dC5yZXBsYWNlKC9eXFwuLywgJycpKTtcblxuICAgICAgICBpZiAoYWxsb3dlZEV4dGVuc2lvbnMuaW5kZXhPZihmaWxlLmV4dGVuc2lvbikgIT09IC0xKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGVzIEZpbGVNb2RlbCBmcm9tIEZpbGVcbiAgICAgKlxuICAgICAqIEBwYXJhbSBmaWxlXG4gICAgICovXG4gICAgcHJvdGVjdGVkIGNyZWF0ZUZpbGVNb2RlbChmaWxlOiBGaWxlLCBwYXJlbnRJZDogc3RyaW5nLCBwYXRoOiBzdHJpbmcsIGlkPzogc3RyaW5nKTogRmlsZU1vZGVsIHtcbiAgICAgICAgcmV0dXJuIG5ldyBGaWxlTW9kZWwoZmlsZSwge1xuICAgICAgICAgICAgY29tbWVudDogdGhpcy5jb21tZW50LFxuICAgICAgICAgICAgbWFqb3JWZXJzaW9uOiB0aGlzLm1ham9yVmVyc2lvbixcbiAgICAgICAgICAgIG5ld1ZlcnNpb246IHRoaXMudmVyc2lvbmluZyxcbiAgICAgICAgICAgIHBhcmVudElkOiBwYXJlbnRJZCxcbiAgICAgICAgICAgIHBhdGg6IHBhdGgsXG4gICAgICAgICAgICBub2RlVHlwZTogdGhpcy5ub2RlVHlwZVxuICAgICAgICB9LCBpZCk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGlzRmlsZVNpemVBbGxvd2VkKGZpbGU6IEZpbGVNb2RlbCkge1xuICAgICAgICBsZXQgaXNGaWxlU2l6ZUFsbG93ZWQgPSB0cnVlO1xuICAgICAgICBpZiAodGhpcy5pc01heEZpbGVTaXplRGVmaW5lZCgpKSB7XG4gICAgICAgICAgICBpc0ZpbGVTaXplQWxsb3dlZCA9IHRoaXMuaXNGaWxlU2l6ZUNvcnJlY3QoZmlsZSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gaXNGaWxlU2l6ZUFsbG93ZWQ7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGlzTWF4RmlsZVNpemVEZWZpbmVkKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5tYXhGaWxlc1NpemUgIT09IHVuZGVmaW5lZCAmJiB0aGlzLm1heEZpbGVzU2l6ZSAhPT0gbnVsbDtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgaXNGaWxlU2l6ZUNvcnJlY3QoZmlsZTogRmlsZU1vZGVsKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm1heEZpbGVzU2l6ZSA+PSAwICYmIGZpbGUuc2l6ZSA8PSB0aGlzLm1heEZpbGVzU2l6ZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVja3MgaWYgdGhlIGdpdmVuIGZpbGUgaXMgYW4gYWNjZXB0YWJsZSBzaXplXG4gICAgICpcbiAgICAgKiBAcGFyYW0gZmlsZSBGaWxlTW9kZWxcbiAgICAgKi9cbiAgICBwcml2YXRlIGlzRmlsZVNpemVBY2NlcHRhYmxlKGZpbGU6IEZpbGVNb2RlbCk6IGJvb2xlYW4ge1xuICAgICAgICBsZXQgYWNjZXB0YWJsZVNpemUgPSB0cnVlO1xuXG4gICAgICAgIGlmICghdGhpcy5pc0ZpbGVTaXplQWxsb3dlZChmaWxlKSkge1xuICAgICAgICAgICAgYWNjZXB0YWJsZVNpemUgPSBmYWxzZTtcblxuICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IHRoaXMudHJhbnNsYXRpb25TZXJ2aWNlLmluc3RhbnQoXG4gICAgICAgICAgICAgICAgJ0ZJTEVfVVBMT0FELk1FU1NBR0VTLkVYQ0VFRF9NQVhfRklMRV9TSVpFJyxcbiAgICAgICAgICAgICAgICB7IGZpbGVOYW1lOiBmaWxlLm5hbWUgfVxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgdGhpcy5lcnJvci5lbWl0KG1lc3NhZ2UpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGFjY2VwdGFibGVTaXplO1xuICAgIH1cblxufVxuIl19